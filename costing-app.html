<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synercore - Costing Platform (Auto-Deploy)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        }
        
        .sidebar-link { 
            transition: all 0.2s ease;
            position: relative;
        }
        .sidebar-link:hover { 
            background-color: rgba(59, 130, 246, 0.1);
            transform: translateX(4px);
        }
        .sidebar-link.active { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .page { display: none; }
        .page.active { display: block; }
        
        /* Enhanced Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            border: 1px solid var(--gray-200);
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        
        /* Enhanced Buttons */
        .btn {
            transition: all 0.2s ease;
            font-weight: 600;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1e40af 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, #047857 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--success-color);
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.error {
            border-left-color: var(--error-color);
        }
        .toast.warning {
            border-left-color: var(--warning-color);
        }
        
        /* Enhanced Form Elements */
        .form-input {
            transition: all 0.2s ease;
            border-radius: 8px;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: scale(1.01);
        }
        
        /* Section Headers with Icons */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-200);
        }
        
        /* Progress Indicators */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: width 0.3s ease;
        }
        
        /* Enhanced Header */
        .app-header {
            background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
            border-bottom: 1px solid var(--gray-200);
        }
        
        /* Quote Cards */
        .quote-card {
            background: linear-gradient(135deg, #f8fafc 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .quote-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        /* Pending Request Cards */
        .request-card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Mobile Layout */
            .flex.h-screen {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            /* Mobile Sidebar */
            aside {
                width: 100% !important;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease;
            }
            aside.mobile-open {
                left: 0;
            }
            
            /* Mobile Overlay */
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                display: none;
            }
            .mobile-overlay.show {
                display: block;
            }
            
            /* Mobile Header */
            .app-header {
                position: relative;
                z-index: 40;
            }
            .app-header .flex {
                padding: 12px 16px;
            }
            #page-title {
                font-size: 1.25rem;
            }
            
            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--gray-800);
                cursor: pointer;
            }
            
            /* Mobile Main Content */
            .flex-1.flex.flex-col.overflow-hidden {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: visible !important;
            }
            
            main {
                padding: 16px !important;
                margin-top: 0;
                flex: 1 !important;
                overflow: visible !important;
                height: auto !important;
                min-height: calc(100vh - 80px) !important;
            }
            
            /* Ensure pages are visible */
            .page {
                display: none;
                width: 100%;
                height: auto;
                min-height: 300px;
            }
            .page.active {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Force dashboard to be visible on initial load */
            #dashboard-page {
                display: block;
            }
            #dashboard-page.active {
                display: block !important;
            }
            
            /* Mobile Grid Layouts */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Mobile Dashboard Fix */
            #saved-quotes-list, #cost-requests-list {
                min-height: 100px !important;
                background: white !important;
                padding: 16px !important;
                border-radius: 8px !important;
                margin-bottom: 16px !important;
            }
            
            #saved-quotes-list:empty::before {
                content: "No saved quotes yet. Create your first quote in the Cost Generator!";
                color: #6b7280;
                font-style: italic;
            }
            
            #cost-requests-list:empty::before {
                content: "No pending requests. Submit a request to get started!";
                color: #6b7280;
                font-style: italic;
            }
            
            /* Mobile Cards */
            .card, .quote-card, .request-card, .template-card {
                margin-bottom: 16px;
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            
            .template-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }
            
            /* Mobile Form Elements */
            .form-input, select, textarea, input {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 12px !important;
            }
            
            /* Mobile Buttons */
            .btn {
                padding: 12px 16px !important;
                font-size: 14px;
                min-height: 44px; /* Touch target size */
            }
            
            /* Mobile Quote/Request Cards */
            .quote-card, .request-card {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px;
            }
            .quote-card .flex-1, .request-card .flex-1 {
                margin-bottom: 12px;
            }
            .quote-card .flex.items-center, .request-card .flex.items-center {
                justify-content: stretch;
                gap: 8px;
            }
            .quote-card .btn, .request-card .btn {
                flex: 1;
                justify-content: center;
            }
            
            /* Mobile Typography */
            h1, h2, h3 {
                font-size: 1.1rem !important;
                line-height: 1.4;
            }
            
            /* Mobile Spacing */
            .space-y-6 > * + * {
                margin-top: 16px !important;
            }
            .space-y-4 > * + * {
                margin-top: 12px !important;
            }
            .space-y-2 > * + * {
                margin-top: 8px !important;
            }
            
            /* Mobile Toast Notifications */
            .toast {
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-100px);
            }
            .toast.show {
                transform: translateY(0);
            }
            
            /* Mobile Cost Generator Layout */
            .lg\\:col-span-2 {
                grid-column: span 1 !important;
            }
            .lg\\:col-span-1 {
                grid-column: span 1 !important;
            }
            
            /* Mobile Sticky Elements */
            .sticky {
                position: relative !important;
                top: auto !important;
            }
            
            /* Mobile Hidden Elements */
            .md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Tablet Styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            aside {
                width: 200px;
            }
            main {
                padding: 24px;
            }
            .grid {
                gap: 20px;
            }
        }
        
        /* Desktop Hidden Mobile Menu */
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-200">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="flex items-center justify-center gap-x-3 p-4 border-b border-gray-700">
                <img src="synercore-logo.png" alt="Synercore Logo" class="h-10 w-10 object-contain">
                <span class="text-xl font-bold">Synercore</span>
            </div>
            <nav id="sidebar-nav" class="flex-1 px-2 py-4 space-y-2">
                <a href="#dashboard" data-page="dashboard-page" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                    <span class="text-lg">üìä</span> Dashboard
                </a>
                <a href="#generator" data-page="cost-generator-page" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                    <span class="text-lg">üí∞</span> Cost Generator
                </a>
                <a href="#request" data-page="cost-request-page" class="sidebar-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700">
                    <span class="text-lg">üìù</span> Cost Request
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="app-header shadow-md">
                 <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center gap-x-3">
                        <button class="mobile-menu-btn" style="display: none;" onclick="toggleMobileMenu()">‚ò∞</button>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-800">üìä Dashboard</h1>
                    </div>
                    <div id="header-buttons" class="flex items-center gap-x-2">
                        <!-- Buttons will be dynamically added here -->
                    </div>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page">
                    <!-- Quick Start Templates Section -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">
                                üöÄ Quick Start Templates
                            </h2>
                            <button 
                                onclick="App.showAllTemplates()" 
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                            >
                                View All Templates ‚Üí
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="template-grid">
                            <!-- Templates will be populated here -->
                        </div>
                    </div>

                    <!-- Enhanced Search Section -->
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">üìã Quote Management</h3>
                            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                                <input 
                                    type="text" 
                                    id="quote-search" 
                                    placeholder="Search quotes by supplier, route, or commodity..." 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-80"
                                    oninput="App.filterQuotes(this.value)"
                                >
                                <select 
                                    id="quote-filter" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    onchange="App.filterQuotes()"
                                >
                                    <option value="">All Quotes</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="high-value">High Value (>R100k)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-3">Saved Quotes</h3>
                                <span id="quotes-count" class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded-full">0</span>
                            </div>
                            <div id="saved-quotes-list" class="space-y-3"></div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-3">Pending Requests</h3>
                                <span id="requests-count" class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded-full">0</span>
                            </div>
                            <div id="cost-requests-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Cost Generator Page -->
                <div id="cost-generator-page" class="page">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div id="shipment-details" class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Shipment Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">üö¢ Origin Charges</h3><div id="origin-charges-section" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Exchange Rates (to ZAR)</h3><div id="exchange-rates" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
                            <div id="cost-sections"></div>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm sticky top-6"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Costing Summary</h3><div id="summary-output" class="space-y-2 text-sm"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm" style="position:sticky; top: 24rem;"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Landed Cost Calculator</h3><div id="landed-cost-inputs" class="grid grid-cols-1 gap-4 mb-4"></div><div id="landed-cost-output" class="space-y-2 text-sm"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm" style="position:sticky; top: 48rem;"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">üí∞ Pricing Strategy</h3><div id="pricing-strategy-inputs" class="grid grid-cols-1 gap-4 mb-4"></div><div id="pricing-strategy-output" class="space-y-2 text-sm"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Cost Request Page -->
                <div id="cost-request-page" class="page">
                    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-6">Submit a Costing Request</h2>
                        <form id="cost-request-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Your Name</label><input type="text" id="req-name" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Your Email</label><input type="email" id="req-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">Supplier Name</label><select id="req-client" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Supplier</option><option value="Qida Chemical Co. Ltd">Qida Chemical Co. Ltd</option><option value="AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.">AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.</option><option value="SACCO S.R.L">SACCO S.R.L</option><option value="Futura Ingredients">Futura Ingredients</option><option value="MARCEL CARRAGEENAN">MARCEL CARRAGEENAN</option><option value="AB Mauri">AB Mauri</option><option value="KMC">KMC</option><option value="Ornua Co-operative Limeted">Ornua Co-operative Limeted</option><option value="Halavet Gida Sanayi Ve Ticaret A.S">Halavet Gida Sanayi Ve Ticaret A.S</option><option value="Delta Iris">Delta Iris</option><option value="Tristar Global">Tristar Global</option></select></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Origin</label><input type="text" id="req-origin" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Destination</label><input type="text" id="req-destination" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Total Weight (kg)</label><input type="number" step="0.01" id="req-weight" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Incoterms</label><select id="req-incoterm" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Incoterm</option><option value="EXW">EXW</option><option value="FOB">FOB</option><option value="CFR">CFR</option><option value="CIF">CIF</option><option value="DAP">DAP</option><option value="DDP">DDP</option></select></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Total Cost</label><input type="number" step="0.01" id="req-cost" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Currency</label><select id="req-currency" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Currency</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="ZAR">ZAR</option></select></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">Commodity Description</label><textarea id="req-commodity" rows="3" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div><label class="block text-sm font-medium text-gray-700">Additional Notes or Special Instructions</label><textarea id="req-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div class="text-right"><button type="submit" class="btn btn-primary text-white font-bold py-3 px-6 rounded-lg">üì§ Submit Request</button></div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyCYCinps1BCJVJuT3ZSZHXYRQ6RjCmoQWk",
            authDomain: "costing-app-4b351.firebaseapp.com",
            projectId: "costing-app-4b351",
            storageBucket: "costing-app-4b351.firebasestorage.app",
            messagingSenderId: "868255106195",
            appId: "1:868255106195:web:022741badc310dd4f43966"
        });
        const __app_id = "costing-app-4b351";
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        const state = { 
            shipmentDetails: { 
                supplierName: { label: 'Supplier Name', value: 'Qida Chemical Co. Ltd', type: 'select', options: ['Qida Chemical Co. Ltd', 'AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.', 'SACCO S.R.L', 'Futura Ingredients', 'MARCEL CARRAGEENAN', 'AB Mauri', 'KMC', 'Ornua Co-operative Limeted', 'Halavet Gida Sanayi Ve Ticaret A.S', 'Delta Iris', 'Tristar Global'] },
                pol: { label: 'Port of Loading (POL)', value: 'Shanghai', type: 'select', options: ['Shanghai', 'Ningbo', 'Qingdao', 'Singapore', 'Rotterdam', 'Hamburg', 'Los Angeles', 'Durban', 'Cape Town', 'Gqeberha', 'Jakarta', 'Port Klang', 'Istanbul', 'Istanbul,Ambarlƒ±', 'Nhava Sheva', 'Dublin', 'Auckland'] }, 
                pod: { label: 'Port of Discharge (POD)', value: 'Durban', type: 'select', options: ['Durban', 'Cape Town', 'Gqeberha', 'Shanghai', 'Ningbo', 'Qingdao', 'Singapore', 'Rotterdam', 'Hamburg', 'Los Angeles', 'Jakarta', 'Port Klang', 'Istanbul', 'Istanbul,Ambarlƒ±', 'Nhava Sheva', 'Dublin', 'Auckland'] }, 
                shippingLine: { label: 'Shipping Line', value: 'Maersk', type: 'select', options: ['Maersk', 'MSC', 'CMA CGM', 'COSCO', 'Hapag-Lloyd', 'PIL', 'ONE', 'MAERSK'] }, 
                containerSize: { label: 'Container Size', value: "40' HC", type: 'select', options: ["20' GP", "40' GP", "40' HC", "20' OT", "40' OT", "20' FR", "40' FR"] }, 
                commodity: { label: 'Commodity', value: 'General Goods', type: 'text' }, 
                incoterm: { label: 'Incoterm', value: 'FOB', type: 'select', options: ['EXW', 'FOB', 'CFR', 'CIF', 'DAP', 'DDP'] } 
            }, 
            exchangeRates: { 
                usd: { label: 'USD to ZAR', value: '18.50' }, 
                eur: { label: 'EUR to ZAR', value: '20.20' }, 
                gbp: { label: 'GBP to ZAR', value: '23.50' } 
            },
            currencyAmounts: {
                usdAmount: { label: 'USD Amount', value: '1000', type: 'number' },
                eurAmount: { label: 'EUR Amount', value: '1000', type: 'number' },
                gbpAmount: { label: 'GBP Amount', value: '1000', type: 'number' }
            },
            originCharges: { 
                title: 'Origin charges', 
                currencyOptions: ['USD', 'EUR'], 
                items: { 
                    ratePerKg: { label: 'Rate per Kg', value: '12.50', currency: 'usd' },
                    totalKg: { label: 'Total Kg', value: '1000', currency: 'kg' }
                } 
            },
            costs: { 
                freight: { title: 'Freight costs', currencyOptions: ['USD', 'EUR', 'GBP'], items: { seaFreight: { label: 'Sea Freight', value: '2500', currency: 'usd' }, peakSeasonSurcharge: { label: 'Peak Season Surcharge', value: '0', currency: 'usd' }, bunkerSurcharge: { label: 'Bunker Surcharge', value: '300', currency: 'usd' }, adminFee: { label: 'Admin Fee', value: '50', currency: 'usd' } } }, 
                destinationCharges: { title: 'Destination charges', currencyOptions: ['ZAR'], items: { shippingLineCharges: { label: 'Shipping line charges', value: '0', currency: 'zar' }, cargoDues20ft: { label: 'Cargo dues 20ft', value: '0', currency: 'zar' }, cargoDues40ft: { label: 'Cargo dues 40ft', value: '0', currency: 'zar' }, ctoFee: { label: 'CTO fee', value: '0', currency: 'zar' } } }, 
                clearing: { title: 'Forwarding & clearing', currencyOptions: ['ZAR'], items: { agencyFee: { label: 'Agency Fee', value: '1850', currency: 'zar' }, customsClearance: { label: 'Customs Clearance', value: '950', currency: 'zar' }, documentation: { label: 'Documentation', value: '450', currency: 'zar' }, portHealthInspection: { label: 'Port health inspection', value: '0', currency: 'zar' }, daffInspection: { label: 'DAFF inspection', value: '0', currency: 'zar' }, stateVetCancellation: { label: 'State vet cancellation fee', value: '0', currency: 'zar' }, nbTurnIn: { label: 'NB turn in', value: '0', currency: 'zar' }, vesselAc: { label: 'Vessel A&C', value: '0', currency: 'zar' } } },
                transport: { title: 'Transport and warehousing', currencyOptions: ['ZAR'], items: { localCartageCptUnder20: { label: 'Local cartage: CPT to Klapmuts < 20 ton', value: '0', currency: 'zar' }, localCartageCpt21_28: { label: 'Local cartage: CPT to Klapmuts 21-28 ton', value: '0', currency: 'zar' }, transportDbnPta20ft: { label: 'Transport: DBN port to Pretoria - 20ft < 20 tons, direct', value: '0', currency: 'zar' }, transportDbnWhs: { label: 'Transport: DBN port to WHS', value: '0', currency: 'zar' }, unpackReload: { label: 'Unpack / Reload', value: '0', currency: 'zar' }, storage: { label: 'Storage (3 days free)', value: '0', currency: 'zar' }, outlyingSurcharge: { label: 'Outlying container depot surcharge', value: '0', currency: 'zar' }, localCartageDbnPtaA: { label: 'Local cartage: DBN WHS to Pretoria - Option A', value: '0', currency: 'zar' }, localCartageDbnPtaB: { label: 'Local cartage: DBN WHS to Pretoria - Option B', value: '0', currency: 'zar' }, localCartageDbn6m: { label: 'Local cartage: DBN WHS to Pretoria - 6m deckspace', value: '0', currency: 'zar' }, localCartageDbn12m: { label: 'Local cartage: DBN WHS to Pretoria - 12m deckspace', value: '0', currency: 'zar' }, transportPePta: { label: 'Transport: PE/Coega port to Pretoria', value: '0', currency: 'zar' } } } 
            }, 
            landedCost: { commercialInvoiceValue: { label: 'Commercial Invoice Value (USD)', value: '15000' }, dutyRate: { label: 'Rate of Duty (%)', value: '5' }, totalKg: { label: 'Total Kg', value: '1000' } },
            pricingStrategy: {
                unitQuantity: { label: 'Unit Quantity', value: '100', type: 'number' },
                pricingMethod: { label: 'Pricing Method', value: 'margin', options: ['margin', 'markup', 'manual'] },
                marginPercent: { label: 'Desired Margin (%)', value: '25', type: 'number' },
                markupPercent: { label: 'Markup (%)', value: '35', type: 'number' },
                manualSellPrice: { label: 'Sell Price per Unit (ZAR)', value: '0', type: 'number' },
                targetCurrency: { label: 'Pricing Currency', value: 'zar', options: ['zar', 'usd', 'eur'] }
            }
        };
        const VAT_RATE = 0.15;

        // --- QUOTE TEMPLATES SYSTEM ---
        const QuoteTemplates = {
            templates: {
                'asia-to-dbn': {
                    name: 'Asia to Durban (Standard)',
                    description: 'Common route from Asian ports to Durban',
                    icon: 'üö¢',
                    data: {
                        shipmentDetails: {
                            pol: 'Shanghai, China',
                            pod: 'Durban, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'General Cargo',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '8.50',
                            totalKg: '2000'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2800',
                                bunkerSurcharge: '400',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1200',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '7.5'
                        }
                    }
                },
                'europe-to-cpt': {
                    name: 'Europe to Cape Town',
                    description: 'Standard European imports via Cape Town',
                    icon: 'üá™üá∫',
                    data: {
                        shipmentDetails: {
                            pol: 'Hamburg, Germany',
                            pod: 'Cape Town, South Africa',
                            containerSize: '20ft',
                            commodity: 'Machinery',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '12.00',
                            totalKg: '1500'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2200',
                                bunkerSurcharge: '300',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '900',
                                cargoDues20ft: '650'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '5.0'
                        }
                    }
                },
                'uk-machinery': {
                    name: 'UK Machinery Import',
                    description: 'Heavy machinery from UK with typical duty rates',
                    icon: 'üè≠',
                    data: {
                        shipmentDetails: {
                            pol: 'Southampton, UK',
                            pod: 'Durban, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'Industrial Machinery',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '15.50',
                            totalKg: '3000'
                        },
                        costs: {
                            freight: {
                                seaFreight: '3200',
                                bunkerSurcharge: '450',
                                adminFee: '75'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1400',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '2100',
                                customsClearance: '1200',
                                documentation: '600',
                                daffInspection: '850'
                            },
                            transport: {
                                transportDbnPta20ft: '4500'
                            }
                        },
                        landedCost: {
                            dutyRate: '0.0'
                        }
                    }
                },
                'china-textiles': {
                    name: 'China Textiles',
                    description: 'Textile imports from China with typical rates',
                    icon: 'üßµ',
                    data: {
                        shipmentDetails: {
                            pol: 'Ningbo, China',
                            pod: 'Cape Town, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'Textiles & Clothing',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '6.80',
                            totalKg: '1800'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2600',
                                bunkerSurcharge: '380',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1100',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '45.0'
                        }
                    }
                },
                'india-chemicals': {
                    name: 'India Chemicals',
                    description: 'Chemical products from India',
                    icon: '‚öóÔ∏è',
                    data: {
                        shipmentDetails: {
                            pol: 'Mumbai, India',
                            pod: 'Durban, South Africa',
                            containerSize: '20ft',
                            commodity: 'Chemical Products',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '11.20',
                            totalKg: '1200'
                        },
                        costs: {
                            freight: {
                                seaFreight: '1800',
                                bunkerSurcharge: '250',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '800',
                                cargoDues20ft: '650'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450',
                                portHealthInspection: '750'
                            }
                        },
                        landedCost: {
                            dutyRate: '10.0'
                        }
                    }
                }
            },

            getTemplate(templateId) {
                return this.templates[templateId] || null;
            },

            getAllTemplates() {
                return Object.entries(this.templates).map(([id, template]) => ({
                    id,
                    ...template
                }));
            },

            applyTemplate(templateId) {
                const template = this.getTemplate(templateId);
                if (!template) return false;

                // Apply template data to state
                const templateData = template.data;
                
                // Update shipment details
                Object.keys(templateData.shipmentDetails).forEach(key => {
                    if (state.shipmentDetails[key] && templateData.shipmentDetails[key]) {
                        state.shipmentDetails[key].value = templateData.shipmentDetails[key];
                    }
                });

                // Update origin charges
                if (templateData.originCharges) {
                    Object.keys(templateData.originCharges).forEach(key => {
                        if (state.originCharges.items[key]) {
                            state.originCharges.items[key].value = templateData.originCharges[key];
                        }
                    });
                }

                // Update cost sections
                if (templateData.costs) {
                    Object.keys(templateData.costs).forEach(sectionKey => {
                        if (state.costs[sectionKey]) {
                            Object.keys(templateData.costs[sectionKey]).forEach(itemKey => {
                                if (state.costs[sectionKey].items[itemKey]) {
                                    state.costs[sectionKey].items[itemKey].value = templateData.costs[sectionKey][itemKey];
                                }
                            });
                        }
                    });
                }

                // Update landed cost
                if (templateData.landedCost) {
                    Object.keys(templateData.landedCost).forEach(key => {
                        if (state.landedCost[key]) {
                            state.landedCost[key].value = templateData.landedCost[key];
                        }
                    });
                }

                return true;
            }
        };

        // --- EXCHANGE RATE SERVICE ---
        class ExchangeRateService {
            constructor() {
                this.apis = [
                    {
                        name: 'ExchangeRate-API',
                        url: 'https://api.exchangerate-api.com/v4/latest',
                        parseResponse: (data, toCurrency) => data.rates?.[toCurrency.toUpperCase()]
                    },
                    {
                        name: 'Fixer-Backup', 
                        url: 'https://api.fixer.io/latest',
                        parseResponse: (data, toCurrency) => data.rates?.[toCurrency.toUpperCase()]
                    }
                ];
                this.cacheKey = 'exchange_rates_cache';
                this.timestampKey = 'exchange_rates_timestamp';
                this.cacheValidityHours = 24;
                this.spotMultiplier = 2; // spot x 2
            }

            async fetchRate(fromCurrency, toCurrency) {
                // Try each API in order until one works
                for (const api of this.apis) {
                    try {
                        console.log(`Trying ${api.name} for ${fromCurrency}/${toCurrency}`);
                        const url = `${api.url}/${fromCurrency.toUpperCase()}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            console.warn(`${api.name} returned ${response.status}`);
                            continue;
                        }
                        
                        const data = await response.json();
                        const rate = api.parseResponse(data, toCurrency);
                        
                        if (!rate || isNaN(rate)) {
                            console.warn(`${api.name} - Rate not found or invalid:`, rate);
                            continue;
                        }
                        
                        const finalRate = parseFloat(rate) * this.spotMultiplier;
                        console.log(`${api.name} - ${fromCurrency}/${toCurrency}: ${rate} -> ${finalRate} (spot x 2)`);
                        return finalRate;
                        
                    } catch (error) {
                        console.warn(`${api.name} failed:`, error.message);
                        continue;
                    }
                }
                
                console.error(`All APIs failed for ${fromCurrency}/${toCurrency}`);
                return null;
            }

            async fetchAllRates() {
                try {
                    showToast('Fetching live exchange rates...', 'info');
                    console.log('Starting exchange rate fetch...');
                    
                    // Fetch rates sequentially to better handle errors
                    const usdRate = await this.fetchRate('USD', 'ZAR');
                    const eurRate = await this.fetchRate('EUR', 'ZAR'); 
                    const gbpRate = await this.fetchRate('GBP', 'ZAR');

                    console.log('Fetched rates:', { usdRate, eurRate, gbpRate });

                    // Check if we got at least some rates
                    const successfulRates = [usdRate, eurRate, gbpRate].filter(rate => rate !== null);
                    
                    if (successfulRates.length === 0) {
                        throw new Error('All exchange rate APIs failed');
                    }

                    // Use fetched rates or fallback to cached/default for failed ones
                    const cachedRates = this.getCachedRates();
                    const rates = {
                        usd: { 
                            label: 'USD to ZAR', 
                            value: usdRate ? usdRate.toFixed(2) : cachedRates.usd.value 
                        },
                        eur: { 
                            label: 'EUR to ZAR', 
                            value: eurRate ? eurRate.toFixed(2) : cachedRates.eur.value 
                        },
                        gbp: { 
                            label: 'GBP to ZAR', 
                            value: gbpRate ? gbpRate.toFixed(2) : cachedRates.gbp.value 
                        }
                    };

                    // Cache the rates and timestamp
                    localStorage.setItem(this.cacheKey, JSON.stringify(rates));
                    localStorage.setItem(this.timestampKey, Date.now().toString());

                    const successCount = successfulRates.length;
                    if (successCount === 3) {
                        showToast('Exchange rates updated successfully! (Spot √ó 2)', 'success');
                    } else {
                        showToast(`Partial update: ${successCount}/3 rates fetched (Spot √ó 2)`, 'warning');
                    }
                    
                    console.log('Final rates:', rates);
                    return rates;
                    
                } catch (error) {
                    console.error('Failed to fetch exchange rates:', error);
                    showToast('API connection failed - using cached/default rates', 'error');
                    return this.getCachedRates();
                }
            }

            getCachedRates() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (cached) {
                        const parsedRates = JSON.parse(cached);
                        
                        // Validate cache structure
                        if (parsedRates.usd?.value && parsedRates.eur?.value && parsedRates.gbp?.value) {
                            console.log('Using valid cached rates:', parsedRates);
                            return parsedRates;
                        } else {
                            console.warn('Cached rates structure is invalid:', parsedRates);
                            localStorage.removeItem(this.cacheKey);
                        }
                    }
                } catch (error) {
                    console.warn('Failed to parse cached rates:', error);
                    localStorage.removeItem(this.cacheKey);
                }
                
                // Fallback to default rates (current hardcoded values)
                console.log('Using fallback default rates');
                return {
                    usd: { label: 'USD to ZAR', value: '18.50' },
                    eur: { label: 'EUR to ZAR', value: '20.20' }, 
                    gbp: { label: 'GBP to ZAR', value: '23.50' }
                };
            }

            isCacheExpired() {
                const timestamp = localStorage.getItem(this.timestampKey);
                if (!timestamp) return true;

                const cacheTime = parseInt(timestamp);
                const now = Date.now();
                const hoursSinceCache = (now - cacheTime) / (1000 * 60 * 60);

                return hoursSinceCache >= this.cacheValidityHours;
            }

            getLastUpdateTime() {
                const timestamp = localStorage.getItem(this.timestampKey);
                if (!timestamp) return 'Never';

                const date = new Date(parseInt(timestamp));
                return date.toLocaleString('en-ZA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            async initializeRates() {
                if (this.isCacheExpired()) {
                    return await this.fetchAllRates();
                } else {
                    const cached = this.getCachedRates();
                    showToast(`Using cached rates (Last updated: ${this.getLastUpdateTime()})`, 'info');
                    return cached;
                }
            }
        }

        // Initialize Exchange Rate Service
        const exchangeRateService = new ExchangeRateService();

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value, currency = 'ZAR') => new Intl.NumberFormat('en-ZA', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseFloat(value) || 0);

        // --- NOTIFICATION SYSTEM ---
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-lg">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}
                    </span>
                    <div>
                        <p class="font-semibold text-gray-800">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        };

        // --- MOBILE MENU FUNCTIONALITY ---
        const toggleMobileMenu = () => {
            const sidebar = document.querySelector('aside');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
            
            // Prevent body scroll when menu is open
            if (sidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        };

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('aside');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('mobile-open') && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // Close mobile menu when selecting a navigation item
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        const sidebar = document.querySelector('aside');
                        const overlay = document.querySelector('.mobile-overlay');
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';
                    }
                });
            });
        });

        // --- AUTO-CALCULATION FUNCTION ---
        function updateCommercialValue() {
            console.log('üîÑ updateCommercialValue called');
            const ratePerKgEl = document.getElementById('origin-ratePerKg-value');
            const totalKgEl = document.getElementById('origin-totalKg-value');
            const ratePerKgCurrencyEl = document.getElementById('origin-ratePerKg-currency');
            const commercialValueEl = document.getElementById('lc-commercialInvoiceValue');
            const landedTotalKgEl = document.getElementById('lc-totalKg');
            
            console.log('Elements found:', {
                ratePerKg: !!ratePerKgEl,
                totalKg: !!totalKgEl,
                commercialValue: !!commercialValueEl,
                landedTotalKg: !!landedTotalKgEl
            });
            
            if (ratePerKgEl && totalKgEl && commercialValueEl) {
                const ratePerKg = ratePerKgEl.value;
                const totalKg = totalKgEl.value;
                const currency = ratePerKgCurrencyEl ? ratePerKgCurrencyEl.value : 'usd';
                
                // Validate Origin Charges inputs
                const validation = ValidationUtil.validateOriginCharges(ratePerKg, totalKg);
                
                if (!validation.isValid) {
                    // Show validation errors with visual feedback
                    if (parseFloat(ratePerKg) <= 0 || isNaN(parseFloat(ratePerKg))) {
                        ValidationUtil.showValidationError('Rate per Kg must be a positive number', ratePerKgEl);
                    }
                    if (parseFloat(totalKg) <= 0 || isNaN(parseFloat(totalKg))) {
                        ValidationUtil.showValidationError('Total Kg must be a positive number', totalKgEl);
                    }
                    console.log('‚ùå Validation failed:', validation.message);
                    return false;
                }

                // Show container capacity warnings
                if (validation.warnings && validation.warnings.length > 0) {
                    validation.warnings.forEach(warning => {
                        showToast(warning, 'warning');
                    });
                }

                // Additional container size validation
                const containerSizeEl = document.getElementById('sd-containerSize');
                if (containerSizeEl && totalKg) {
                    const containerValidation = ValidationUtil.validateContainerCapacity(totalKg, containerSizeEl.value);
                    if (containerValidation.errors.length > 0) {
                        containerValidation.errors.forEach(error => {
                            showToast(error, 'error');
                        });
                    }
                    if (containerValidation.warnings.length > 0) {
                        containerValidation.warnings.forEach(warning => {
                            showToast(warning, 'warning');
                        });
                    }
                }
                
                // Clear any previous validation errors
                ValidationUtil.clearValidationError(ratePerKgEl);
                ValidationUtil.clearValidationError(totalKgEl);
                
                // Calculate total value
                const totalValue = parseFloat(ratePerKg) * parseFloat(totalKg);
                
                console.log(`üí∞ Calculation: ${ratePerKg} √ó ${totalKg} = ${totalValue} ${currency.toUpperCase()}`);
                
                // Update commercial invoice value (always in USD for landed cost calculation)
                commercialValueEl.value = totalValue.toFixed(2);
                
                // Also update the total kg in landed cost section to match
                if (landedTotalKgEl) {
                    landedTotalKgEl.value = totalKg.toString();
                }
                
                // Update display if app is loaded
                if (window.App && App.updateDisplay) {
                    App.updateDisplay();
                }
                
                console.log('‚úÖ Commercial value updated to:', totalValue.toFixed(2));
                return true;
            } else {
                console.log('‚ùå Required elements not found for calculation');
                return false;
            }
        }
        
        // Make function globally available
        window.updateCommercialValue = updateCommercialValue;

        // --- INPUT VALIDATION UTILITY ---
        const ValidationUtil = {
            // Exchange rate validation bounds (reasonable ranges for major currencies to ZAR)
            exchangeRateLimits: {
                usd: { min: 10, max: 25, name: 'USD to ZAR' },
                eur: { min: 12, max: 30, name: 'EUR to ZAR' },
                gbp: { min: 15, max: 35, name: 'GBP to ZAR' }
            },
            
            validateExchangeRate(rateKey, value) {
                const numValue = parseFloat(value);
                const limits = this.exchangeRateLimits[rateKey];
                
                if (!limits) return { isValid: true, message: '' };
                
                if (isNaN(numValue) || numValue <= 0) {
                    return { 
                        isValid: false, 
                        message: `${limits.name} rate must be a positive number` 
                    };
                }
                
                if (numValue < limits.min || numValue > limits.max) {
                    return { 
                        isValid: false, 
                        message: `${limits.name} rate should be between ${limits.min} and ${limits.max}. Current value (${numValue}) seems unusual.` 
                    };
                }
                
                return { isValid: true, message: '' };
            },
            
            validateCurrencyAmount(value) {
                const numValue = parseFloat(value);
                
                if (isNaN(numValue)) {
                    return { 
                        isValid: false, 
                        message: 'Amount must be a valid number' 
                    };
                }
                
                if (numValue < 0) {
                    return { 
                        isValid: false, 
                        message: 'Amount cannot be negative' 
                    };
                }
                
                if (numValue > 10000000) { // 10 million limit
                    return { 
                        isValid: false, 
                        message: 'Amount seems unusually large. Please verify.' 
                    };
                }
                
                return { isValid: true, message: '' };
            },
            
            validateOriginCharges(ratePerKg, totalKg) {
                const rate = parseFloat(ratePerKg);
                const kg = parseFloat(totalKg);
                
                const errors = [];
                const warnings = [];
                
                if (isNaN(rate) || rate <= 0) {
                    errors.push('Rate per Kg must be a positive number');
                }
                
                if (isNaN(kg) || kg <= 0) {
                    errors.push('Total Kg must be a positive number');
                }
                
                if (rate > 0 && rate < 0.01) {
                    errors.push('Rate per Kg seems too low (less than $0.01)');
                }
                
                if (rate > 1000) {
                    errors.push('Rate per Kg seems unusually high (over $1000)');
                }
                
                // Container capacity warnings
                if (kg > 0) {
                    if (kg > 28000) {
                        warnings.push('‚ö†Ô∏è Weight exceeds 40ft container limit (28,000kg max)');
                    } else if (kg > 21000) {
                        warnings.push('‚ö†Ô∏è Weight exceeds 20ft container limit (21,000kg max)');
                    }
                }
                
                if (kg > 50000) {
                    errors.push('Total Kg seems unusually high (over 50,000kg)');
                }
                
                return {
                    isValid: errors.length === 0,
                    message: errors.join('. '),
                    warnings: warnings
                };
            },

            validateContainerCapacity(totalKg, containerSize) {
                const kg = parseFloat(totalKg);
                const warnings = [];
                const errors = [];

                if (kg > 0 && containerSize) {
                    const limits = {
                        '20ft': { maxWeight: 21000, maxVolume: 33, name: '20ft Container' },
                        '40ft': { maxWeight: 26500, maxVolume: 67, name: '40ft Container' },
                        '40ft HC': { maxWeight: 28000, maxVolume: 76, name: '40ft High Cube' },
                        '45ft': { maxWeight: 28000, maxVolume: 86, name: '45ft Container' }
                    };

                    const limit = limits[containerSize];
                    if (limit) {
                        if (kg > limit.maxWeight) {
                            errors.push(`üö® Weight (${kg.toLocaleString()}kg) exceeds ${limit.name} limit (${limit.maxWeight.toLocaleString()}kg)`);
                        } else if (kg > limit.maxWeight * 0.9) {
                            warnings.push(`‚ö†Ô∏è Weight (${kg.toLocaleString()}kg) approaching ${limit.name} limit (${limit.maxWeight.toLocaleString()}kg)`);
                        }
                    }
                }

                return { errors, warnings };
            },
            
            showValidationError(message, element = null) {
                if (element) {
                    element.style.borderColor = '#ef4444';
                    element.style.backgroundColor = '#fef2f2';
                }
                showToast(message, 'error');
                console.warn('‚ö†Ô∏è Validation Error:', message);
            },
            
            clearValidationError(element) {
                if (element) {
                    element.style.borderColor = '';
                    element.style.backgroundColor = '';
                }
            }
        };

        // --- CORE APP LOGIC ---
        const App = {
            db: null,
            userId: null,
            quotesCollection: null,
            requestsCollection: null,

            elements: {
                pageTitle: document.getElementById('page-title'),
                headerButtons: document.getElementById('header-buttons'),
                pages: document.querySelectorAll('.page'),
                sidebarNav: document.getElementById('sidebar-nav'),
            },

            async init() {
                try {
                    console.log('üöÄ Starting app initialization...');
                    
                    console.log('üì° Initializing Firebase...');
                    await this.initFirebase(); 
                    
                    console.log('üí± Initializing exchange rates...');
                    await this.initExchangeRates();
                    
                    console.log('üìù Generating form inputs...');
                    this.generateInputs();
                    
                    // Small delay to ensure DOM elements are ready
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    console.log('üîÑ Updating display...');
                    this.updateDisplay();
                    
                    console.log('üéØ Attaching event listeners...');
                    this.attachEventListeners();
                    
                    console.log('üìÑ Handling initial page load...');
                    this.handleInitialPageLoad();
                    
                    if (this.db) {
                        console.log('üîÑ Setting up real-time listeners...');
                        this.listenForQuotes();
                        this.listenForCostRequests();
                    } else {
                        console.log('üíæ Loading local quotes (offline mode)...');
                        this.loadLocalQuotes();
                    }
                    
                    console.log('‚úÖ App initialization completed successfully!');
                    showToast('Application loaded successfully! üéâ', 'success');
                    
                } catch (error) {
                    console.error('‚ùå App initialization failed:', error);
                    showToast('Application failed to load. Check console for details.', 'error');
                    throw error; // Re-throw to be caught by outer try-catch
                }
            },

            async initExchangeRates() {
                try {
                    const rates = await exchangeRateService.initializeRates();
                    state.exchangeRates = rates;
                    
                    // Update the display if exchange rates section is visible
                    setTimeout(() => {
                        this.updateExchangeRatesDisplay();
                    }, 100);
                } catch (error) {
                    console.error('Failed to initialize exchange rates:', error);
                    showToast('Using default exchange rates', 'warning');
                }
            },

            updateExchangeRatesDisplay() {
                const container = document.getElementById('exchange-rates');
                if (container) {
                    // Clear and regenerate exchange rates section
                    container.innerHTML = '';
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                    
                    // Create currency blocks for USD, EUR, GBP
                    const currencies = [
                        { code: 'USD', rateKey: 'usd', amountKey: 'usdAmount', symbol: '$', flag: 'üá∫üá∏' },
                        { code: 'EUR', rateKey: 'eur', amountKey: 'eurAmount', symbol: '‚Ç¨', flag: 'üá™üá∫' },
                        { code: 'GBP', rateKey: 'gbp', amountKey: 'gbpAmount', symbol: '¬£', flag: 'üá¨üáß' }
                    ];

                    currencies.forEach(currency => {
                        const rate = state.exchangeRates[currency.rateKey];
                        const amount = state.currencyAmounts[currency.amountKey];
                        
                        // Calculate ZAR equivalent
                        const zarEquivalent = (parseFloat(amount.value) * parseFloat(rate.value)).toFixed(2);
                        
                        const currencyBlock = document.createElement('div');
                        currencyBlock.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                        currencyBlock.innerHTML = `
                            <div class="text-center mb-3">
                                <div class="text-lg font-semibold text-gray-800">
                                    ${currency.flag} ${currency.code}
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <!-- Exchange Rate -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Exchange Rate (${currency.code} to ZAR)
                                    </label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${rate.value}"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50"
                                        onchange="App.updateExchangeRate('${currency.rateKey}', this.value, this)"
                                        readonly
                                    >
                                </div>
                                
                                <!-- Currency Amount -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        ${currency.code} Amount
                                    </label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${amount.value}"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="App.updateCurrencyAmount('${currency.amountKey}', this.value, this)"
                                        placeholder="Enter ${currency.code} amount"
                                    >
                                </div>
                                
                                <!-- ZAR Equivalent -->
                                <div class="bg-green-50 border border-green-200 rounded-md p-2">
                                    <div class="text-xs font-medium text-green-700 mb-1">ZAR Equivalent</div>
                                    <div class="text-lg font-bold text-green-800">
                                        R ${formatCurrency(zarEquivalent, 'ZAR').replace('ZAR', '').trim()}
                                    </div>
                                    <div class="text-xs text-green-600">
                                        ${currency.symbol}${amount.value} √ó ${rate.value}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(currencyBlock);
                    });
                    
                    // Add last updated info and refresh button
                    const lastUpdate = exchangeRateService.getLastUpdateTime();
                    const isExpired = exchangeRateService.isCacheExpired();
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'col-span-full text-sm text-gray-600 border-t pt-3 mt-3';
                    infoDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div>Last updated: ${lastUpdate}</div>
                                <div class="text-xs ${isExpired ? 'text-yellow-600' : 'text-green-600'}">
                                    ${isExpired ? '‚ö†Ô∏è Rates may be outdated' : '‚úÖ Rates are current'}
                                </div>
                            </div>
                            <button onclick="App.refreshExchangeRates()" class="btn text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                üîÑ Refresh Rates
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Rates are live spot price √ó 2 | Source: ExchangeRate-API
                        </div>
                    `;
                    container.appendChild(infoDiv);
                }
            },

            async refreshExchangeRates() {
                try {
                    const rates = await exchangeRateService.fetchAllRates();
                    state.exchangeRates = rates;
                    this.updateExchangeRatesDisplay();
                    this.updateDisplay(); // Recalculate all costs with new rates
                } catch (error) {
                    console.error('Failed to refresh exchange rates:', error);
                    showToast('Failed to refresh rates', 'error');
                }
            },

            updateCurrencyAmount(amountKey, value, element = null) {
                const validation = ValidationUtil.validateCurrencyAmount(value);
                
                if (!validation.isValid) {
                    ValidationUtil.showValidationError(validation.message, element);
                    return false; // Don't update if invalid
                }
                
                // Clear any previous validation errors
                if (element) ValidationUtil.clearValidationError(element);
                
                state.currencyAmounts[amountKey].value = value;
                this.updateExchangeRatesDisplay(); // Refresh to show new ZAR calculations
                this.updateDisplay(); // Update any cost calculations that might use these amounts
                return true;
            },

            updateExchangeRate(rateKey, value, element = null) {
                const validation = ValidationUtil.validateExchangeRate(rateKey, value);
                
                if (!validation.isValid) {
                    ValidationUtil.showValidationError(validation.message, element);
                    return false; // Don't update if invalid
                }
                
                // Clear any previous validation errors
                if (element) ValidationUtil.clearValidationError(element);
                
                state.exchangeRates[rateKey].value = value;
                this.updateExchangeRatesDisplay(); // Refresh to show new ZAR calculations
                this.updateDisplay(); // Recalculate all costs with new rate
                return true;
            },

            async initFirebase() {
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    if (!firebaseConfig.apiKey) {
                        throw new Error("Firebase config is missing or invalid.");
                    }
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    const auth = getAuth(app);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                    this.userId = auth.currentUser.uid;
                    this.quotesCollection = collection(this.db, "quotes");
                    this.requestsCollection = collection(this.db, "cost_requests");
                } catch(e) {
                    console.error("Firebase initialization failed:", e);
                }
            },

            switchPage(pageId) {
                if (!pageId) return;
                
                this.elements.headerButtons.innerHTML = ''; 
                if (pageId === 'cost-generator-page') {
                    this.elements.headerButtons.innerHTML = `
                        <button id="save-quote-button" class="btn btn-success text-white font-bold py-2 px-4 rounded-lg">
                            üíæ Save Quote
                        </button>
                        <button id="pdf-button" class="btn btn-primary text-white font-bold py-2 px-4 rounded-lg">
                            üìÑ Generate PDF
                        </button>`;
                }
                
                this.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                document.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
                
                const pageIcons = {
                    'dashboard-page': 'üìä Dashboard',
                    'cost-generator-page': 'üí∞ Cost Generator', 
                    'cost-request-page': 'üìù Cost Request'
                };
                
                this.elements.pageTitle.textContent = pageIcons[pageId] || 'Dashboard';
                
                // Load page-specific content
                if (pageId === 'dashboard-page') {
                    setTimeout(() => this.loadTemplateGrid(), 100);
                }
            },
            
            attachEventListeners() {
                this.elements.sidebarNav.addEventListener('click', (e) => {
                    if (e.target && e.target.matches('a.sidebar-link')) {
                        e.preventDefault();
                        const pageId = e.target.dataset.page;
                        if(pageId) {
                           window.location.hash = e.target.hash;
                           this.switchPage(pageId);
                        }
                    }
                });
                
                this.elements.headerButtons.addEventListener('click', (e) => {
                    if (e.target.id === 'save-quote-button') this.saveQuote();
                    if (e.target.id === 'pdf-button') this.generatePdf();
                });
                
                document.getElementById('cost-generator-page').addEventListener('input', () => this.updateDisplay());
                document.getElementById('cost-request-form').addEventListener('submit', (e) => this.submitCostRequest(e));
            },
            
            handleInitialPageLoad() {
                const initialHash = window.location.hash.substring(1);
                const validPages = ['dashboard', 'generator', 'request'];
                const initialPage = validPages.includes(initialHash) ? initialHash : 'dashboard';
                this.switchPage(`${initialPage}-page`);
                
                // Load templates on dashboard
                if (initialPage === 'dashboard') {
                    this.loadTemplateGrid();
                }
            },

            // --- TEMPLATE SYSTEM METHODS ---
            loadTemplateGrid() {
                const templateGrid = document.getElementById('template-grid');
                if (!templateGrid) return;

                const templates = QuoteTemplates.getAllTemplates();
                
                templateGrid.innerHTML = templates.map(template => `
                    <div class="template-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer transform hover:scale-105"
                         onclick="App.applyTemplate('${template.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${template.icon}</div>
                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">Template</span>
                        </div>
                        <h4 class="font-semibold text-gray-800 text-sm mb-2">${template.name}</h4>
                        <p class="text-xs text-gray-600 mb-3">${template.description}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>${template.data.shipmentDetails.pol}</span>
                            <span>‚Üí</span>
                            <span>${template.data.shipmentDetails.pod}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>Rate: $${template.data.originCharges.ratePerKg}/kg</span>
                                <span>Duty: ${template.data.landedCost.dutyRate}%</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                console.log('‚úÖ Template grid loaded with', templates.length, 'templates');
            },

            applyTemplate(templateId) {
                console.log('üéØ Applying template:', templateId);
                
                const success = QuoteTemplates.applyTemplate(templateId);
                
                if (success) {
                    // Switch to cost generator page
                    this.switchPage('cost-generator-page');
                    
                    // Regenerate all inputs with new data
                    this.generateInputs();
                    
                    // Update commercial value calculation
                    setTimeout(() => {
                        if (window.updateCommercialValue) {
                            updateCommercialValue();
                        }
                        this.updateDisplay();
                    }, 100);
                    
                    const template = QuoteTemplates.getTemplate(templateId);
                    showToast(`Template "${template.name}" applied successfully! üéâ`, 'success');
                    
                    console.log('‚úÖ Template applied and page updated');
                } else {
                    showToast('Failed to apply template', 'error');
                    console.error('‚ùå Failed to apply template:', templateId);
                }
            },

            showAllTemplates() {
                // For now, scroll to templates section. Later we can add a modal
                const templateGrid = document.getElementById('template-grid');
                if (templateGrid) {
                    templateGrid.scrollIntoView({ behavior: 'smooth' });
                    showToast('All templates are shown below üëá', 'info');
                }
            },

            // --- ENHANCED QUOTE FILTERING METHODS ---
            filterQuotes(searchTerm = '') {
                const searchInput = document.getElementById('quote-search');
                const filterSelect = document.getElementById('quote-filter');
                
                const search = searchTerm || (searchInput ? searchInput.value : '');
                const filter = filterSelect ? filterSelect.value : '';
                
                console.log('üîç Filtering quotes:', { search, filter });
                
                // This will be implemented when we have quotes to filter
                // For now, just show that the feature is working
                if (search) {
                    showToast(`Searching for: "${search}"`, 'info');
                }
                if (filter) {
                    showToast(`Filtering by: ${filter}`, 'info');
                }
            },

            // --- PRICING STRATEGY METHODS ---
            updatePricingMethod(method) {
                state.pricingStrategy.pricingMethod.value = method;
                
                // Show/hide relevant input fields
                const marginContainer = document.getElementById('ps-marginPercent-container');
                const markupContainer = document.getElementById('ps-markupPercent-container');
                const manualContainer = document.getElementById('ps-manualSellPrice-container');
                
                if (marginContainer) marginContainer.style.display = method === 'margin' ? 'block' : 'none';
                if (markupContainer) markupContainer.style.display = method === 'markup' ? 'block' : 'none';
                if (manualContainer) manualContainer.style.display = method === 'manual' ? 'block' : 'none';
                
                // Update calculations
                this.updatePricingStrategy();
                
                console.log('üí∞ Pricing method changed to:', method);
            },

            updatePricingStrategy() {
                try {
                    const { totals, landed } = this.calculateAll();
                    
                    // Get current pricing inputs
                    const unitQuantity = parseFloat(document.getElementById('ps-unitQuantity')?.value || state.pricingStrategy.unitQuantity.value);
                    const pricingMethod = document.getElementById('ps-pricingMethod')?.value || state.pricingStrategy.pricingMethod.value;
                    const targetCurrency = document.getElementById('ps-targetCurrency')?.value || state.pricingStrategy.targetCurrency.value;
                    const marginPercent = parseFloat(document.getElementById('ps-marginPercent')?.value || state.pricingStrategy.marginPercent.value);
                    const markupPercent = parseFloat(document.getElementById('ps-markupPercent')?.value || state.pricingStrategy.markupPercent.value);
                    const manualSellPrice = parseFloat(document.getElementById('ps-manualSellPrice')?.value || state.pricingStrategy.manualSellPrice.value);
                    
                    // Calculate base costs
                    const totalLandedCostZAR = landed.totalLandedCost;
                    const costPerUnit = totalLandedCostZAR / unitQuantity;
                    
                    // Exchange rates for target currency
                    const zarRates = { 
                        zar: 1, 
                        usd: parseFloat(state.exchangeRates.usd.value), 
                        eur: parseFloat(state.exchangeRates.eur.value) 
                    };
                    
                    const costPerUnitInTargetCurrency = costPerUnit / zarRates[targetCurrency];
                    
                    // Calculate pricing based on method
                    let sellPricePerUnit, profit, profitMargin, markup;
                    
                    if (pricingMethod === 'margin') {
                        // Margin = (Sell Price - Cost) / Sell Price * 100
                        // Sell Price = Cost / (1 - Margin/100)
                        sellPricePerUnit = costPerUnitInTargetCurrency / (1 - marginPercent / 100);
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = marginPercent;
                        markup = (profit / costPerUnitInTargetCurrency) * 100;
                    } else if (pricingMethod === 'markup') {
                        // Markup = (Sell Price - Cost) / Cost * 100
                        // Sell Price = Cost * (1 + Markup/100)
                        sellPricePerUnit = costPerUnitInTargetCurrency * (1 + markupPercent / 100);
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = (profit / sellPricePerUnit) * 100;
                        markup = markupPercent;
                    } else { // manual
                        sellPricePerUnit = manualSellPrice;
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = (profit / sellPricePerUnit) * 100;
                        markup = (profit / costPerUnitInTargetCurrency) * 100;
                    }
                    
                    const totalRevenue = sellPricePerUnit * unitQuantity;
                    const totalProfit = profit * unitQuantity;
                    
                    // Currency symbols
                    const currencySymbols = { zar: 'R', usd: '$', eur: '‚Ç¨' };
                    const symbol = currencySymbols[targetCurrency];
                    
                    // Update display
                    const outputContainer = document.getElementById('pricing-strategy-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = `
                            <div class="space-y-3">
                                <!-- Cost Analysis -->
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <h4 class="font-semibold text-gray-700 mb-2">üìä Cost Analysis</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Total Landed Cost:</span>
                                            <span class="font-medium">${formatCurrency(totalLandedCostZAR)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Cost per Unit (${targetCurrency.toUpperCase()}):</span>
                                            <span class="font-medium">${symbol}${costPerUnitInTargetCurrency.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Unit Quantity:</span>
                                            <span class="font-medium">${unitQuantity.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pricing Results -->
                                <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
                                    <h4 class="font-semibold text-blue-700 mb-2">üí∞ Pricing Results</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Sell Price per Unit:</span>
                                            <span class="font-bold text-blue-800">${symbol}${sellPricePerUnit.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Profit per Unit:</span>
                                            <span class="font-medium text-green-600">${symbol}${profit.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Profit Margin:</span>
                                            <span class="font-medium ${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}">${profitMargin.toFixed(1)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Markup:</span>
                                            <span class="font-medium">${markup.toFixed(1)}%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Total Financial Impact -->
                                <div class="bg-green-50 p-3 rounded-md border border-green-200">
                                    <h4 class="font-semibold text-green-700 mb-2">üéØ Total Impact</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Total Revenue:</span>
                                            <span class="font-bold text-green-800">${symbol}${totalRevenue.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Total Profit:</span>
                                            <span class="font-bold ${totalProfit >= 0 ? 'text-green-800' : 'text-red-600'}">${symbol}${totalProfit.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Break-even Units:</span>
                                            <span class="font-medium">${Math.ceil(totalLandedCostZAR / (sellPricePerUnit * zarRates[targetCurrency])).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${profit < 0 ? `<div class="bg-red-50 p-2 rounded-md border border-red-200">
                                    <span class="text-xs text-red-700">‚ö†Ô∏è Warning: Current pricing results in a loss!</span>
                                </div>` : ''}
                            </div>
                        `;
                    }
                    
                    console.log('üìà Pricing strategy updated:', {
                        method: pricingMethod,
                        sellPrice: sellPricePerUnit,
                        profit: profit,
                        margin: profitMargin
                    });
                    
                } catch (error) {
                    console.error('Error updating pricing strategy:', error);
                    const outputContainer = document.getElementById('pricing-strategy-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = '<div class="text-red-600 text-sm">Error calculating pricing. Please check your inputs.</div>';
                    }
                }
            },
            
            getCurrentData(fullState = false) { 
                const currentValues = { details: {}, exchangeRates: {}, originCharges: {}, costs: {}, landedCost: {} }; 
                
                // Collect shipment details
                for (const key in state.shipmentDetails) {
                    const element = document.getElementById(`sd-${key}`);
                    currentValues.details[key] = element ? element.value : state.shipmentDetails[key].value;
                }
                
                // Collect exchange rates
                for (const key in state.exchangeRates) {
                    const element = document.getElementById(`er-${key}`);
                    currentValues.exchangeRates[key] = element ? element.value : state.exchangeRates[key].value;
                } 
                
                // Collect origin charges (NEW)
                if (state.originCharges && state.originCharges.items) {
                    for (const itemKey in state.originCharges.items) { 
                        const valueEl = document.getElementById(`origin-${itemKey}-value`); 
                        const currencyEl = document.getElementById(`origin-${itemKey}-currency`); 
                        if(valueEl) { 
                            currentValues.originCharges[itemKey] = { 
                                value: valueEl.value, 
                                currency: currencyEl ? currencyEl.value : state.originCharges.items[itemKey].currency 
                            }; 
                        } else {
                            // Fallback to state values if elements don't exist
                            currentValues.originCharges[itemKey] = {
                                value: state.originCharges.items[itemKey].value,
                                currency: state.originCharges.items[itemKey].currency
                            };
                        }
                    }
                }
                
                // Collect remaining cost sections (excluding origin which is now separate)
                for (const sectionKey in state.costs) { 
                    currentValues.costs[sectionKey] = {}; 
                    for (const itemKey in state.costs[sectionKey].items) { 
                        const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`); 
                        const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`); 
                        if(valueEl) { 
                            currentValues.costs[sectionKey][itemKey] = { 
                                value: valueEl.value, 
                                currency: currencyEl ? currencyEl.value : state.costs[sectionKey].items[itemKey].currency 
                            }; 
                        } else {
                            // Fallback to state values if elements don't exist
                            currentValues.costs[sectionKey][itemKey] = {
                                value: state.costs[sectionKey].items[itemKey].value,
                                currency: state.costs[sectionKey].items[itemKey].currency
                            };
                        }
                    } 
                } 
                
                // Collect landed cost data
                for (const key in state.landedCost) { 
                    const el = document.getElementById(`lc-${key}`); 
                    currentValues.landedCost[key] = el ? el.value : state.landedCost[key].value; 
                } 
                
                if (fullState) { 
                    const now = new Date(); 
                    currentValues.quoteNumber = `SYN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${now.getTime().toString().slice(-4)}`; 
                    currentValues.createdAt = now.toISOString(); 
                    currentValues.createdBy = this.userId; 
                } 
                return currentValues; 
            },
            async saveQuote() {
                if (!this.quotesCollection) {
                    // Fallback to localStorage when Firebase is not available
                    return this.saveQuoteLocal();
                }
                const button = document.getElementById('save-quote-button'); 
                if (!button) return; 
                button.disabled = true; 
                button.innerHTML = '<span class="loading"></span> Saving...'; 
                try { 
                    await addDoc(this.quotesCollection, this.getCurrentData(true)); 
                    showToast('Quote saved successfully! üéâ', 'success'); 
                } catch (error) { 
                    console.error("Error saving quote: ", error); 
                    showToast("Failed to save quote. Please try again.", 'error');
                } finally { 
                    if(button) { button.disabled = false; button.innerHTML = 'üíæ Save Quote'; }
                } 
            },
            async loadQuote(quoteId) {
                if (!this.db) {
                    alert('Database not available');
                    return;
                }
                
                try {
                    console.log('Loading quote with ID:', quoteId);
                    const quoteDoc = await getDoc(doc(this.db, "quotes", quoteId));
                    
                    if (quoteDoc.exists()) {
                        const data = quoteDoc.data();
                        console.log('Quote data loaded:', data);
                        
                        // Load shipment details
                        if (data.details) {
                            for (const key in data.details) {
                                const el = document.getElementById(`sd-${key}`);
                                if (el) {
                                    el.value = data.details[key];
                                    console.log(`Set ${key} to ${data.details[key]}`);
                                }
                            }
                        }
                        
                        // Load exchange rates
                        if (data.exchangeRates) {
                            for (const key in data.exchangeRates) {
                                const el = document.getElementById(`er-${key}`);
                                if (el) {
                                    el.value = data.exchangeRates[key];
                                }
                            }
                        }
                        
                        // Load origin charges (NEW)
                        if (data.originCharges) {
                            for (const itemKey in state.originCharges.items) {
                                if (data.originCharges[itemKey]) {
                                    const valueEl = document.getElementById(`origin-${itemKey}-value`);
                                    const currencyEl = document.getElementById(`origin-${itemKey}-currency`);
                                    
                                    if (valueEl) {
                                        valueEl.value = data.originCharges[itemKey].value;
                                    }
                                    if (currencyEl) {
                                        currencyEl.value = data.originCharges[itemKey].currency;
                                    }
                                }
                            }
                        }
                        
                        // Load costs
                        if (data.costs) {
                            for (const sectionKey in state.costs) {
                                if (data.costs[sectionKey]) {
                                    for (const itemKey in state.costs[sectionKey].items) {
                                        if (data.costs[sectionKey][itemKey]) {
                                            const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`);
                                            const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`);
                                            
                                            if (valueEl) {
                                                valueEl.value = data.costs[sectionKey][itemKey].value;
                                            }
                                            if (currencyEl) {
                                                currencyEl.value = data.costs[sectionKey][itemKey].currency;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Load landed cost
                        if (data.landedCost) {
                            for (const key in data.landedCost) {
                                const el = document.getElementById(`lc-${key}`);
                                if (el) {
                                    el.value = data.landedCost[key];
                                }
                            }
                        }
                        
                        // Switch to cost generator page and update display
                        this.switchPage('cost-generator-page');
                        this.updateDisplay();
                        showToast('Quote loaded successfully! ‚ú®', 'success');
                        
                    } else {
                        alert("Quote not found.");
                    }
                } catch (error) {
                    console.error("Error loading quote: ", error);
                    alert("Error loading quote: " + error.message);
                }
            },
            
            saveQuoteLocal() {
                const button = document.getElementById('save-quote-button');
                if (!button) return;
                button.disabled = true;
                button.textContent = 'Saving...';
                
                try {
                    const quoteData = this.getCurrentData(true);
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    quoteData.id = Date.now().toString();
                    quotes.push(quoteData);
                    localStorage.setItem('synerore_quotes', JSON.stringify(quotes));
                    showToast('Quote saved locally! üì± Note: Only visible on this browser.', 'warning');
                    this.loadLocalQuotes();
                } catch (error) {
                    console.error('Error saving quote locally:', error);
                    alert('Failed to save quote locally.');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Save Quote';
                }
            },
            
            loadLocalQuotes() {
                const listContainer = document.getElementById('saved-quotes-list');
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    if (quotes.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-500">No quotes saved yet.</p>';
                        return;
                    }
                    
                    quotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    listContainer.innerHTML = quotes.map(quote => 
                        `<div class="quote-card flex items-center justify-between p-4">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">üì¶ ${quote.details.supplierName || 'No Supplier'}</p>
                                <p class="text-sm text-gray-500">Quote #${quote.quoteNumber} ‚Ä¢ ${new Date(quote.createdAt).toLocaleDateString('en-GB')} <span class="text-orange-500 font-medium">(Local)</span></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="App.loadLocalQuote('${quote.id}')" class="btn btn-primary text-white font-semibold py-2 px-4 rounded-lg">
                                    üìÇ Load
                                </button>
                                <button onclick="App.deleteLocalQuote('${quote.id}')" class="btn btn-danger text-white font-semibold py-2 px-3 rounded-lg" title="Delete Local Quote">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>`
                    ).join('');
                } catch (error) {
                    console.error('Error loading local quotes:', error);
                    listContainer.innerHTML = '<p class="text-red-500">Error loading local quotes.</p>';
                }
            },
            
            loadLocalQuote(quoteId) {
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    const quote = quotes.find(q => q.id === quoteId);
                    if (!quote) {
                        alert('Quote not found.');
                        return;
                    }
                    
                    for (const key in quote.details) {
                        const el = document.getElementById(`sd-${key}`);
                        if (el) el.value = quote.details[key];
                    }
                    for (const key in quote.exchangeRates) {
                        const el = document.getElementById(`er-${key}`);
                        if (el) el.value = quote.exchangeRates[key];
                    }
                    for (const sectionKey in state.costs) {
                        if (quote.costs[sectionKey]) {
                            for (const itemKey in state.costs[sectionKey].items) {
                                if (quote.costs[sectionKey][itemKey]) {
                                    const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`);
                                    const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`);
                                    if (valueEl) valueEl.value = quote.costs[sectionKey][itemKey].value;
                                    if (currencyEl) currencyEl.value = quote.costs[sectionKey][itemKey].currency;
                                }
                            }
                        }
                    }
                    for (const key in quote.landedCost) {
                        const el = document.getElementById(`lc-${key}`);
                        if (el) el.value = quote.landedCost[key];
                    }
                    
                    this.updateDisplay();
                    this.switchPage('cost-generator-page');
                    alert('Quote loaded successfully!');
                } catch (error) {
                    console.error('Error loading local quote:', error);
                    alert('Error loading quote.');
                }
            },
            generatePdf() { const { details, totals, landed } = this.calculateAll(); const now = new Date(); const quoteNumber = `SYN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${now.getTime().toString().slice(-4)}`; const todayDate = now.toLocaleDateString('en-GB'); const pdfHtml = ` <div style="font-family: Arial, sans-serif; color: #333; margin: 25px;"> <table style="width: 100%; border-bottom: 2px solid #6366f1;"> <tr> <td style="width: 50%;"><img src="synercore-logo.png" alt="Synerore Logo" style="width: 150px;"></td> <td style="width: 50%; text-align: right;"> <h1 style="font-size: 28px; color: #6366f1; margin: 0;">Cost Estimate</h1> <p style="margin: 2px 0;"><b>Quote #:</b> ${quoteNumber}</p> <p style="margin: 2px 0;"><b>Date:</b> ${todayDate}</p> </td> </tr> </table> <table style="width: 100%; margin-top: 25px;"> <tr> <td style="vertical-align: top; width: 50%;"><h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Prepared For:</h2><p style="margin: 2px 0;"><strong>${details.supplierName}</strong></p></td> <td style="vertical-align: top; width: 50%;"><h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Shipment Details:</h2><p style="margin: 2px 0;"><strong>Origin:</strong> ${details.pol}</p><p style="margin: 2px 0;"><strong>Destination:</strong> ${details.pod}</p><p style="margin: 2px 0;"><strong>Container:</strong> ${details.containerSize}</p><p style="margin: 2px 0;"><strong>Commodity:</strong> ${details.commodity}</p></td> </tr> </table> <h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 25px 0 10px 0;">Costing Summary (in ZAR)</h2> <table style="width: 100%; border-collapse: collapse;"> <tr style="background-color: #f3f4f6;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Description</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Amount</th></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Freight Costs</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalFreight)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Origin Charges</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalOrigin)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Destination Charges</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalDestinationCharges)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Forwarding & Clearing</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalClearing)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Transport & Warehousing</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalTransport)}</td></tr> <tr style="font-weight: bold;"><td style="padding: 8px; border-top: 2px solid #333; border-bottom: 1px solid #eee;">Sub-Total (excl. VAT)</td><td style="padding: 8px; text-align: right; border-top: 2px solid #333; border-bottom: 1px solid #eee;">${formatCurrency(totals.preVatTotal)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">VAT on Services (15%)</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.vatOnServices)}</td></tr> <tr style="background-color: #eef2ff; font-weight: bold; font-size: 18px;"><td style="padding: 10px;">Grand Total</td><td style="padding: 10px; text-align: right;">${formatCurrency(totals.grandTotal)}</td></tr> </table> <h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 25px 0 10px 0;">Landed Cost Breakdown</h2> <table style="width: 100%; border-collapse: collapse;"> <tr style="background-color: #f3f4f6;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Description</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Amount</th></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Commercial Value (ZAR)</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.commercialValueZAR)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Customs Duty</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.dutyAmount)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">VAT on Goods</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.vatOnGoods)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Total Clearing & Forwarding Costs</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.totalClearingCosts)}</td></tr> <tr style="font-weight: bold; font-size: 16px;"><td style="padding: 8px; border-top: 2px solid #333; border-bottom: 1px solid #eee;">Total Landed Cost</td><td style="padding: 8px; text-align: right; border-top: 2px solid #333; border-bottom: 1px solid #eee;">${formatCurrency(landed.totalLandedCost)}</td></tr> <tr style="background-color: #dcfce7; font-weight: bold; font-size: 18px;"><td style="padding: 10px;">Cost per Kg</td><td style="padding: 10px; text-align: right;">${formatCurrency(landed.costPerKg)}</td></tr> </table> <div style="margin-top: 40px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 12px; color: #777;"><p><strong>Terms & Conditions:</strong></p><p>This is an estimate only and is subject to change based on final weights, dimensions, and applicable rates at the time of shipment. All business is conducted in accordance with our standard trading terms and conditions, available on request.</p><p style="margin-top: 10px;">Synercore (Pty) Ltd</p></div> </div>`; const options = { margin: 0.5, filename: `Synercore-Costing-${details.supplierName.replace(/ /g, '_')}-${quoteNumber}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; html2pdf().from(pdfHtml).set(options).save(); },
            calculateAll() {
                const currentValues = this.getCurrentData();
                const { details } = currentValues;
                const zarRates = { ...Object.fromEntries(Object.entries(currentValues.exchangeRates).map(([k,v]) => [k, parseFloat(v)])), zar: 1 };
                const calculateSectionTotal = (section) => Object.values(section).reduce((acc, item) => acc + (parseFloat(item.value || 0) * (zarRates[item.currency] || 0)), 0);
                
                // Special calculation for Origin Charges (rate per kg * total kg)
                const calculateOriginTotal = (originCharges) => {
                    if (originCharges.ratePerKg && originCharges.totalKg) {
                        const ratePerKg = parseFloat(originCharges.ratePerKg.value || 0);
                        const totalKg = parseFloat(originCharges.totalKg.value || 0);
                        const currency = originCharges.ratePerKg.currency || 'usd';
                        return ratePerKg * totalKg * (zarRates[currency] || 0);
                    }
                    return 0;
                };
                
                const totals = { 
                    subtotalFreight: calculateSectionTotal(currentValues.costs.freight), 
                    subtotalOrigin: calculateOriginTotal(currentValues.originCharges), // Updated: now uses special origin calculation
                    subtotalDestinationCharges: calculateSectionTotal(currentValues.costs.destinationCharges), 
                    subtotalClearing: calculateSectionTotal(currentValues.costs.clearing),
                    subtotalTransport: calculateSectionTotal(currentValues.costs.transport),
                };
                                
                totals.preVatTotal = totals.subtotalFreight + totals.subtotalOrigin + totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport;
                totals.vatOnServices = (totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport) * VAT_RATE;
                totals.grandTotal = totals.preVatTotal + totals.vatOnServices;
                
                const landed = {};
                landed.commercialValueZAR = parseFloat(currentValues.landedCost.commercialInvoiceValue) * zarRates.usd;
                const dutyBaseValue = landed.commercialValueZAR * 1.1;
                landed.dutyAmount = dutyBaseValue * (parseFloat(currentValues.landedCost.dutyRate) / 100);
                const vatBaseValue = dutyBaseValue + landed.dutyAmount;
                landed.vatOnGoods = vatBaseValue * VAT_RATE;
                landed.totalClearingCosts = totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport + totals.vatOnServices;
                landed.totalLandedCost = landed.commercialValueZAR + landed.dutyAmount + landed.vatOnGoods + landed.totalClearingCosts;
                const totalKg = parseFloat(currentValues.landedCost.totalKg) || 1;
                landed.costPerKg = landed.totalLandedCost / totalKg;
                return { details, totals, landed };
            },
            updateDisplay() { 
                const { totals, landed } = this.calculateAll(); 
                document.getElementById('summary-output').innerHTML = ` <div class="flex justify-between"><span class="text-gray-600">Freight Costs:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalFreight)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Origin Charges:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalOrigin)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Destination Charges:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalDestinationCharges)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Forwarding & Clearing:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalClearing)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Transport & Warehousing:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalTransport)}</span></div> <div class="border-t my-2"></div> <div class="flex justify-between text-base"><span class="font-semibold text-gray-700">Sub-Total (excl. VAT):</span> <span class="font-bold text-gray-900">${formatCurrency(totals.preVatTotal)}</span></div> <div class="flex justify-between"><span class="text-gray-600">VAT on Services (15%):</span> <span class="font-medium text-gray-800">${formatCurrency(totals.vatOnServices)}</span></div> <div class="border-t my-2 border-indigo-200"></div> <div class="flex justify-between text-xl p-2 bg-indigo-50 rounded-md"><span class="font-bold text-indigo-800">Grand Total:</span> <span class="font-extrabold text-indigo-900">${formatCurrency(totals.grandTotal)}</span></div> `; 
                document.getElementById('landed-cost-output').innerHTML = ` <div class="flex justify-between"><span class="text-gray-600">Commercial Value (ZAR):</span> <span class="font-medium text-gray-800">${formatCurrency(landed.commercialValueZAR)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Customs Duty:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.dutyAmount)}</span></div> <div class="flex justify-between"><span class="text-gray-600">VAT on Goods:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.vatOnGoods)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Total Clearing Costs:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.totalClearingCosts)}</span></div> <div class="border-t my-2"></div> <div class="flex justify-between text-base"><span class="font-semibold text-gray-700">Total Landed Cost:</span> <span class="font-bold text-gray-900">${formatCurrency(landed.totalLandedCost)}</span></div> <div class="border-t my-2 border-green-200"></div> <div class="flex justify-between text-xl p-2 bg-green-50 rounded-md"><span class="font-bold text-green-800">Cost per Kg:</span> <span class="font-extrabold text-green-900">${formatCurrency(landed.costPerKg)}</span></div> `; 
                
                // Update pricing strategy
                setTimeout(() => this.updatePricingStrategy(), 10);
            },
            generateInputs() { 
                try {
                    // Generate Shipment Details
                    const shipmentContainer = document.querySelector('#shipment-details .grid');
                    if (shipmentContainer) {
                        shipmentContainer.innerHTML = Object.entries(state.shipmentDetails).map(([key, item]) => { 
                            let fieldHtml = `<label class="block text-sm font-medium text-gray-600 mb-1">${item.label}</label>`; 
                            if (item.type === 'select') { 
                                fieldHtml += `<select id="sd-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800"> ${item.options.map(opt => `<option value="${opt}" ${opt === item.value ? 'selected' : ''}>${opt}</option>`).join('')} </select>`; 
                            } else { 
                                fieldHtml += `<input type="text" id="sd-${key}" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">`; 
                            } 
                            return `<div>${fieldHtml}</div>`; 
                        }).join(''); 
                    }
                    
                    // Generate Origin Charges (NEW SECTION)
                    const originContainer = document.getElementById('origin-charges-section');
                    if (originContainer) {
                        if (state.originCharges && state.originCharges.items && state.originCharges.currencyOptions) {
                            try {
                                const originFieldsHtml = Object.entries(state.originCharges.items).map(([itemKey, item]) => { 
                                    const isKg = item.currency === 'kg';
                                    const isPercent = item.currency === 'percent'; 
                                    return `<div> 
                                        <label class="block text-sm font-medium text-gray-600 mb-1">${item.label || itemKey}</label> 
                                        <div class="flex items-center"> 
                                            <input type="number" step="0.01" id="origin-${itemKey}-value" value="${item.value || '0'}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" placeholder="0.00" ${isKg ? 'oninput="updateCommercialValue()"' : 'oninput="updateCommercialValue()"'}> 
                                            ${isKg ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">kg</span>` : 
                                              isPercent ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">%</span>` : 
                                              `<select id="origin-${itemKey}-currency" class="px-3 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md focus:outline-none" onchange="updateCommercialValue()"> ${state.originCharges.currencyOptions.map(c => `<option value="${c.toLowerCase()}" ${c.toLowerCase() === (item.currency || 'usd') ? 'selected' : ''}>${c}</option>`).join('')} </select>`} 
                                        </div> 
                                    </div>`; 
                                }).join('');
                                originContainer.innerHTML = originFieldsHtml;
                                console.log('‚úÖ Origin charges section generated successfully');
                                
                                // Initialize commercial value calculation
                                setTimeout(() => {
                                    if (window.updateCommercialValue) {
                                        updateCommercialValue();
                                    }
                                }, 100);
                            } catch (error) {
                                console.error('‚ùå Error generating origin charges:', error);
                                originContainer.innerHTML = '<div class="text-red-500 p-4">Error loading origin charges section</div>';
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Origin charges not properly configured in state');
                            originContainer.innerHTML = '<div class="text-yellow-600 p-4">Origin charges configuration missing</div>';
                        }
                    } else {
                        console.error('‚ùå Origin charges container not found');
                    }
                    
                    // Generate remaining Cost Sections (excluding origin which is now separate)
                    const costContainer = document.getElementById('cost-sections');
                    if (costContainer) {
                        costContainer.innerHTML = Object.entries(state.costs).map(([sectionKey, section]) => { 
                            const fieldsHtml = Object.entries(section.items).map(([itemKey, item]) => { 
                                const isPercent = item.currency === 'percent'; 
                                return `<div> 
                                    <label class="block text-sm font-medium text-gray-600 mb-1">${item.label}</label> 
                                    <div class="flex items-center"> 
                                        <input type="number" step="0.01" id="cost-${sectionKey}-${itemKey}-value" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" placeholder="0.00"> 
                                        ${isPercent ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">%</span>` : `<select id="cost-${sectionKey}-${itemKey}-currency" class="px-3 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md focus:outline-none"> ${section.currencyOptions.map(c => `<option value="${c.toLowerCase()}" ${c.toLowerCase() === item.currency ? 'selected' : ''}>${c}</option>`).join('')} </select>`} 
                                    </div> 
                                </div>`; 
                            }).join(''); 
                            return `<div class="bg-white p-4 rounded-lg shadow-sm mb-6"> 
                                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">${section.title}</h3> 
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div> 
                            </div>`; 
                        }).join(''); 
                    }
                    
                    // Generate Landed Cost inputs
                    const landedContainer = document.getElementById('landed-cost-inputs');
                    if (landedContainer) {
                        landedContainer.innerHTML = Object.entries(state.landedCost).map(([key, item]) => `<div> 
                            <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label> 
                            <input type="number" step="0.01" id="lc-${key}" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800"> 
                        </div>`).join(''); 
                    }
                    
                    // Generate Pricing Strategy inputs
                    const pricingContainer = document.getElementById('pricing-strategy-inputs');
                    if (pricingContainer) {
                        const pricingFields = Object.entries(state.pricingStrategy).map(([key, item]) => {
                            if (key === 'pricingMethod') {
                                return `<div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="ps-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updatePricingMethod(this.value)">
                                        <option value="margin" ${item.value === 'margin' ? 'selected' : ''}>Margin % (Profit Target)</option>
                                        <option value="markup" ${item.value === 'markup' ? 'selected' : ''}>Markup % (Cost Plus)</option>
                                        <option value="manual" ${item.value === 'manual' ? 'selected' : ''}>Manual Sell Price</option>
                                    </select>
                                </div>`;
                            } else if (key === 'targetCurrency') {
                                return `<div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="ps-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updatePricingStrategy()">
                                        <option value="zar" ${item.value === 'zar' ? 'selected' : ''}>ZAR (South African Rand)</option>
                                        <option value="usd" ${item.value === 'usd' ? 'selected' : ''}>USD (US Dollar)</option>
                                        <option value="eur" ${item.value === 'eur' ? 'selected' : ''}>EUR (Euro)</option>
                                    </select>
                                </div>`;
                            } else {
                                const isConditional = (key === 'marginPercent' && state.pricingStrategy.pricingMethod.value !== 'margin') ||
                                                    (key === 'markupPercent' && state.pricingStrategy.pricingMethod.value !== 'markup') ||
                                                    (key === 'manualSellPrice' && state.pricingStrategy.pricingMethod.value !== 'manual');
                                                    
                                return `<div ${isConditional ? 'style="display: none;"' : ''} id="ps-${key}-container">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <input type="number" step="0.01" id="ps-${key}" value="${item.value}" 
                                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" 
                                           oninput="App.updatePricingStrategy()" placeholder="Enter ${item.label.toLowerCase()}">
                                </div>`;
                            }
                        }).join('');
                        
                        pricingContainer.innerHTML = pricingFields;
                        console.log('‚úÖ Pricing strategy inputs generated');
                    }
                } catch (error) {
                    console.error('Error in generateInputs:', error);
                    showToast('Error generating form inputs', 'error');
                }
            },
            listenForQuotes() { 
                if (!this.quotesCollection) return; 
                const listContainer = document.getElementById('saved-quotes-list'); 
                onSnapshot(query(this.quotesCollection), (snapshot) => { 
                    if (snapshot.empty) { 
                        listContainer.innerHTML = '<p class="text-gray-500">No quotes saved yet.</p>'; 
                        return; 
                    } 
                    const quotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 
                    listContainer.innerHTML = quotes.map(quote => 
                        `<div class="quote-card flex items-center justify-between p-4">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">üì¶ ${quote.details.supplierName || 'No Supplier'}</p>
                                <p class="text-sm text-gray-500">Quote #${quote.quoteNumber} ‚Ä¢ ${new Date(quote.createdAt).toLocaleDateString('en-GB')} <span class="text-green-500 font-medium">(Shared)</span></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="App.loadQuote('${quote.id}')" class="btn btn-primary text-white font-semibold py-2 px-4 rounded-lg">
                                    üìÇ Load
                                </button>
                                <button onclick="App.deleteQuote('${quote.id}')" class="btn btn-danger text-white font-semibold py-2 px-3 rounded-lg" title="Delete Quote">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>`
                    ).join(''); 
                }); 
            },
            listenForCostRequests() { 
                if(!this.requestsCollection) return; 
                const listContainer = document.getElementById('cost-requests-list'); 
                onSnapshot(query(this.requestsCollection), (snapshot) => { 
                    if (snapshot.empty) { 
                        listContainer.innerHTML = '<p class="text-gray-500">No pending requests.</p>'; 
                        return; 
                    } 
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 
                    listContainer.innerHTML = requests.map(req => 
                        `<div class="request-card p-4"> 
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">üè¢ ${req.clientName}</p> 
                                    <p class="text-sm text-gray-600">üì§ Request from ${req.requesterName} on ${req.createdAt ? new Date(req.createdAt.seconds * 1000).toLocaleDateString('en-GB') : 'N/A'}</p> 
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 text-sm">
                                        <p><b>üåç From:</b> ${req.origin}</p>
                                        <p><b>üéØ To:</b> ${req.destination}</p>
                                        ${req.totalWeight ? `<p><b>‚öñÔ∏è Weight:</b> ${req.totalWeight} kg</p>` : ''}
                                        ${req.incoterm ? `<p><b>üìã Incoterm:</b> ${req.incoterm}</p>` : ''}
                                        ${req.totalCost ? `<p><b>üí∞ Cost:</b> ${req.totalCost} ${req.currency || ''}</p>` : ''}
                                    </div>
                                    <p class="text-sm mt-2"><b>üì¶ Commodity:</b> ${req.commodity}</p> 
                                    ${req.notes ? `<p class="text-sm mt-2 italic text-gray-600"><b>üìù Notes:</b> ${req.notes}</p>` : ''}
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <button onclick="App.generateCostFromRequest('${req.id}')" class="btn btn-success text-white font-semibold py-2 px-4 rounded-lg">
                                        üöÄ Generate Cost
                                    </button>
                                    <button onclick="App.deleteCostRequest('${req.id}')" class="btn btn-danger text-white font-semibold py-2 px-3 rounded-lg" title="Delete Request">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        </div>`
                    ).join(''); 
                }); 
            },
            
            async deleteQuote(quoteId) {
                if (!this.db) {
                    showToast('Database not available', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(this.db, "quotes", quoteId));
                    showToast('Quote deleted successfully! üóëÔ∏è', 'success');
                } catch (error) {
                    console.error("Error deleting quote: ", error);
                    showToast("Failed to delete quote. Please try again.", 'error');
                }
            },
            
            async deleteCostRequest(requestId) {
                if (!this.db) {
                    showToast('Database not available', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(this.db, "cost_requests", requestId));
                    showToast('Request deleted successfully! üóëÔ∏è', 'success');
                } catch (error) {
                    console.error("Error deleting request: ", error);
                    showToast("Failed to delete request. Please try again.", 'error');
                }
            },
            
            deleteLocalQuote(quoteId) {
                if (!confirm('Are you sure you want to delete this local quote? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    const filteredQuotes = quotes.filter(q => q.id !== quoteId);
                    localStorage.setItem('synerore_quotes', JSON.stringify(filteredQuotes));
                    this.loadLocalQuotes();
                    showToast('Local quote deleted successfully! üóëÔ∏è', 'success');
                } catch (error) {
                    console.error('Error deleting local quote:', error);
                    showToast('Failed to delete local quote.', 'error');
                }
            },
            
            async generateCostFromRequest(requestId) {
                if (!this.db) {
                    alert('Database not available');
                    return;
                }
                
                try {
                    console.log('Loading cost request with ID:', requestId);
                    const requestDoc = await getDoc(doc(this.db, "cost_requests", requestId));
                    
                    if (requestDoc.exists()) {
                        const requestData = requestDoc.data();
                        console.log('Request data loaded:', requestData);
                        
                        // Pre-populate form with request data
                        const supplierEl = document.getElementById('sd-supplierName');
                        const polEl = document.getElementById('sd-pol');
                        const podEl = document.getElementById('sd-pod');
                        const commodityEl = document.getElementById('sd-commodity');
                        const incotermEl = document.getElementById('sd-incoterm');
                        const totalKgEl = document.getElementById('lc-totalKg');
                        const commercialValueEl = document.getElementById('lc-commercialInvoiceValue');
                        
                        if (supplierEl) supplierEl.value = requestData.clientName || '';
                        if (polEl) polEl.value = requestData.origin || '';
                        if (podEl) podEl.value = requestData.destination || '';
                        if (commodityEl) commodityEl.value = requestData.commodity || '';
                        if (incotermEl && requestData.incoterm) incotermEl.value = requestData.incoterm;
                        if (totalKgEl && requestData.totalWeight) totalKgEl.value = requestData.totalWeight;
                        if (commercialValueEl && requestData.totalCost) commercialValueEl.value = requestData.totalCost;
                        
                        // Switch to cost generator page
                        this.switchPage('cost-generator-page');
                        this.updateDisplay();
                        
                        showToast(`Cost generation started for ${requestData.clientName} üöÄ`, 'success');
                        
                    } else {
                        alert("Request not found.");
                    }
                } catch (error) {
                    console.error("Error loading cost request: ", error);
                    alert("Error loading request: " + error.message);
                }
            },
            
            async submitCostRequest(e) { 
                e.preventDefault(); 
                if(!this.requestsCollection) return; 
                const button = e.target.querySelector('button[type="submit"]'); 
                button.disabled = true; 
                button.textContent = 'Submitting...'; 
                try { 
                    await addDoc(this.requestsCollection, { 
                        requesterName: document.getElementById('req-name').value, 
                        requesterEmail: document.getElementById('req-email').value, 
                        clientName: document.getElementById('req-client').value, 
                        origin: document.getElementById('req-origin').value, 
                        destination: document.getElementById('req-destination').value, 
                        commodity: document.getElementById('req-commodity').value, 
                        notes: document.getElementById('req-notes').value,
                        totalWeight: document.getElementById('req-weight').value,
                        incoterm: document.getElementById('req-incoterm').value,
                        totalCost: document.getElementById('req-cost').value,
                        currency: document.getElementById('req-currency').value,
                        status: 'pending', 
                        createdAt: serverTimestamp() 
                    }); 
                    showToast('Request submitted successfully! üìã It will appear in Pending Quotes.', 'success'); 
                    e.target.reset(); 
                } catch (error) { 
                    console.error("Error submitting request: ", error); 
                    alert("Error submitting request: " + error.message);
                } finally { 
                    button.disabled = false; 
                    button.textContent = 'Submit Request'; 
                } 
            },
        };

        // --- INITIALIZATION ---
        window.App = App; // Make App globally accessible
        
        // Safe initialization with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Verify required DOM elements exist
                const requiredElements = [
                    'dashboard-page',
                    'cost-generator-page', 
                    'cost-request-page',
                    'shipment-details',
                    'origin-charges-section',
                    'exchange-rates',
                    'cost-sections'
                ];
                
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.error('Missing required DOM elements:', missingElements);
                    document.body.innerHTML = `
                        <div style="padding: 20px; font-family: Arial; color: red;">
                            <h2>Loading Error</h2>
                            <p>Missing DOM elements: ${missingElements.join(', ')}</p>
                            <p>Please refresh the page or contact support.</p>
                        </div>
                    `;
                    return;
                }
                
                // Validate state object
                if (!state || !state.shipmentDetails || !state.originCharges || !state.costs) {
                    console.error('State object not properly initialized:', state);
                    document.body.innerHTML = `
                        <div style="padding: 20px; font-family: Arial; color: red;">
                            <h2>Configuration Error</h2>
                            <p>Application state not properly initialized.</p>
                            <p>Please refresh the page.</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('‚úÖ All required elements found, initializing app...');
                App.init();
                
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; font-family: Arial; color: red;">
                        <h2>Initialization Error</h2>
                        <p>Error: ${error.message}</p>
                        <p>Please refresh the page or check the browser console for details.</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 10px; background: #007cba; color: white; border: none; cursor: pointer;">
                            üîÑ Refresh Page
                        </button>
                    </div>
                `;
            }
        });

    </script>
</body>
</html>
