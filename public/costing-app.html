<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nerva ERP - Universal Costing Platform [UPDATED]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Force cache bust -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        }
        
        .sidebar-link { 
            transition: all 0.2s ease;
            position: relative;
        }
        .sidebar-link:hover { 
            background-color: rgba(59, 130, 246, 0.1);
            transform: translateX(4px);
        }
        .sidebar-link.active { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        /* Nerva ERP Navigation Styling */
        .nerva-nav-item {
            transition: all 0.2s ease;
            border-radius: 6px;
        }
        .nerva-nav-item:hover {
            background-color: #f3f4f6;
            transform: translateX(2px);
        }
        .nerva-nav-item.active {
            background-color: #e0e7ff;
            color: #4338ca;
            font-weight: 600;
        }
        .nerva-nav-item svg {
            transition: color 0.2s ease;
        }
        .nerva-nav-item:hover svg {
            color: #6b7280;
        }
        .nerva-nav-item.active svg {
            color: #4338ca;
        }
        
        .page { display: none; }
        .page.active { display: block; }
        
        /* Enhanced Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            border: 1px solid var(--gray-200);
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        
        /* Enhanced Buttons */
        .btn {
            transition: all 0.2s ease;
            font-weight: 600;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1e40af 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, var(--secondary-dark) 0%, #047857 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--success-color);
            z-index: 1000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast.error {
            border-left-color: var(--error-color);
        }
        .toast.warning {
            border-left-color: var(--warning-color);
        }
        
        /* Enhanced Form Elements */
        .form-input {
            transition: all 0.2s ease;
            border-radius: 8px;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: scale(1.01);
        }
        
        /* Section Headers with Icons */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-200);
        }
        
        /* Progress Indicators */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: width 0.3s ease;
        }
        
        /* Enhanced Header */
        .app-header {
            background: linear-gradient(135deg, white 0%, var(--gray-50) 100%);
            border-bottom: 1px solid var(--gray-200);
        }
        
        /* Quote Cards */
        .quote-card {
            background: linear-gradient(135deg, #f8fafc 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .quote-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        /* Pending Request Cards */
        .request-card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Mobile Layout */
            .flex.h-screen {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            /* Mobile Sidebar */
            aside {
                width: 100% !important;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                z-index: 50;
                transition: left 0.3s ease;
            }
            aside.mobile-open {
                left: 0;
            }
            
            /* Mobile Overlay */
            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40;
                display: none;
            }
            .mobile-overlay.show {
                display: block;
            }
            
            /* Mobile Header */
            .app-header {
                position: relative;
                z-index: 40;
            }
            .app-header .flex {
                padding: 12px 16px;
            }
            #page-title {
                font-size: 1.25rem;
            }
            
            /* Mobile Menu Button */
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--gray-800);
                cursor: pointer;
            }
            
            /* Mobile Main Content */
            .flex-1.flex.flex-col.overflow-hidden {
                flex: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: visible !important;
            }
            
            main {
                padding: 16px !important;
                margin-top: 0;
                flex: 1 !important;
                overflow: visible !important;
                height: auto !important;
                min-height: calc(100vh - 80px) !important;
            }
            
            /* Ensure pages are visible */
            .page {
                display: none;
                width: 100%;
                height: auto;
                min-height: 300px;
            }
            .page.active {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Force dashboard to be visible on initial load */
            #dashboard-page {
                display: block;
            }
            #dashboard-page.active {
                display: block !important;
            }
            
            /* Mobile Grid Layouts */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Mobile Dashboard Fix */
            #saved-quotes-list, #cost-requests-list {
                min-height: 100px !important;
                background: white !important;
                padding: 16px !important;
                border-radius: 8px !important;
                margin-bottom: 16px !important;
            }
            
            #saved-quotes-list:empty::before {
                content: "No saved quotes yet. Create your first quote in the Cost Generator!";
                color: #6b7280;
                font-style: italic;
            }
            
            #cost-requests-list:empty::before {
                content: "No pending requests. Submit a request to get started!";
                color: #6b7280;
                font-style: italic;
            }
            
            /* Mobile Cards */
            .card, .quote-card, .request-card, .template-card {
                margin-bottom: 16px;
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            
            .template-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }
            
            /* Mobile Form Elements */
            .form-input, select, textarea, input {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 12px !important;
            }
            
            /* Mobile Buttons */
            .btn {
                padding: 12px 16px !important;
                font-size: 14px;
                min-height: 44px; /* Touch target size */
            }
            
            /* Mobile Quote/Request Cards */
            .quote-card, .request-card {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px;
            }
            .quote-card .flex-1, .request-card .flex-1 {
                margin-bottom: 12px;
            }
            .quote-card .flex.items-center, .request-card .flex.items-center {
                justify-content: stretch;
                gap: 8px;
            }
            .quote-card .btn, .request-card .btn {
                flex: 1;
                justify-content: center;
            }
            
            /* Mobile Typography */
            h1, h2, h3 {
                font-size: 1.1rem !important;
                line-height: 1.4;
            }
            
            /* Mobile Spacing */
            .space-y-6 > * + * {
                margin-top: 16px !important;
            }
            .space-y-4 > * + * {
                margin-top: 12px !important;
            }
            .space-y-2 > * + * {
                margin-top: 8px !important;
            }
            
            /* Mobile Toast Notifications */
            .toast {
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-100px);
            }
            .toast.show {
                transform: translateY(0);
            }
            
            /* Mobile Cost Generator Layout */
            .lg\\:col-span-2 {
                grid-column: span 1 !important;
            }
            .lg\\:col-span-1 {
                grid-column: span 1 !important;
            }
            
            /* Mobile Sticky Elements */
            .sticky {
                position: relative !important;
                top: auto !important;
            }
            
            /* Mobile Hidden Elements */
            .md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            .md\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Tablet Styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            aside {
                width: 200px;
            }
            main {
                padding: 24px;
            }
            .grid {
                gap: 20px;
            }
        }
        
        /* Desktop Hidden Mobile Menu */
        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Welcome/Login Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-50 bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 flex items-center justify-center">
        <div class="absolute inset-0 bg-black opacity-20"></div>
        
        <!-- Animated Background -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute top-0 left-1/4 w-96 h-96 bg-blue-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
            <div class="absolute top-0 right-1/4 w-96 h-96 bg-purple-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-2000"></div>
            <div class="absolute bottom-0 left-1/3 w-96 h-96 bg-indigo-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse animation-delay-4000"></div>
        </div>

        <!-- Auth Container -->
        <div class="relative z-10 w-full max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                
                <!-- Welcome Section -->
                <div class="text-white space-y-6">
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-xl flex items-center justify-center">
                                <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M9 1L5 3l4 2 4-2-4-2z" />
                                </svg>
                            </div>
                            <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                                Nerva ERP
                            </h1>
                        </div>
                        <h2 class="text-3xl font-bold leading-tight">
                            The Ultimate <span class="text-blue-300">Shipping & Logistics</span> Platform
                        </h2>
                        <p class="text-xl text-blue-100 leading-relaxed">
                            Complete cost calculation, live vessel schedules, shipment tracking, and quote management - all in one powerful platform.
                        </p>
                    </div>

                    <!-- Features Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                        <div class="flex items-center space-x-3 p-3 rounded-lg bg-white bg-opacity-10 backdrop-blur-sm">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <span class="font-medium">Smart Cost Calculator</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 rounded-lg bg-white bg-opacity-10 backdrop-blur-sm">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 012 0v4h4V3a1 1 0 012 0v4h2a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2z" />
                                </svg>
                            </div>
                            <span class="font-medium">Live Vessel Schedules</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 rounded-lg bg-white bg-opacity-10 backdrop-blur-sm">
                            <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                </svg>
                            </div>
                            <span class="font-medium">Real-Time Tracking</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 rounded-lg bg-white bg-opacity-10 backdrop-blur-sm">
                            <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                            </div>
                            <span class="font-medium">Advanced Analytics</span>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-6 mt-8 p-6 rounded-xl bg-white bg-opacity-10 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-300">25+</div>
                            <div class="text-sm text-blue-100">Shipping Lines</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-300">11K+</div>
                            <div class="text-sm text-blue-100">HS Codes</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-300">Live</div>
                            <div class="text-sm text-blue-100">Updates</div>
                        </div>
                    </div>
                </div>

                <!-- Login Section -->
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-auto w-full">
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Welcome Back</h3>
                        <p class="text-gray-600">Sign in to access your dashboard</p>
                    </div>

                    <!-- Auth Tabs -->
                    <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                        <button id="login-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-blue-600 shadow-sm">
                            Sign In
                        </button>
                        <button id="register-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-700">
                            Sign Up
                        </button>
                    </div>

                    <!-- Login Form -->
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="your@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="login-password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="••••••••">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-600">Remember me</span>
                            </label>
                            <button type="button" class="text-sm text-blue-600 hover:text-blue-800">
                                Forgot password?
                            </button>
                        </div>
                        <button type="submit" id="login-btn" 
                                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Sign In
                        </button>
                    </form>

                    <!-- Register Form (Hidden by default) -->
                    <form id="register-form" class="space-y-4" style="display: none;">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                <input type="text" id="register-firstname" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                       placeholder="John">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                <input type="text" id="register-lastname" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                       placeholder="Doe">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                            <input type="text" id="register-company" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="Your Company Ltd">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="register-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="your@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="register-password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="••••••••">
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" required class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-600">I agree to the Terms of Service and Privacy Policy</span>
                            </label>
                        </div>
                        <button type="submit" id="register-btn" 
                                class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-lg font-medium hover:from-green-700 hover:to-blue-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Create Account
                        </button>
                    </form>

                    <!-- Social Login -->
                    <div class="mt-6">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">Or continue with</span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-3">
                            <button type="button" id="google-login-btn" 
                                    class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Google
                            </button>
                            <button type="button" 
                                    class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.174-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.098.119.112.223.083.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.402.165C5.6 16.881 4.852 14.842 4.852 11.619c0-3.4 2.467-6.119 7.132-6.119 3.739 0 6.645 2.662 6.645 6.218 0 3.709-2.336 6.694-5.577 6.694-1.092 0-2.117-.568-2.463-1.245l-.669 2.551c-.24.921-.89 2.077-1.323 2.788C8.974 23.761 10.409 24.001 12.017 24.001 18.624 24.001 23.999 18.634 23.999 12.013 23.999 5.392 18.624.025 12.017.025z"/>
                                </svg>
                                Microsoft
                            </button>
                        </div>
                    </div>

                    <!-- Demo Access -->
                    <div class="mt-6 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200">
                        <div class="text-center">
                            <p class="text-sm text-orange-800 mb-2">🚀 Want to try it first?</p>
                            <button id="demo-access-btn" 
                                    class="text-sm bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-4 py-2 rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all">
                                Access Demo Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen bg-gray-200">
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- Nerva ERP Branding -->
            <div class="flex items-center gap-x-3 p-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-lg">N</span>
                </div>
                <span class="text-xl font-semibold text-gray-900">Nerva ERP</span>
            </div>
            
            <!-- Main Navigation -->
            <nav id="sidebar-nav" class="flex-1 px-3 py-4 space-y-1">
                <a href="#dashboard" data-page="dashboard-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v14H8V5z" />
                    </svg>
                    Dashboard
                </a>
                
                <a href="#generator" data-page="cost-generator-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M9 1L5 3l4 2 4-2-4-2z" />
                    </svg>
                    Cost Generator
                </a>
                
                <a href="#request" data-page="cost-request-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    Cost Request
                </a>
                
                <a href="#tracking" data-page="tracking-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Shipment Tracking
                </a>
                
                <a href="#schedules" data-page="schedules-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 012 0v4h4V3a1 1 0 012 0v4h2a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11H8v2h8v-2zM8 15h4v2H8v-2z" />
                    </svg>
                    Live Schedules
                </a>
                
                <a href="#avatar" data-page="avatar-page" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Supply Chain Expert
                </a>
            </nav>
            
            <!-- Settings at Bottom -->
            <div class="border-t border-gray-200 p-3">
                <a href="#" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="app-header shadow-md">
                 <div class="flex items-center justify-between px-6 py-4">
                    <div class="flex items-center gap-x-3">
                        <button class="mobile-menu-btn" style="display: none;" onclick="toggleMobileMenu()">☰</button>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-800">📊 Dashboard</h1>
                    </div>
                    <div id="header-buttons" class="flex items-center gap-x-2">
                        <!-- Buttons will be dynamically added here -->
                    </div>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page">
                    <!-- Quick Start Templates Section -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">
                                🚀 Quick Start Templates
                            </h2>
                            <button 
                                onclick="App.showAllTemplates()" 
                                class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                            >
                                View All Templates →
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="template-grid">
                            <!-- Templates will be populated here -->
                        </div>
                    </div>

                    <!-- Enhanced Search Section -->
                    <div class="mb-6">
                        <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-800">📋 Quote Management</h3>
                            <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                                <input 
                                    type="text" 
                                    id="quote-search" 
                                    placeholder="Search quotes by supplier, route, or commodity..." 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full md:w-80"
                                    oninput="App.filterQuotes(this.value)"
                                >
                                <select 
                                    id="quote-filter" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    onchange="App.filterQuotes()"
                                >
                                    <option value="">All Quotes</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="high-value">High Value (>R100k)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-3">Saved Quotes</h3>
                                <span id="quotes-count" class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded-full">0</span>
                            </div>
                            <div id="saved-quotes-list" class="space-y-3"></div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 border-b pb-3">Pending Requests</h3>
                                <span id="requests-count" class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded-full">0</span>
                            </div>
                            <div id="cost-requests-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Cost Generator Page -->
                <div id="cost-generator-page" class="page">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div id="shipment-details" class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Shipment Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">🚢 Origin Charges</h3><div id="origin-charges-section" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Exchange Rates (to ZAR)</h3><div id="exchange-rates" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
                            <div id="cost-sections"></div>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Costing Summary</h3><div id="summary-output" class="space-y-2 text-sm"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Landed Cost Calculator</h3><div id="landed-cost-inputs" class="grid grid-cols-1 gap-4 mb-4"></div><div id="landed-cost-output" class="space-y-2 text-sm"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">💰 Pricing Strategy</h3><div id="pricing-strategy-inputs" class="grid grid-cols-1 gap-4 mb-4"></div><div id="pricing-strategy-output" class="space-y-2 text-sm"></div></div>
                            <div class="bg-white p-4 rounded-lg shadow-sm"><h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">📊 Cost Splitting</h3><div id="cost-splitting-inputs" class="grid grid-cols-1 gap-4 mb-4"></div><div id="cost-splitting-output" class="space-y-2 text-sm"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Cost Request Page -->
                <div id="cost-request-page" class="page">
                    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-sm">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-3 mb-6">Submit a Costing Request</h2>
                        <form id="cost-request-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Your Name</label><input type="text" id="req-name" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Your Email</label><input type="email" id="req-email" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">Supplier Name</label><select id="req-client" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Supplier</option><option value="Qida Chemical Co. Ltd">Qida Chemical Co. Ltd</option><option value="AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.">AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.</option><option value="SACCO S.R.L">SACCO S.R.L</option><option value="Futura Ingredients">Futura Ingredients</option><option value="MARCEL CARRAGEENAN">MARCEL CARRAGEENAN</option><option value="AB Mauri">AB Mauri</option><option value="KMC">KMC</option><option value="Ornua Co-operative Limeted">Ornua Co-operative Limeted</option><option value="Halavet Gida Sanayi Ve Ticaret A.S">Halavet Gida Sanayi Ve Ticaret A.S</option><option value="Delta Iris">Delta Iris</option><option value="Tristar Global">Tristar Global</option></select></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Origin</label><input type="text" id="req-origin" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Destination</label><input type="text" id="req-destination" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Total Weight (kg)</label><input type="number" step="0.01" id="req-weight" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Incoterms</label><select id="req-incoterm" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Incoterm</option><option value="EXW">EXW</option><option value="FOB">FOB</option><option value="CFR">CFR</option><option value="CIF">CIF</option><option value="DAP">DAP</option><option value="DDP">DDP</option></select></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">Total Cost</label><input type="number" step="0.01" id="req-cost" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Currency</label><select id="req-currency" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"><option value="">Select Currency</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option><option value="ZAR">ZAR</option></select></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">Commodity Description</label><textarea id="req-commodity" rows="3" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div><label class="block text-sm font-medium text-gray-700">Additional Notes or Special Instructions</label><textarea id="req-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div class="text-right"><button type="submit" class="btn btn-primary text-white font-bold py-3 px-6 rounded-lg">📤 Submit Request</button></div>
                        </form>
                    </div>
                </div>

                <!-- Shipment Tracking Page -->
                <div id="tracking-page" class="page">
                    <div class="max-w-7xl mx-auto space-y-6">
                        <!-- Header -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">🚢 Shipment Tracking</h2>
                            <p class="text-gray-600">Track your shipments across all major shipping lines in real-time</p>
                        </div>

                        <!-- Quick Track -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Quick Track</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Line</label>
                                    <select id="tracking-carrier" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="">Select Carrier</option>
                                        <option value="msc">MSC</option>
                                        <option value="maersk">Maersk</option>
                                        <option value="cma-cgm">CMA CGM</option>
                                        <option value="hapag-lloyd">Hapag-Lloyd</option>
                                        <option value="cosco">COSCO</option>
                                        <option value="evergreen">Evergreen</option>
                                        <option value="oocl">OOCL</option>
                                        <option value="yang-ming">Yang Ming</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Container/BL Number</label>
                                    <input type="text" id="tracking-number" placeholder="Enter container or BL number" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="flex items-end">
                                    <button id="track-shipment-btn" class="btn bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 w-full">
                                        🔍 Track Shipment
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tracking Templates -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Popular Routes & Templates</h3>
                            <div id="tracking-templates-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Templates will be populated here -->
                            </div>
                        </div>

                        <!-- Active Shipments -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Active Shipments</h3>
                            <div id="active-shipments" class="space-y-4">
                                <!-- Active shipments will be populated here -->
                            </div>
                        </div>

                        <!-- Tracking Results -->
                        <div id="tracking-results" class="bg-white p-6 rounded-lg shadow-sm" style="display: none;">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Tracking Results</h3>
                            <div id="tracking-details" class="space-y-4">
                                <!-- Tracking details will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Vessel Schedules Page -->
                <div id="schedules-page" class="page">
                    <div class="max-w-7xl mx-auto space-y-6">
                        <!-- Header -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">🚢 Live Vessel Schedules</h2>
                            <p class="text-gray-600">Real-time sailing schedules from all major shipping lines worldwide</p>
                        </div>

                        <!-- Search Interface -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Search Schedules</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Port</label>
                                    <select id="schedule-origin" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="">Select Origin Port</option>
                                        <option value="CNSHA">Shanghai, China</option>
                                        <option value="CNNGB">Ningbo, China</option>
                                        <option value="CNQIN">Qingdao, China</option>
                                        <option value="SGSIN">Singapore</option>
                                        <option value="HKHKG">Hong Kong</option>
                                        <option value="KRPUS">Busan, South Korea</option>
                                        <option value="JPYOK">Yokohama, Japan</option>
                                        <option value="NLRTM">Rotterdam, Netherlands</option>
                                        <option value="DEHAM">Hamburg, Germany</option>
                                        <option value="GBFXT">Felixstowe, UK</option>
                                        <option value="USNYC">New York, USA</option>
                                        <option value="USLAX">Los Angeles, USA</option>
                                        <option value="USBAL">Baltimore, USA</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">To Port</label>
                                    <select id="schedule-destination" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="">Select Destination Port</option>
                                        <option value="ZADUR">Durban, South Africa</option>
                                        <option value="ZACPT">Cape Town, South Africa</option>
                                        <option value="ZAELZ">Port Elizabeth, South Africa</option>
                                        <option value="ZARIG">Richards Bay, South Africa</option>
                                        <option value="ZALAD">Ladysmith, South Africa</option>
                                        <option value="MZMPM">Maputo, Mozambique</option>
                                        <option value="NAWVI">Walvis Bay, Namibia</option>
                                        <option value="AOLAD">Luanda, Angola</option>
                                        <option value="THLCH">Laem Chabang, Thailand</option>
                                        <option value="INVTZ">JNPT, India</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                    <select id="schedule-timeframe" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="7">Next 7 days</option>
                                        <option value="14">Next 2 weeks</option>
                                        <option value="30">Next month</option>
                                        <option value="60">Next 2 months</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="search-schedules-btn" class="btn bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 w-full">
                                        🔍 Search Schedules
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filter Options -->
                            <div class="border-t pt-4">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Filter by Shipping Line</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button class="carrier-filter active px-3 py-1 text-xs rounded-full bg-blue-100 text-blue-800" data-carrier="all">All Lines</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="msc">MSC</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="maersk">Maersk</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="cma-cgm">CMA CGM</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="hapag-lloyd">Hapag-Lloyd</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="cosco">COSCO</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="evergreen">Evergreen</button>
                                    <button class="carrier-filter px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-800" data-carrier="oocl">OOCL</button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Section -->
                        <div id="schedule-results" class="bg-white p-6 rounded-lg shadow-sm" style="display: none;">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-700">Available Schedules</h3>
                                <span id="results-count" class="text-sm text-gray-500"></span>
                            </div>
                            <div id="schedule-list" class="space-y-4">
                                <!-- Schedule results will be populated here -->
                            </div>
                        </div>

                        <!-- Popular Routes -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Popular Routes</h3>
                            <div id="popular-routes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Popular routes will be populated here -->
                            </div>
                        </div>

                        <!-- Live Updates -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">Live Schedule Updates</h3>
                            <div id="live-updates" class="space-y-3">
                                <!-- Live updates will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Supply Chain Expert Page -->
                <div id="avatar-page" class="page">
                    <div class="w-full h-full flex">
                        <!-- Visual Design Area -->
                        <div class="w-2/3 h-full relative bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 rounded-lg overflow-hidden">
                            <!-- Background Pattern -->
                            <div class="absolute inset-0 opacity-10">
                                <div class="absolute top-0 left-0 w-full h-full" style="background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><defs><pattern id=\"grid\" width=\"10\" height=\"10\" patternUnits=\"userSpaceOnUse\"><path d=\"M 10 0 L 0 0 0 10\" fill=\"none\" stroke=\"%23ffffff\" stroke-width=\"0.5\"/></pattern></defs><rect width=\"100\" height=\"100\" fill=\"url(%23grid)\"/></svg>');"></div>
                            </div>
                            
                            <!-- Floating Elements -->
                            <div class="absolute inset-0">
                                <!-- Animated Containers -->
                                <div class="absolute top-20 left-20 w-16 h-12 bg-orange-500 rounded shadow-lg animate-bounce" style="animation-delay: 0s; animation-duration: 3s;">
                                    <div class="w-full h-full bg-gradient-to-r from-orange-400 to-orange-600 rounded flex items-center justify-center">
                                        <span class="text-white text-xs font-bold">20ft</span>
                                    </div>
                                </div>
                                
                                <div class="absolute top-32 right-32 w-20 h-12 bg-red-500 rounded shadow-lg animate-bounce" style="animation-delay: 1s; animation-duration: 3s;">
                                    <div class="w-full h-full bg-gradient-to-r from-red-400 to-red-600 rounded flex items-center justify-center">
                                        <span class="text-white text-xs font-bold">40ft HC</span>
                                    </div>
                                </div>
                                
                                <div class="absolute bottom-32 left-32 w-18 h-12 bg-green-500 rounded shadow-lg animate-bounce" style="animation-delay: 2s; animation-duration: 3s;">
                                    <div class="w-full h-full bg-gradient-to-r from-green-400 to-green-600 rounded flex items-center justify-center">
                                        <span class="text-white text-xs font-bold">FCL</span>
                                    </div>
                                </div>
                                
                                <!-- Animated Ships -->
                                <div class="absolute bottom-20 left-10 text-4xl animate-pulse" style="animation-duration: 2s;">🚢</div>
                                <div class="absolute top-1/2 right-20 text-3xl animate-pulse" style="animation-delay: 1s; animation-duration: 2s;">⚓</div>
                                
                                <!-- Globe/World -->
                                <div class="absolute top-1/3 left-1/3 text-6xl animate-spin" style="animation-duration: 20s;">🌍</div>
                                
                                <!-- Floating Icons -->
                                <div class="absolute top-16 right-16 text-2xl animate-bounce" style="animation-delay: 0.5s; animation-duration: 2s;">📦</div>
                                <div class="absolute bottom-16 right-16 text-2xl animate-bounce" style="animation-delay: 1.5s; animation-duration: 2s;">🏭</div>
                                <div class="absolute top-1/2 left-16 text-2xl animate-bounce" style="animation-delay: 2.5s; animation-duration: 2s;">🚛</div>
                            </div>
                            
                            <!-- Central Avatar Area -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center text-white">
                                    <div class="w-32 h-32 mx-auto mb-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center backdrop-blur-sm border border-white border-opacity-30">
                                        <div class="text-6xl animate-pulse">🤖</div>
                                    </div>
                                    <h2 class="text-3xl font-bold mb-2">Supply Chain Expert</h2>
                                    <p class="text-xl text-blue-200 mb-4">Your AI-Powered Logistics Assistant</p>
                                    <div class="flex items-center justify-center space-x-4 text-sm text-blue-300">
                                        <span>📋 Incoterms</span>
                                        <span>📦 Containers</span>
                                        <span>🚢 Shipping</span>
                                        <span>🏛️ Customs</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Indicator -->
                            <div class="absolute top-4 left-4 flex items-center text-white">
                                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse mr-2"></div>
                                <span class="text-sm">Online & Ready</span>
                            </div>
                            
                            <!-- TEST INDICATOR -->
                            <div class="absolute top-4 right-4 bg-red-500 text-white p-2 text-xs font-bold">
                                NEW DESIGN LOADED ✅
                            </div>
                        </div>
                        
                        <!-- Chat Interface -->
                        <div class="w-1/3 h-full bg-gray-100 flex flex-col border-l border-gray-300">
                            <div class="bg-blue-600 text-white p-4">
                                <h2 class="text-xl font-bold">Supply Chain Expert</h2>
                                <p class="text-sm opacity-90">Ask me about imports, exports, shipping, and more!</p>
                            </div>
                            
                            <!-- Messages -->
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                                <div class="text-center text-gray-500 mt-8">
                                    <p>👋 Hello! I'm your supply chain expert.</p>
                                    <p>Ask me about:</p>
                                    <ul class="text-sm mt-2 space-y-1">
                                        <li>• Import/Export requirements</li>
                                        <li>• Incoterms and shipping terms</li>
                                        <li>• Container specifications</li>
                                        <li>• Best shipping agents</li>
                                        <li>• Customs procedures</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Input Form -->
                            <div class="p-4 bg-white border-t">
                                <div class="flex space-x-2">
                                    <input
                                        type="text"
                                        id="chat-input"
                                        placeholder="Ask about supply chain, shipping, imports..."
                                        class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        id="chat-send"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Send
                                    </button>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyCYCinps1BCJVJuT3ZSZHXYRQ6RjCmoQWk",
            authDomain: "costing-app-4b351.firebaseapp.com",
            projectId: "costing-app-4b351",
            storageBucket: "costing-app-4b351.firebasestorage.app",
            messagingSenderId: "868255106195",
            appId: "1:868255106195:web:022741badc310dd4f43966"
        });
        const __app_id = "costing-app-4b351";
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        const state = { 
            shipmentDetails: { 
                supplierName: { label: 'Supplier Name', value: 'Qida Chemical Co. Ltd', type: 'select', options: ['Qida Chemical Co. Ltd', 'AROMSA BESIN AROMA VE KATKI MADDELERI SAN. VE TIC. A.S.', 'SACCO S.R.L', 'Futura Ingredients', 'MARCEL CARRAGEENAN', 'AB Mauri', 'KMC', 'Ornua Co-operative Limeted', 'Halavet Gida Sanayi Ve Ticaret A.S', 'Delta Iris', 'Tristar Global'] },
                pol: { label: 'Port of Loading (POL)', value: 'Shanghai', type: 'select', options: ['Shanghai', 'Ningbo', 'Qingdao', 'Singapore', 'Rotterdam', 'Hamburg', 'Los Angeles', 'Durban', 'Cape Town', 'Gqeberha', 'Jakarta', 'Port Klang', 'Istanbul', 'Istanbul,Ambarlı', 'Nhava Sheva', 'Dublin', 'Auckland'] }, 
                pod: { label: 'Port of Discharge (POD)', value: 'Durban', type: 'select', options: ['Durban', 'Cape Town', 'Gqeberha', 'Shanghai', 'Ningbo', 'Qingdao', 'Singapore', 'Rotterdam', 'Hamburg', 'Los Angeles', 'Jakarta', 'Port Klang', 'Istanbul', 'Istanbul,Ambarlı', 'Nhava Sheva', 'Dublin', 'Auckland'] }, 
                shippingLine: { label: 'Shipping Line', value: 'Maersk', type: 'select', options: ['Maersk', 'MSC', 'CMA CGM', 'COSCO', 'Hapag-Lloyd', 'PIL', 'ONE', 'MAERSK'] }, 
                containerSize: { label: 'Container Size', value: "40' HC", type: 'select', options: ["20' GP", "40' GP", "40' HC", "20' OT", "40' OT", "20' FR", "40' FR"] }, 
                commodity: { label: 'Commodity', value: 'General Goods', type: 'text' }, 
                incoterm: { label: 'Incoterm', value: 'FOB', type: 'select', options: ['EXW', 'FOB', 'CFR', 'CIF', 'DAP', 'DDP'] } 
            }, 
            exchangeRates: { 
                usd: { label: 'USD to ZAR', value: '18.50' }, 
                eur: { label: 'EUR to ZAR', value: '20.20' }, 
                gbp: { label: 'GBP to ZAR', value: '23.50' } 
            },
            currencyAmounts: {
                usdAmount: { label: 'USD Amount', value: '1000', type: 'number' },
                eurAmount: { label: 'EUR Amount', value: '1000', type: 'number' },
                gbpAmount: { label: 'GBP Amount', value: '1000', type: 'number' }
            },
            originCharges: { 
                title: 'Origin charges', 
                currencyOptions: ['USD', 'EUR'], 
                items: { 
                    ratePerKg: { label: 'Rate per Kg', value: '12.50', currency: 'usd' },
                    totalKg: { label: 'Total Kg', value: '1000', currency: 'kg' }
                } 
            },
            costs: { 
                freight: { title: 'Freight costs', currencyOptions: ['USD', 'EUR', 'GBP'], items: { seaFreight: { label: 'Sea Freight', value: '2500', currency: 'usd' }, peakSeasonSurcharge: { label: 'Peak Season Surcharge', value: '0', currency: 'usd' }, bunkerSurcharge: { label: 'Bunker Surcharge', value: '300', currency: 'usd' }, adminFee: { label: 'Admin Fee', value: '50', currency: 'usd' } } }, 
                destinationCharges: { title: 'Destination charges', currencyOptions: ['ZAR'], items: { shippingLineCharges: { label: 'Shipping line charges', value: '0', currency: 'zar' }, cargoDues20ft: { label: 'Cargo dues 20ft', value: '0', currency: 'zar' }, cargoDues40ft: { label: 'Cargo dues 40ft', value: '0', currency: 'zar' }, ctoFee: { label: 'CTO fee', value: '0', currency: 'zar' } } }, 
                clearing: { title: 'Forwarding & clearing', currencyOptions: ['ZAR'], items: { agencyFee: { label: 'Agency Fee', value: '1850', currency: 'zar' }, customsClearance: { label: 'Customs Clearance', value: '950', currency: 'zar' }, documentation: { label: 'Documentation', value: '450', currency: 'zar' }, portHealthInspection: { label: 'Port health inspection', value: '0', currency: 'zar' }, daffInspection: { label: 'DAFF inspection', value: '0', currency: 'zar' }, stateVetCancellation: { label: 'State vet cancellation fee', value: '0', currency: 'zar' }, nbTurnIn: { label: 'NB turn in', value: '0', currency: 'zar' }, vesselAc: { label: 'Vessel A&C', value: '0', currency: 'zar' } } },
                transport: { title: 'Transport and warehousing', currencyOptions: ['ZAR'], items: { localCartageCptUnder20: { label: 'Local cartage: CPT to Klapmuts < 20 ton', value: '0', currency: 'zar' }, localCartageCpt21_28: { label: 'Local cartage: CPT to Klapmuts 21-28 ton', value: '0', currency: 'zar' }, transportDbnPta20ft: { label: 'Transport: DBN port to Pretoria - 20ft < 20 tons, direct', value: '0', currency: 'zar' }, transportDbnWhs: { label: 'Transport: DBN port to WHS', value: '0', currency: 'zar' }, unpackReload: { label: 'Unpack / Reload', value: '0', currency: 'zar' }, storage: { label: 'Storage (3 days free)', value: '0', currency: 'zar' }, outlyingSurcharge: { label: 'Outlying container depot surcharge', value: '0', currency: 'zar' }, localCartageDbnPtaA: { label: 'Local cartage: DBN WHS to Pretoria - Option A', value: '0', currency: 'zar' }, localCartageDbnPtaB: { label: 'Local cartage: DBN WHS to Pretoria - Option B', value: '0', currency: 'zar' }, localCartageDbn6m: { label: 'Local cartage: DBN WHS to Pretoria - 6m deckspace', value: '0', currency: 'zar' }, localCartageDbn12m: { label: 'Local cartage: DBN WHS to Pretoria - 12m deckspace', value: '0', currency: 'zar' }, transportPePta: { label: 'Transport: PE/Coega port to Pretoria', value: '0', currency: 'zar' } } } 
            }, 
            landedCost: { 
                importCountry: { label: '🌍 Import Country', value: 'ZA', type: 'select', options: [
                    { value: 'ZA', label: '🇿🇦 South Africa (SARS)' },
                    { value: 'US', label: '🇺🇸 United States (CBP)' },
                    { value: 'GB', label: '🇬🇧 United Kingdom (HMRC)' },
                    { value: 'DE', label: '🇩🇪 Germany (EU)' },
                    { value: 'FR', label: '🇫🇷 France (EU)' },
                    { value: 'CN', label: '🇨🇳 China (Customs)' },
                    { value: 'IN', label: '🇮🇳 India (GST)' },
                    { value: 'AU', label: '🇦🇺 Australia' },
                    { value: 'CA', label: '🇨🇦 Canada' },
                    { value: 'JP', label: '🇯🇵 Japan' }
                ]},
                invoiceCurrency: { label: '💱 Invoice Currency', value: 'USD', type: 'select', options: [
                    { value: 'USD', label: '$ US Dollar' },
                    { value: 'EUR', label: '€ Euro' },
                    { value: 'GBP', label: '£ British Pound' },
                    { value: 'ZAR', label: 'R South African Rand' },
                    { value: 'CNY', label: '¥ Chinese Yuan' },
                    { value: 'INR', label: '₹ Indian Rupee' },
                    { value: 'JPY', label: '¥ Japanese Yen' },
                    { value: 'AUD', label: 'A$ Australian Dollar' },
                    { value: 'CAD', label: 'C$ Canadian Dollar' }
                ]},
                commercialInvoiceValue: { label: 'Commercial Invoice Value', value: '15000' }, 
                hsCode: { label: 'HS Code', value: '', type: 'text' },
                dutyRate: { label: 'Rate of Duty (%)', value: '5' }, 
                originCountry: { label: 'Country of Origin', value: 'CN', type: 'select', options: [
                    { value: 'CN', label: 'China' },
                    { value: 'DE', label: 'Germany' },
                    { value: 'IN', label: 'India' },
                    { value: 'US', label: 'United States' },
                    { value: 'UK', label: 'United Kingdom' },
                    { value: 'IT', label: 'Italy' },
                    { value: 'JP', label: 'Japan' },
                    { value: 'KR', label: 'South Korea' },
                    { value: 'TH', label: 'Thailand' },
                    { value: 'VN', label: 'Vietnam' },
                    { value: 'BW', label: 'Botswana (BELN)' },
                    { value: 'LS', label: 'Lesotho (BELN)' },
                    { value: 'SZ', label: 'Eswatini (BELN)' },
                    { value: 'NA', label: 'Namibia (BELN)' }
                ]},
                tradeAgreement: { label: 'Trade Agreement', value: 'general', type: 'select', options: [
                    { value: 'general', label: 'General Rate' },
                    { value: 'EU', label: 'EU Agreement' },
                    { value: 'SADC', label: 'SADC Agreement' },
                    { value: 'AfCFTA', label: 'AfCFTA Agreement' },
                    { value: 'EFTA', label: 'EFTA Agreement' }
                ]},
                totalKg: { label: 'Total Kg', value: '1000' } 
            },
            pricingStrategy: {
                unitQuantity: { label: 'Unit Quantity', value: '100', type: 'number' },
                pricingMethod: { label: 'Pricing Method', value: 'margin', options: ['margin', 'markup', 'manual'] },
                marginPercent: { label: 'Desired Margin (%)', value: '25', type: 'number' },
                markupPercent: { label: 'Markup (%)', value: '35', type: 'number' },
                manualSellPrice: { label: 'Sell Price per Unit (ZAR)', value: '0', type: 'number' },
                targetCurrency: { label: 'Pricing Currency', value: 'zar', options: ['zar', 'usd', 'eur'] }
            },
            costSplitting: {
                enabled: { label: 'Enable Cost Splitting', value: false, type: 'checkbox' },
                method: { label: 'Split Method', value: 'weight', options: ['weight', 'volume', 'units'] },
                totalVolume: { label: 'Total Volume (CBM)', value: '65', type: 'number' },
                itemUnits: { label: 'Number of Items', value: '1', type: 'number' }
            }
        };
        const VAT_RATE = 0.15;

        // --- QUOTE TEMPLATES SYSTEM ---
        const QuoteTemplates = {
            templates: {
                'asia-to-dbn': {
                    name: 'Asia to Durban (Standard)',
                    description: 'Common route from Asian ports to Durban',
                    icon: '🚢',
                    data: {
                        shipmentDetails: {
                            pol: 'Shanghai, China',
                            pod: 'Durban, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'General Cargo',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '8.50',
                            totalKg: '2000'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2800',
                                bunkerSurcharge: '400',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1200',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '7.5'
                        }
                    }
                },
                'europe-to-cpt': {
                    name: 'Europe to Cape Town',
                    description: 'Standard European imports via Cape Town',
                    icon: '🇪🇺',
                    data: {
                        shipmentDetails: {
                            pol: 'Hamburg, Germany',
                            pod: 'Cape Town, South Africa',
                            containerSize: '20ft',
                            commodity: 'Machinery',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '12.00',
                            totalKg: '1500'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2200',
                                bunkerSurcharge: '300',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '900',
                                cargoDues20ft: '650'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '5.0'
                        }
                    }
                },
                'uk-machinery': {
                    name: 'UK Machinery Import',
                    description: 'Heavy machinery from UK with typical duty rates',
                    icon: '🏭',
                    data: {
                        shipmentDetails: {
                            pol: 'Southampton, UK',
                            pod: 'Durban, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'Industrial Machinery',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '15.50',
                            totalKg: '3000'
                        },
                        costs: {
                            freight: {
                                seaFreight: '3200',
                                bunkerSurcharge: '450',
                                adminFee: '75'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1400',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '2100',
                                customsClearance: '1200',
                                documentation: '600',
                                daffInspection: '850'
                            },
                            transport: {
                                transportDbnPta20ft: '4500'
                            }
                        },
                        landedCost: {
                            dutyRate: '0.0'
                        }
                    }
                },
                'china-textiles': {
                    name: 'China Textiles',
                    description: 'Textile imports from China with typical rates',
                    icon: '🧵',
                    data: {
                        shipmentDetails: {
                            pol: 'Ningbo, China',
                            pod: 'Cape Town, South Africa',
                            containerSize: '40ft HC',
                            commodity: 'Textiles & Clothing',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '6.80',
                            totalKg: '1800'
                        },
                        costs: {
                            freight: {
                                seaFreight: '2600',
                                bunkerSurcharge: '380',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '1100',
                                cargoDues40ft: '850'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450'
                            }
                        },
                        landedCost: {
                            dutyRate: '45.0'
                        }
                    }
                },
                'india-chemicals': {
                    name: 'India Chemicals',
                    description: 'Chemical products from India',
                    icon: '⚗️',
                    data: {
                        shipmentDetails: {
                            pol: 'Mumbai, India',
                            pod: 'Durban, South Africa',
                            containerSize: '20ft',
                            commodity: 'Chemical Products',
                            supplierName: ''
                        },
                        originCharges: {
                            ratePerKg: '11.20',
                            totalKg: '1200'
                        },
                        costs: {
                            freight: {
                                seaFreight: '1800',
                                bunkerSurcharge: '250',
                                adminFee: '50'
                            },
                            destinationCharges: {
                                shippingLineCharges: '800',
                                cargoDues20ft: '650'
                            },
                            clearing: {
                                agencyFee: '1850',
                                customsClearance: '950',
                                documentation: '450',
                                portHealthInspection: '750'
                            }
                        },
                        landedCost: {
                            dutyRate: '10.0'
                        }
                    }
                }
            },

            getTemplate(templateId) {
                return this.templates[templateId] || null;
            },

            getAllTemplates() {
                return Object.entries(this.templates).map(([id, template]) => ({
                    id,
                    ...template
                }));
            },

            applyTemplate(templateId) {
                const template = this.getTemplate(templateId);
                if (!template) return false;

                // Apply template data to state
                const templateData = template.data;
                
                // Update shipment details
                Object.keys(templateData.shipmentDetails).forEach(key => {
                    if (state.shipmentDetails[key] && templateData.shipmentDetails[key]) {
                        state.shipmentDetails[key].value = templateData.shipmentDetails[key];
                    }
                });

                // Update origin charges
                if (templateData.originCharges) {
                    Object.keys(templateData.originCharges).forEach(key => {
                        if (state.originCharges.items[key]) {
                            state.originCharges.items[key].value = templateData.originCharges[key];
                        }
                    });
                }

                // Update cost sections
                if (templateData.costs) {
                    Object.keys(templateData.costs).forEach(sectionKey => {
                        if (state.costs[sectionKey]) {
                            Object.keys(templateData.costs[sectionKey]).forEach(itemKey => {
                                if (state.costs[sectionKey].items[itemKey]) {
                                    state.costs[sectionKey].items[itemKey].value = templateData.costs[sectionKey][itemKey];
                                }
                            });
                        }
                    });
                }

                // Update landed cost
                if (templateData.landedCost) {
                    Object.keys(templateData.landedCost).forEach(key => {
                        if (state.landedCost[key]) {
                            state.landedCost[key].value = templateData.landedCost[key];
                        }
                    });
                }

                return true;
            }
        };

        // --- COMPREHENSIVE SA CUSTOMS HS CODE SYSTEM ---
        const HSCodeDatabase = {
            codes: {
                // Chapter 84: Nuclear reactors, boilers, machinery and mechanical appliances
                '8471.30': { 
                    description: 'Portable automatic data processing machines, weighing not more than 10 kg', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '84',
                    examples: ['Laptops', 'Notebooks', 'Tablet computers'],
                    notes: 'Duty-free under various trade agreements'
                },
                '8471.41': { 
                    description: 'Other automatic data processing machines: Comprising in the same housing at least a central processing unit and an input and output unit', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '84',
                    examples: ['Desktop computers', 'All-in-one PCs', 'Workstations'],
                    notes: 'Includes complete computer systems'
                },
                '8471.60': { 
                    description: 'Input or output units, whether or not presented with the rest of a system', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '84',
                    examples: ['Keyboards', 'Mice', 'Monitors', 'Printers'],
                    notes: 'Computer peripherals and accessories'
                },
                '8528.72': { 
                    description: 'Reception apparatus for television, colour, incorporating video recording or reproducing apparatus', 
                    dutyRate: 15, 
                    category: 'Electronics & IT',
                    chapter: '85',
                    examples: ['Smart TVs', 'TV with built-in recording', 'Digital TV receivers'],
                    notes: 'Standard rate for consumer electronics'
                },
                '8517.12': { 
                    description: 'Telephones for cellular networks or for other wireless networks', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '85',
                    examples: ['Mobile phones', 'Smartphones', 'Satellite phones'],
                    notes: 'Duty-free to encourage technology adoption'
                },
                '8517.62': { 
                    description: 'Machines for the reception, conversion and transmission or regeneration of voice, images or other data', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '85',
                    examples: ['Routers', 'Modems', 'Network switches', 'WiFi equipment'],
                    notes: 'Critical IT infrastructure'
                },
                
                // Chapter 84: Machinery and mechanical appliances
                '8429.52': { 
                    description: 'Machinery with a 360° revolving superstructure (excavators)', 
                    dutyRate: 0, 
                    category: 'Industrial Machinery',
                    chapter: '84',
                    examples: ['Hydraulic excavators', 'Mining excavators', 'Construction excavators'],
                    notes: 'Capital equipment for infrastructure development'
                },
                '8443.32': { 
                    description: 'Printers and copying machines, multifunction machines', 
                    dutyRate: 0, 
                    category: 'Office Equipment',
                    chapter: '84',
                    examples: ['Laser printers', 'Inkjet printers', 'Multifunction copiers'],
                    notes: 'Business equipment duty exemption'
                },
                
                // Chapter 62: Articles of apparel and clothing accessories, not knitted
                '6203.42': { 
                    description: 'Men\'s or boys\' trousers, bib and brace overalls, breeches and shorts, of cotton', 
                    dutyRate: 45, 
                    category: 'Textiles & Clothing',
                    chapter: '62',
                    examples: ['Cotton trousers', 'Jeans', 'Chinos', 'Work pants'],
                    notes: 'Protection for local textile industry'
                },
                '6204.62': { 
                    description: 'Women\'s or girls\' trousers, bib and brace overalls, breeches and shorts, of cotton', 
                    dutyRate: 45, 
                    category: 'Textiles & Clothing',
                    chapter: '62',
                    examples: ['Women\'s pants', 'Cotton trousers', 'Casual wear'],
                    notes: 'High protection rate for clothing'
                },
                
                // Chapter 61: Articles of apparel and clothing accessories, knitted or crocheted
                '6109.10': { 
                    description: 'T-shirts, singlets and other vests, of cotton', 
                    dutyRate: 45, 
                    category: 'Textiles & Clothing',
                    chapter: '61',
                    examples: ['Cotton T-shirts', 'Basic tees', 'Casual tops'],
                    notes: 'Standard clothing protection rate'
                },
                
                // Chapter 64: Footwear
                '6403.51': { 
                    description: 'Footwear with leather uppers, covering the ankle but not the calf', 
                    dutyRate: 30, 
                    category: 'Textiles & Clothing',
                    chapter: '64',
                    examples: ['Ankle boots', 'Chelsea boots', 'Desert boots'],
                    notes: 'Moderate protection for footwear industry'
                },
                '6404.11': { 
                    description: 'Sports footwear; tennis shoes, basketball shoes, gym shoes, training shoes', 
                    dutyRate: 30, 
                    category: 'Textiles & Clothing',
                    chapter: '64',
                    examples: ['Running shoes', 'Tennis shoes', 'Athletic footwear'],
                    notes: 'Sports footwear standard rate'
                },
                
                // Chapter 87: Vehicles other than railway or tramway rolling-stock
                '8703.23': { 
                    description: 'Motor cars and other motor vehicles with spark-ignition internal combustion engine, 1500-3000cc', 
                    dutyRate: 25, 
                    category: 'Automotive',
                    chapter: '87',
                    examples: ['Sedan cars', 'Hatchbacks', 'Small SUVs'],
                    notes: 'Standard passenger vehicle import duty'
                },
                '8708.29': { 
                    description: 'Other parts and accessories of motor vehicle bodies', 
                    dutyRate: 20, 
                    category: 'Automotive',
                    chapter: '87',
                    examples: ['Bumpers', 'Fenders', 'Body panels', 'Doors'],
                    notes: 'Auto parts import duty'
                },
                
                // Chapter 40: Rubber and articles thereof
                '4011.10': { 
                    description: 'New pneumatic tyres, of rubber, for motor cars', 
                    dutyRate: 15, 
                    category: 'Automotive',
                    chapter: '40',
                    examples: ['Car tyres', 'Passenger vehicle tyres', 'Performance tyres'],
                    notes: 'Tyre import protection'
                },
                
                // Chapter 30: Pharmaceutical products
                '3004.10': { 
                    description: 'Medicaments containing penicillins or derivatives thereof', 
                    dutyRate: 0, 
                    category: 'Pharmaceuticals',
                    chapter: '30',
                    examples: ['Antibiotics', 'Penicillin medicines', 'Antimicrobial drugs'],
                    notes: 'Essential medicines duty-free'
                },
                '3004.90': { 
                    description: 'Other medicaments for therapeutic or prophylactic uses', 
                    dutyRate: 0, 
                    category: 'Pharmaceuticals',
                    chapter: '30',
                    examples: ['Chronic medication', 'Vitamins', 'Pain relief medicines'],
                    notes: 'General medicines duty exemption'
                },
                
                // Chapter 38: Miscellaneous chemical products
                '3808.50': { 
                    description: 'Goods specified in Subheading Note 1 to this Chapter (Agricultural chemicals)', 
                    dutyRate: 5, 
                    category: 'Agricultural Chemicals',
                    chapter: '38',
                    examples: ['Pesticides', 'Herbicides', 'Fungicides'],
                    notes: 'Agricultural input support'
                },
                
                // Chapter 39: Plastics and articles thereof
                '3926.90': { 
                    description: 'Other articles of plastics and articles of other materials', 
                    dutyRate: 10, 
                    category: 'Industrial Materials',
                    chapter: '39',
                    examples: ['Plastic containers', 'Industrial plastics', 'Plastic components'],
                    notes: 'General plastic products rate'
                },
                
                // Chapter 17: Sugars and sugar confectionery
                '1701.14': { 
                    description: 'Other cane sugar', 
                    dutyRate: 0, 
                    category: 'Food & Agriculture',
                    chapter: '17',
                    examples: ['Raw cane sugar', 'Brown sugar', 'Unrefined sugar'],
                    notes: 'Agricultural product support'
                },
                
                // Chapter 09: Coffee, tea, mate and spices
                '0901.21': { 
                    description: 'Coffee, roasted, not decaffeinated', 
                    dutyRate: 7.5, 
                    category: 'Food & Agriculture',
                    chapter: '09',
                    examples: ['Roasted coffee beans', 'Premium coffee', 'Artisan coffee'],
                    notes: 'Processed coffee import duty'
                },
                
                // Chapter 22: Beverages, spirits and vinegar
                '2204.21': { 
                    description: 'Wine of fresh grapes, in containers holding 2 litres or less', 
                    dutyRate: 0, 
                    category: 'Food & Agriculture',
                    chapter: '22',
                    examples: ['Bottled wine', 'Premium wine', 'Table wine'],
                    notes: 'Wine import friendly policy'
                },
                
                // Chapter 72: Iron and steel
                '7208.51': { 
                    description: 'Flat-rolled products of iron/steel, not clad, plated or coated, thickness ≥ 4.75mm', 
                    dutyRate: 10, 
                    category: 'Metals & Materials',
                    chapter: '72',
                    examples: ['Steel plates', 'Heavy steel sheets', 'Industrial steel'],
                    notes: 'Steel industry protection'
                },
                
                // Chapter 76: Aluminium and articles thereof
                '7601.10': { 
                    description: 'Aluminium, not alloyed, unwrought', 
                    dutyRate: 0, 
                    category: 'Metals & Materials',
                    chapter: '76',
                    examples: ['Pure aluminium ingots', 'Primary aluminium', 'Aluminium billets'],
                    notes: 'Raw material for manufacturing'
                },
                
                // Chapter 44: Wood and articles of wood
                '4403.20': { 
                    description: 'Wood in the rough, whether or not stripped of bark, coniferous', 
                    dutyRate: 0, 
                    category: 'Forestry & Materials',
                    chapter: '44',
                    examples: ['Pine logs', 'Softwood timber', 'Construction timber'],
                    notes: 'Raw materials for construction'
                },
                
                // Chapter 02: Meat and edible meat offal
                '0201.10': { 
                    description: 'Carcasses and half-carcasses of bovine animals, fresh or chilled', 
                    dutyRate: 40, 
                    category: 'Food & Agriculture',
                    chapter: '02',
                    examples: ['Beef carcasses', 'Fresh beef', 'Chilled beef'],
                    notes: 'High protection for local farming'
                },
                
                // Chapter 85: Electrical machinery and equipment
                '8504.40': { 
                    description: 'Static converters (power supplies, inverters, UPS)', 
                    dutyRate: 0, 
                    category: 'Electronics & IT',
                    chapter: '85',
                    examples: ['Power supplies', 'UPS systems', 'Inverters', 'Converters'],
                    notes: 'Critical electrical infrastructure'
                }
            },

            searchCodes(query) {
                const results = [];
                const searchTerm = query.toLowerCase();
                
                for (const [code, data] of Object.entries(this.codes)) {
                    // Search in code, description, category, examples, chapter, and notes
                    const searchText = `${code} ${data.description} ${data.category} ${data.examples.join(' ')} ${data.chapter || ''} ${data.notes || ''}`.toLowerCase();
                    
                    if (searchText.includes(searchTerm)) {
                        results.push({
                            code,
                            ...data,
                            relevance: this.calculateRelevance(searchText, searchTerm, code)
                        });
                    }
                }
                
                // Sort by relevance, then by chapter and code
                return results.sort((a, b) => {
                    if (b.relevance !== a.relevance) return b.relevance - a.relevance;
                    return a.code.localeCompare(b.code);
                }).slice(0, 12);
            },

            calculateRelevance(text, searchTerm, code) {
                let score = 0;
                
                // Exact code match gets highest score
                if (code.toLowerCase() === searchTerm) score += 200;
                if (code.toLowerCase().startsWith(searchTerm)) score += 150;
                
                // Partial code match
                if (code.toLowerCase().includes(searchTerm)) score += 100;
                
                // Description match gets high score
                if (text.includes(searchTerm)) score += 50;
                
                // Multiple word matches
                const words = searchTerm.split(' ');
                words.forEach(word => {
                    if (word.length > 2 && text.includes(word)) {
                        score += 20;
                    }
                });
                
                return score;
            },

            getByCode(hsCode) {
                return this.codes[hsCode] || null;
            },

            getByCategory(category) {
                return Object.entries(this.codes)
                    .filter(([code, data]) => data.category === category)
                    .map(([code, data]) => ({ code, ...data }));
            },

            getAllCategories() {
                const categories = [...new Set(Object.values(this.codes).map(item => item.category))];
                return categories.sort();
            }
        };

        // --- GLOBAL CUSTOMS CALCULATION ENGINE ---
        const GlobalCustomsCalculator = {
            // Original SARS system (South Africa)
            SARS: {
            // BELN countries (Botswana, Lesotho, Eswatini, Namibia) - 10% uplift exemption
            belnCountries: ['BW', 'LS', 'SZ', 'NA'],
            
            // VAT rate (current since 2018-04-01)
            vatRate: 0.15,
            
            // Complete HS Code database - 11,217 codes from Schedule 1 Part 1
            hsCodeDatabase: null, // Will be loaded from external source
            
            // Initialize the complete database
            async initializeDatabase() {
                if (this.hsCodeDatabase) {
                    return; // Already loaded
                }
                
                try {
                    console.log('🔄 Loading complete HS Code database...');
                    
                    // Try to load the COMPLETE database with all 11,217 codes
                    let response = await fetch('./hs-codes-complete.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.codes) {
                            this.hsCodeDatabase = data.codes;
                            console.log(`✅ Loaded ${Object.keys(this.hsCodeDatabase).length} HS codes from COMPLETE database`);
                            
                            // Show sample codes starting with 11 to verify
                            const codes11 = Object.keys(this.hsCodeDatabase).filter(code => code.startsWith('11'));
                            console.log(`📋 Found ${codes11.length} HS codes starting with '11' (e.g., ${codes11.slice(0, 3).join(', ')})`);
                            return;
                        }
                    }
                    
                    // Fallback to other databases
                    response = await fetch('./hs-codes-database.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.codes) {
                            this.hsCodeDatabase = data.codes;
                            console.log(`✅ Loaded ${Object.keys(this.hsCodeDatabase).length} HS codes from standard database`);
                            return;
                        }
                    }
                    
                    // Try compressed version as last resort
                    response = await fetch('./hs-codes-compressed.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.codes) {
                            this.hsCodeDatabase = data.codes;
                            console.log(`⚠️ Loaded ${Object.keys(this.hsCodeDatabase).length} HS codes from compressed database (limited coverage)`);
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load database files, using fallback:', error.message);
                }
                
                // Fallback: Use expanded sample database with key product categories
                this.hsCodeDatabase = {
                    // Live animals & animal products (01-05)
                    "0101": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "0102": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "0201": { gen: 40, eu: 40, sadc: 20, afcfta: 20 },
                    "0202": { gen: 40, eu: 40, sadc: 20, afcfta: 20 },
                    "0203": { gen: 40, eu: 40, sadc: 20, afcfta: 20 },
                    "0401": { gen: 40, eu: 40, sadc: 20, afcfta: 20 },
                    "0402": { gen: 40, eu: 40, sadc: 20, afcfta: 20 },
                    
                    // Vegetable products (06-14)
                    "0701": { gen: 30, eu: 30, sadc: 15, afcfta: 15 },
                    "0713": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "0901": { gen: 7.5, eu: 0, sadc: 3.75, afcfta: 3.75 },
                    "0902": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "1001": { gen: 107.8, eu: 107.8, sadc: 53.9, afcfta: 53.9 },
                    "1005": { gen: 107.8, eu: 107.8, sadc: 53.9, afcfta: 53.9 },
                    "1204": { gen: 4, efta: 4, merc: 4, afcfta: 7 },
                    "1206": { gen: 4, efta: 4, merc: 4, afcfta: 7 },
                    
                    // Fats and oils (15)
                    "1503": { gen: 0.1, efta: 0.1, merc: 5, afcfta: 0.05 },
                    "1507": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "1511": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "1515": { gen: 7.5, eu: 0, sadc: 3.75, afcfta: 3.75 },
                    
                    // Sugar and confectionery (17)
                    "1701": { gen: 250, eu: 250, sadc: 125, afcfta: 125 },
                    "1704": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    
                    // Beverages and tobacco (20-24)
                    "2009": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    "2202": { gen: 25, eu: 0, sadc: 12.5, afcfta: 12.5 },
                    "2203": { gen: 85, eu: 85, sadc: 42.5, afcfta: 42.5 },
                    "2208": { gen: 1050, eu: 1050, sadc: 525, afcfta: 525 },
                    "2402": { gen: 350, eu: 350, sadc: 175, afcfta: 175 },
                    
                    // Food preparations (19-21)
                    "1905": { gen: 25, eu: 0, sadc: 12.5, afcfta: 12.5 },
                    "2103": { gen: 5, eu: 0, sadc: 3, afcfta: 2.5 },
                    "2104": { gen: 20, eu: 0, sadc: 0, afcfta: 10 },
                    "2105": { gen: 25, eu: 0, sadc: 12.5, afcfta: 12.5 },
                    "2106": { gen: 20, eu: 0, sadc: 0, afcfta: 10 },
                    
                    // Chemicals (28-38)
                    "2804": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "2817": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "2902": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "3004": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "3808": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    
                    // Plastics and rubber (39-40)
                    "3901": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "3920": { gen: 10, eu: 0, sadc: 5, afcfta: 5 },
                    "4011": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    
                    // Textiles and clothing (50-63)
                    "5208": { gen: 22, eu: 0, sadc: 11, afcfta: 11 },
                    "6109": { gen: 40, eu: 0, sadc: 20, afcfta: 20 },
                    "6110": { gen: 40, eu: 0, sadc: 20, afcfta: 20 },
                    "6203": { gen: 40, eu: 0, sadc: 20, afcfta: 20 },
                    "6204": { gen: 40, eu: 0, sadc: 20, afcfta: 20 },
                    "6404": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    
                    // Base metals (72-83)
                    "7208": { gen: 10, eu: 0, sadc: 5, afcfta: 5 },
                    "7601": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "8302": { gen: 15, eu: 0, sadc: 7.5, afcfta: 7.5 },
                    
                    // Machinery and electronics (84-85)
                    "8414": { gen: 15, eu: 0, sadc: 7.5, afcfta: 7.5 },
                    "8415": { gen: 15, eu: 0, sadc: 7.5, afcfta: 7.5 },
                    "8471": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "8517": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    "8528": { gen: 15, eu: 0, sadc: 7.5, afcfta: 7.5 },
                    
                    // Vehicles (87)
                    "8703": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    "8704": { gen: 20, eu: 0, sadc: 10, afcfta: 10 },
                    "8711": { gen: 30, eu: 0, sadc: 15, afcfta: 15 },
                    
                    // Optical instruments (90)
                    "9013": { gen: 0, eu: 0, sadc: 0, afcfta: 0 },
                    
                    // Furniture (94)
                    "9401": { gen: 20, eu: 0, sadc: 10, afcfta: 10 },
                    "9403": { gen: 20, eu: 0, sadc: 10, afcfta: 10 }
                };
                
                console.log(`✅ Loaded ${Object.keys(this.hsCodeDatabase).length} HS codes from fallback database`);
            },
            
            // Trade agreement mapping for country codes
            tradeAgreementMapping: {
                // EU countries
                'DE': 'EU', 'FR': 'EU', 'IT': 'EU', 'ES': 'EU', 'NL': 'EU', 'BE': 'EU', 'AT': 'EU', 'PT': 'EU', 'GR': 'EU', 'IE': 'EU', 'LU': 'EU', 'FI': 'EU', 'SE': 'EU', 'DK': 'EU', 'CZ': 'EU', 'HU': 'EU', 'PL': 'EU', 'SK': 'EU', 'SI': 'EU', 'EE': 'EU', 'LV': 'EU', 'LT': 'EU', 'MT': 'EU', 'CY': 'EU', 'BG': 'EU', 'RO': 'EU', 'HR': 'EU',
                // UK
                'GB': 'UK', 'UK': 'UK',
                // SADC
                'BW': 'SADC', 'LS': 'SADC', 'SZ': 'SADC', 'NA': 'SADC', 'ZW': 'SADC', 'ZM': 'SADC', 'TZ': 'SADC', 'MW': 'SADC', 'MU': 'SADC', 'MG': 'SADC', 'MZ': 'SADC', 'AO': 'SADC', 'CD': 'SADC', 'SC': 'SADC',
                // EFTA
                'CH': 'EFTA', 'NO': 'EFTA', 'IS': 'EFTA', 'LI': 'EFTA',
                // MERCOSUR
                'BR': 'MERCOSUR', 'AR': 'MERCOSUR', 'UY': 'MERCOSUR', 'PY': 'MERCOSUR'
            },
            
            // Calculate customs duty according to SARS regulations
            calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem', quantity = 1, specificRate = 0) {
                if (dutyType === 'ad-valorem') {
                    // Duty (ZAR) = Customs Value (CIF) × Duty Rate (%)
                    return customsValue * (dutyRate / 100);
                } else if (dutyType === 'specific') {
                    // Duty (ZAR) = Quantity (kg / unit) × Specific-Rate (cents or ZAR per unit)
                    return quantity * specificRate;
                } else {
                    return 0;
                }
            },
            
            // Calculate Import VAT according to official SARS formula
            calculateImportVAT(customsValue, nonRebatedDuties, originCountryCode) {
                // Check if origin is BELN country (10% uplift exemption)
                const isBELN = this.belnCountries.includes(originCountryCode?.toUpperCase());
                
                // Calculate 10% uplift (exempt for BELN countries)
                const uplift = isBELN ? 0 : customsValue * 0.10;
                
                // ATV = (Customs Value + 10% thereof) + (any non-rebated duties levied on the goods)
                const atv = customsValue + uplift + nonRebatedDuties;
                
                // VAT payable = ATV × 15%
                const importVAT = atv * this.vatRate;
                
                return {
                    customsValue,
                    uplift,
                    nonRebatedDuties,
                    atv,
                    importVAT,
                    isBELN,
                    calculation: `ATV = ${formatCurrency(customsValue)} + ${formatCurrency(uplift)} + ${formatCurrency(nonRebatedDuties)} = ${formatCurrency(atv)}\nVAT = ${formatCurrency(atv)} × 15% = ${formatCurrency(importVAT)}`
                };
            },
            
            // Lookup HS code in database
            async lookupHSCode(hsCode) {
                // Initialize database if not already done
                if (!this.hsCodeDatabase) {
                    await this.initializeDatabase();
                }
                
                const normalizedCode = hsCode.replace(/\s+/g, '').replace(/[.-]/g, '.');
                const entry = this.hsCodeDatabase[normalizedCode];
                
                if (!entry) return null;
                
                // Convert compressed format to standard format
                return {
                    description: entry.desc || '',
                    general: entry.gen || 0,
                    EU: entry.eu || 0,
                    UK: entry.eu || 0, // UK follows EU rates
                    EFTA: entry.efta || 0,
                    SADC: entry.sadc || 0,
                    MERCOSUR: entry.merc || 0,
                    AfCFTA: entry.afcfta || 0
                };
            },
            
            // Auto-detect trade agreement from country code
            detectTradeAgreement(originCountry) {
                return this.tradeAgreementMapping[originCountry?.toUpperCase()] || 'general';
            },
            
            // Get trade agreement preferential rate from HS code database
            async getPreferentialRate(hsCode, baseRate, originCountry, tradeAgreement = null) {
                // Auto-detect trade agreement if not specified
                if (!tradeAgreement) {
                    tradeAgreement = this.detectTradeAgreement(originCountry);
                }
                
                // Lookup HS code in database
                const hsData = await this.lookupHSCode(hsCode);
                if (hsData) {
                    const rate = hsData[tradeAgreement] ?? hsData.general;
                    return rate;
                }
                
                // Fallback to base rate if HS code not found
                return baseRate;
            },
            
            // Calculate mixed rate (specific vs ad-valorem, use higher yield)
            calculateMixedRate(customsValue, adValoremRate, specificRate, quantity) {
                const adValoremDuty = this.calculateDuty(customsValue, adValoremRate, 'ad-valorem');
                const specificDuty = this.calculateDuty(customsValue, 0, 'specific', quantity, specificRate);
                
                return {
                    adValoremDuty,
                    specificDuty,
                    applicableDuty: Math.max(adValoremDuty, specificDuty),
                    method: adValoremDuty > specificDuty ? 'ad-valorem' : 'specific'
                };
            },
            
            // Complete SARS-compliant calculation with audit trail
            async calculateComplete(params) {
                const {
                    customsValue,
                    hsCode,
                    baseDutyRate,
                    originCountry,
                    tradeAgreement = null,
                    dutyType = 'ad-valorem',
                    quantity = 1,
                    specificRate = 0,
                    mixedRate = false,
                    exciseRate = 0,
                    antiDumpingRate = 0,
                    safeguardRate = 0
                } = params;
                
                // Auto-detect trade agreement if not specified
                const detectedTradeAgreement = tradeAgreement || this.detectTradeAgreement(originCountry);
                
                // Lookup HS code data
                const hsData = await this.lookupHSCode(hsCode);
                
                // Get applicable duty rate (considering trade agreements)
                const applicableDutyRate = await this.getPreferentialRate(hsCode, baseDutyRate, originCountry, detectedTradeAgreement);
                
                // Calculate customs duty
                let customsDuty;
                let dutyMethod = dutyType;
                
                if (mixedRate) {
                    const mixedCalc = this.calculateMixedRate(customsValue, applicableDutyRate, specificRate, quantity);
                    customsDuty = mixedCalc.applicableDuty;
                    dutyMethod = mixedCalc.method;
                } else {
                    customsDuty = this.calculateDuty(customsValue, applicableDutyRate, dutyType, quantity, specificRate);
                }
                
                // Calculate additional duties
                const exciseDuty = this.calculateDuty(customsValue, exciseRate, 'ad-valorem');
                const antiDumpingDuty = this.calculateDuty(customsValue, antiDumpingRate, 'ad-valorem');
                const safeguardDuty = this.calculateDuty(customsValue, safeguardRate, 'ad-valorem');
                
                // Total non-rebated duties = Σ{ ordinary customs duty + excise + anti-dumping + safeguard }
                const totalNonRebatedDuties = customsDuty + exciseDuty + antiDumpingDuty + safeguardDuty;
                
                // Calculate Import VAT
                const vatCalculation = this.calculateImportVAT(customsValue, totalNonRebatedDuties, originCountry);
                
                // Total border taxes
                const totalBorderTaxes = totalNonRebatedDuties + vatCalculation.importVAT;
                
                // Audit trail
                const auditTrail = {
                    calculationDate: new Date().toISOString(),
                    hsCode,
                    hsDescription: hsData?.description || 'Unknown',
                    originCountry,
                    detectedTradeAgreement,
                    scheduleLine: `Schedule 1 Part 1 - ${hsCode}`,
                    applicableDutyRate,
                    dutyMethod,
                    customsValue,
                    quantity,
                    specificRate
                };
                
                return {
                    customsValue,
                    hsCode,
                    originCountry,
                    tradeAgreement: detectedTradeAgreement,
                    baseDutyRate,
                    applicableDutyRate,
                    customsDuty,
                    exciseDuty,
                    antiDumpingDuty,
                    safeguardDuty,
                    totalNonRebatedDuties,
                    ...vatCalculation,
                    totalBorderTaxes,
                    auditTrail,
                    breakdown: {
                        dutyCalculation: `Duty = ${formatCurrency(customsValue)} × ${applicableDutyRate}% = ${formatCurrency(customsDuty)}`,
                        vatCalculation: vatCalculation.calculation,
                        total: `Total Border Taxes = ${formatCurrency(totalNonRebatedDuties)} + ${formatCurrency(vatCalculation.importVAT)} = ${formatCurrency(totalBorderTaxes)}`
                    }
                };
            },
            
            // Validate calculation against SARS examples
            validateExample() {
                console.log('🧪 Running SARS Validation Tests...');
                
                // Example 1 from SARS: India origin, R1000 customs value, 5% duty
                const example1 = this.calculateComplete({
                    customsValue: 1000,
                    hsCode: '2106.90.90',
                    baseDutyRate: 5,
                    originCountry: 'IN'
                });
                
                // Expected: Duty R50, ATV R1150, VAT R172.50
                const test1Valid = Math.abs(example1.customsDuty - 50) < 0.01 && 
                                  Math.abs(example1.atv - 1150) < 0.01 && 
                                  Math.abs(example1.importVAT - 172.50) < 0.01;
                
                console.log('Test 1 (India Example):', test1Valid ? '✅ PASSED' : '❌ FAILED', example1.breakdown);
                
                // Example 2: German origin (EU), R500k customs value, 0% duty (preferential)
                const example2 = this.calculateComplete({
                    customsValue: 500000,
                    hsCode: '2106.90.90',
                    baseDutyRate: 20,
                    originCountry: 'DE'
                });
                
                // Expected: Duty R0, ATV R550k, VAT R82.5k
                const test2Valid = Math.abs(example2.customsDuty - 0) < 0.01 && 
                                  Math.abs(example2.atv - 550000) < 0.01 && 
                                  Math.abs(example2.importVAT - 82500) < 0.01;
                
                console.log('Test 2 (German EU Example):', test2Valid ? '✅ PASSED' : '❌ FAILED', example2.breakdown);
                
                // Example 3: BELN country (no uplift)
                const example3 = this.calculateComplete({
                    customsValue: 1000,
                    hsCode: '2106.90.90',
                    baseDutyRate: 5,
                    originCountry: 'BW'
                });
                
                // Expected: Duty R0 (SADC), ATV R1000 (no uplift), VAT R150
                const test3Valid = Math.abs(example3.customsDuty - 0) < 0.01 && 
                                  Math.abs(example3.atv - 1000) < 0.01 && 
                                  Math.abs(example3.importVAT - 150) < 0.01;
                
                console.log('Test 3 (BELN/SADC Example):', test3Valid ? '✅ PASSED' : '❌ FAILED', example3.breakdown);
                
                const allValid = test1Valid && test2Valid && test3Valid;
                console.log('Overall Validation:', allValid ? '✅ ALL TESTS PASSED' : '❌ SOME TESTS FAILED');
                
                return allValid;
            },
            
            // Add travellers flat rate calculation
            calculateTravellersRate(customsValue, dutyFreeAllowance = 0) {
                const taxableValue = Math.max(0, customsValue - dutyFreeAllowance);
                const flatRateDuty = taxableValue * 0.20; // 20% flat rate
                const vatCalculation = this.calculateImportVAT(taxableValue, flatRateDuty, 'ZA');
                
                return {
                    customsValue,
                    dutyFreeAllowance,
                    taxableValue,
                    flatRateDuty,
                    ...vatCalculation,
                    totalBorderTaxes: flatRateDuty + vatCalculation.importVAT,
                    method: 'Travellers Flat Rate (20%)'
                };
            }
            },
            
            // United States Customs (CBP)
            US: {
                vatRate: 0, // No federal VAT, state sales tax varies
                stateTaxRates: {
                    'CA': 0.075, 'NY': 0.08, 'TX': 0.0625, 'FL': 0.06,
                    'WA': 0.065, 'IL': 0.0625, 'OH': 0.0575, 'default': 0.06
                },
                
                calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem', quantity = 1) {
                    if (dutyType === 'ad-valorem') {
                        return customsValue * (dutyRate / 100);
                    }
                    return 0;
                },
                
                calculateTax(customsValue, duties, state = 'default') {
                    const taxRate = this.stateTaxRates[state] || this.stateTaxRates.default;
                    const taxableValue = customsValue + duties;
                    return taxableValue * taxRate;
                },
                
                tradeAgreements: {
                    'MX': 'USMCA', 'CA': 'USMCA',
                    'general': 'MFN'
                }
            },
            
            // European Union Customs
            EU: {
                vatRates: {
                    'DE': 0.19, 'FR': 0.20, 'IT': 0.22, 'ES': 0.21, 'NL': 0.21,
                    'BE': 0.21, 'AT': 0.20, 'PT': 0.23, 'GR': 0.24, 'IE': 0.23,
                    'default': 0.20
                },
                
                calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem') {
                    if (dutyType === 'ad-valorem') {
                        return customsValue * (dutyRate / 100);
                    }
                    return 0;
                },
                
                calculateVAT(customsValue, duties, country = 'default') {
                    const vatRate = this.vatRates[country] || this.vatRates.default;
                    const vatableValue = customsValue + duties;
                    return vatableValue * vatRate;
                },
                
                tradeAgreements: {
                    'CH': 'EFTA', 'NO': 'EFTA', 'IS': 'EFTA',
                    'CA': 'CETA', 'JP': 'EPA', 'KR': 'FTA'
                }
            },
            
            // United Kingdom Customs (HMRC)
            UK: {
                vatRate: 0.20,
                
                calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem') {
                    if (dutyType === 'ad-valorem') {
                        return customsValue * (dutyRate / 100);
                    }
                    return 0;
                },
                
                calculateVAT(customsValue, duties) {
                    const vatableValue = customsValue + duties;
                    return vatableValue * this.vatRate;
                },
                
                tradeAgreements: {
                    'EU': 'TCA', 'AU': 'FTA', 'NZ': 'FTA', 'JP': 'EPA'
                }
            },
            
            // China Customs
            CN: {
                vatRate: 0.13,
                consumptionTaxItems: ['alcohol', 'tobacco', 'luxury'],
                
                calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem') {
                    if (dutyType === 'ad-valorem') {
                        return customsValue * (dutyRate / 100);
                    }
                    return 0;
                },
                
                calculateVAT(customsValue, duties) {
                    const vatableValue = customsValue + duties;
                    return vatableValue * this.vatRate;
                },
                
                tradeAgreements: {
                    'ASEAN': 'RCEP', 'AU': 'FTA', 'NZ': 'FTA', 'KR': 'FTA'
                }
            },
            
            // India Customs
            IN: {
                gstRate: 0.18,
                cessDuties: ['environment', 'education', 'health'],
                
                calculateDuty(customsValue, dutyRate, dutyType = 'ad-valorem') {
                    if (dutyType === 'ad-valorem') {
                        return customsValue * (dutyRate / 100);
                    }
                    return 0;
                },
                
                calculateGST(customsValue, duties) {
                    const gstableValue = customsValue + duties;
                    return gstableValue * this.gstRate;
                },
                
                tradeAgreements: {
                    'ASEAN': 'AIFTA', 'JP': 'EPA', 'KR': 'CEPA'
                }
            },
            
            // Universal calculation method
            async calculateForCountry(importCountry, params) {
                const {
                    customsValue, hsCode, originCountry, dutyRate = 0,
                    dutyType = 'ad-valorem', quantity = 1, state = null
                } = params;
                
                let result = {
                    importCountry,
                    originCountry,
                    customsValue,
                    hsCode,
                    customsDuty: 0,
                    vat: 0,
                    totalTaxes: 0,
                    method: 'Unknown system'
                };
                
                switch (importCountry.toUpperCase()) {
                    case 'ZA':
                        const sarsResult = await this.SARS.calculateComplete({
                            customsValue, hsCode, originCountry, dutyType, quantity
                        });
                        if (sarsResult) {
                            result = {
                                ...result,
                                customsDuty: sarsResult.customsDuty,
                                vat: sarsResult.importVAT,
                                totalTaxes: sarsResult.totalBorderTaxes,
                                method: 'SARS (South Africa)',
                                tradeAgreement: sarsResult.tradeAgreement,
                                breakdown: sarsResult.breakdown
                            };
                        }
                        break;
                        
                    case 'US':
                        result.customsDuty = this.US.calculateDuty(customsValue, dutyRate, dutyType);
                        result.vat = this.US.calculateTax(customsValue, result.customsDuty, state);
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'CBP (United States)';
                        break;
                        
                    case 'DE': case 'FR': case 'IT': case 'ES': case 'NL': case 'BE': 
                    case 'AT': case 'PT': case 'GR': case 'IE':
                        result.customsDuty = this.EU.calculateDuty(customsValue, dutyRate, dutyType);
                        result.vat = this.EU.calculateVAT(customsValue, result.customsDuty, importCountry);
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'EU Customs Union';
                        break;
                        
                    case 'GB': case 'UK':
                        result.customsDuty = this.UK.calculateDuty(customsValue, dutyRate, dutyType);
                        result.vat = this.UK.calculateVAT(customsValue, result.customsDuty);
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'HMRC (United Kingdom)';
                        break;
                        
                    case 'CN':
                        result.customsDuty = this.CN.calculateDuty(customsValue, dutyRate, dutyType);
                        result.vat = this.CN.calculateVAT(customsValue, result.customsDuty);
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'China Customs';
                        break;
                        
                    case 'IN':
                        result.customsDuty = this.IN.calculateDuty(customsValue, dutyRate, dutyType);
                        result.vat = this.IN.calculateGST(customsValue, result.customsDuty);
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'India Customs (GST)';
                        break;
                        
                    default:
                        result.customsDuty = customsValue * (dutyRate / 100);
                        result.vat = (customsValue + result.customsDuty) * 0.15;
                        result.totalTaxes = result.customsDuty + result.vat;
                        result.method = 'Generic (Estimated)';
                        break;
                }
                
                return result;
            },
            
            // Get list of supported countries
            getSupportedCountries() {
                return [
                    { code: 'ZA', name: 'South Africa', flag: '🇿🇦', system: 'SARS' },
                    { code: 'US', name: 'United States', flag: '🇺🇸', system: 'CBP' },
                    { code: 'GB', name: 'United Kingdom', flag: '🇬🇧', system: 'HMRC' },
                    { code: 'DE', name: 'Germany', flag: '🇩🇪', system: 'EU' },
                    { code: 'FR', name: 'France', flag: '🇫🇷', system: 'EU' },
                    { code: 'CN', name: 'China', flag: '🇨🇳', system: 'China Customs' },
                    { code: 'IN', name: 'India', flag: '🇮🇳', system: 'GST' },
                    { code: 'AU', name: 'Australia', flag: '🇦🇺', system: 'Generic' },
                    { code: 'CA', name: 'Canada', flag: '🇨🇦', system: 'Generic' },
                    { code: 'JP', name: 'Japan', flag: '🇯🇵', system: 'Generic' }
                ];
            }
        };
        
        // Backward compatibility - keep SARS as alias
        const SARSCustomsCalculator = GlobalCustomsCalculator.SARS;

        // --- GLOBAL CURRENCY SERVICE ---
        class GlobalCurrencyService {
            constructor() {
                this.apis = [
                    {
                        name: 'ExchangeRate-API',
                        url: 'https://api.exchangerate-api.com/v4/latest',
                        parseResponse: (data, toCurrency) => data.rates?.[toCurrency.toUpperCase()]
                    },
                    {
                        name: 'Fixer-Backup', 
                        url: 'https://api.fixer.io/latest',
                        parseResponse: (data, toCurrency) => data.rates?.[toCurrency.toUpperCase()]
                    }
                ];
                this.cacheKey = 'exchange_rates_cache';
                this.timestampKey = 'exchange_rates_timestamp';
                this.cacheValidityHours = 24;
                this.spotMultiplier = 2; // spot x 2
                
                // Global currency definitions
                this.currencies = {
                    'USD': { name: 'US Dollar', symbol: '$', countries: ['US'], flag: '🇺🇸' },
                    'EUR': { name: 'Euro', symbol: '€', countries: ['DE', 'FR', 'IT', 'ES', 'NL', 'BE', 'AT', 'PT', 'GR', 'IE'], flag: '🇪🇺' },
                    'GBP': { name: 'British Pound', symbol: '£', countries: ['GB', 'UK'], flag: '🇬🇧' },
                    'ZAR': { name: 'South African Rand', symbol: 'R', countries: ['ZA'], flag: '🇿🇦' },
                    'CNY': { name: 'Chinese Yuan', symbol: '¥', countries: ['CN'], flag: '🇨🇳' },
                    'INR': { name: 'Indian Rupee', symbol: '₹', countries: ['IN'], flag: '🇮🇳' },
                    'JPY': { name: 'Japanese Yen', symbol: '¥', countries: ['JP'], flag: '🇯🇵' },
                    'AUD': { name: 'Australian Dollar', symbol: 'A$', countries: ['AU'], flag: '🇦🇺' },
                    'CAD': { name: 'Canadian Dollar', symbol: 'C$', countries: ['CA'], flag: '🇨🇦' },
                    'CHF': { name: 'Swiss Franc', symbol: 'Fr', countries: ['CH'], flag: '🇨🇭' },
                    'KRW': { name: 'South Korean Won', symbol: '₩', countries: ['KR'], flag: '🇰🇷' },
                    'SGD': { name: 'Singapore Dollar', symbol: 'S$', countries: ['SG'], flag: '🇸🇬' },
                    'HKD': { name: 'Hong Kong Dollar', symbol: 'HK$', countries: ['HK'], flag: '🇭🇰' },
                    'NOK': { name: 'Norwegian Krone', symbol: 'kr', countries: ['NO'], flag: '🇳🇴' },
                    'SEK': { name: 'Swedish Krona', symbol: 'kr', countries: ['SE'], flag: '🇸🇪' },
                    'DKK': { name: 'Danish Krone', symbol: 'kr', countries: ['DK'], flag: '🇩🇰' },
                    'BRL': { name: 'Brazilian Real', symbol: 'R$', countries: ['BR'], flag: '🇧🇷' },
                    'MXN': { name: 'Mexican Peso', symbol: '$', countries: ['MX'], flag: '🇲🇽' },
                    'RUB': { name: 'Russian Ruble', symbol: '₽', countries: ['RU'], flag: '🇷🇺' },
                    'TRY': { name: 'Turkish Lira', symbol: '₺', countries: ['TR'], flag: '🇹🇷' }
                };
            }
            
            // Get currency for country
            getCurrencyForCountry(countryCode) {
                for (const [currency, info] of Object.entries(this.currencies)) {
                    if (info.countries.includes(countryCode.toUpperCase())) {
                        return currency;
                    }
                }
                return 'USD'; // Default fallback
            }
            
            // Get all supported currencies
            getSupportedCurrencies() {
                return Object.keys(this.currencies).map(code => ({
                    code,
                    ...this.currencies[code]
                }));
            }
            
            // Format currency amount
            formatCurrency(amount, currencyCode, countryCode = null) {
                const currency = this.currencies[currencyCode];
                if (!currency) return amount.toString();
                
                const locale = countryCode ? `en-${countryCode}` : 'en-US';
                try {
                    return new Intl.NumberFormat(locale, {
                        style: 'currency',
                        currency: currencyCode
                    }).format(amount);
                } catch {
                    return `${currency.symbol}${amount.toLocaleString()}`;
                }
            }

            async fetchRate(fromCurrency, toCurrency) {
                // Try each API in order until one works
                for (const api of this.apis) {
                    try {
                        console.log(`Trying ${api.name} for ${fromCurrency}/${toCurrency}`);
                        const url = `${api.url}/${fromCurrency.toUpperCase()}`;
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            console.warn(`${api.name} returned ${response.status}`);
                            continue;
                        }
                        
                        const data = await response.json();
                        const rate = api.parseResponse(data, toCurrency);
                        
                        if (!rate || isNaN(rate)) {
                            console.warn(`${api.name} - Rate not found or invalid:`, rate);
                            continue;
                        }
                        
                        const finalRate = parseFloat(rate) * this.spotMultiplier;
                        console.log(`${api.name} - ${fromCurrency}/${toCurrency}: ${rate} -> ${finalRate} (spot x 2)`);
                        return finalRate;
                        
                    } catch (error) {
                        console.warn(`${api.name} failed:`, error.message);
                        continue;
                    }
                }
                
                console.error(`All APIs failed for ${fromCurrency}/${toCurrency}`);
                return null;
            }

            async fetchAllRates() {
                try {
                    showToast('Fetching live exchange rates...', 'info');
                    console.log('Starting exchange rate fetch...');
                    
                    // Fetch rates sequentially to better handle errors
                    const usdRate = await this.fetchRate('USD', 'ZAR');
                    const eurRate = await this.fetchRate('EUR', 'ZAR'); 
                    const gbpRate = await this.fetchRate('GBP', 'ZAR');

                    console.log('Fetched rates:', { usdRate, eurRate, gbpRate });

                    // Check if we got at least some rates
                    const successfulRates = [usdRate, eurRate, gbpRate].filter(rate => rate !== null);
                    
                    if (successfulRates.length === 0) {
                        throw new Error('All exchange rate APIs failed');
                    }

                    // Use fetched rates or fallback to cached/default for failed ones
                    const cachedRates = this.getCachedRates();
                    const rates = {
                        usd: { 
                            label: 'USD to ZAR', 
                            value: usdRate ? usdRate.toFixed(2) : cachedRates.usd.value 
                        },
                        eur: { 
                            label: 'EUR to ZAR', 
                            value: eurRate ? eurRate.toFixed(2) : cachedRates.eur.value 
                        },
                        gbp: { 
                            label: 'GBP to ZAR', 
                            value: gbpRate ? gbpRate.toFixed(2) : cachedRates.gbp.value 
                        }
                    };

                    // Cache the rates and timestamp
                    localStorage.setItem(this.cacheKey, JSON.stringify(rates));
                    localStorage.setItem(this.timestampKey, Date.now().toString());

                    const successCount = successfulRates.length;
                    if (successCount === 3) {
                        showToast('Exchange rates updated successfully! (Spot × 2)', 'success');
                    } else {
                        showToast(`Partial update: ${successCount}/3 rates fetched (Spot × 2)`, 'warning');
                    }
                    
                    console.log('Final rates:', rates);
                    return rates;
                    
                } catch (error) {
                    console.error('Failed to fetch exchange rates:', error);
                    showToast('API connection failed - using cached/default rates', 'error');
                    return this.getCachedRates();
                }
            }

            getCachedRates() {
                try {
                    const cached = localStorage.getItem(this.cacheKey);
                    if (cached) {
                        const parsedRates = JSON.parse(cached);
                        
                        // Validate cache structure
                        if (parsedRates.usd?.value && parsedRates.eur?.value && parsedRates.gbp?.value) {
                            console.log('Using valid cached rates:', parsedRates);
                            return parsedRates;
                        } else {
                            console.warn('Cached rates structure is invalid:', parsedRates);
                            localStorage.removeItem(this.cacheKey);
                        }
                    }
                } catch (error) {
                    console.warn('Failed to parse cached rates:', error);
                    localStorage.removeItem(this.cacheKey);
                }
                
                // Fallback to default rates (current hardcoded values)
                console.log('Using fallback default rates');
                return {
                    usd: { label: 'USD to ZAR', value: '18.50' },
                    eur: { label: 'EUR to ZAR', value: '20.20' }, 
                    gbp: { label: 'GBP to ZAR', value: '23.50' }
                };
            }

            isCacheExpired() {
                const timestamp = localStorage.getItem(this.timestampKey);
                if (!timestamp) return true;

                const cacheTime = parseInt(timestamp);
                const now = Date.now();
                const hoursSinceCache = (now - cacheTime) / (1000 * 60 * 60);

                return hoursSinceCache >= this.cacheValidityHours;
            }

            getLastUpdateTime() {
                const timestamp = localStorage.getItem(this.timestampKey);
                if (!timestamp) return 'Never';

                const date = new Date(parseInt(timestamp));
                return date.toLocaleString('en-ZA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            async initializeRates() {
                if (this.isCacheExpired()) {
                    return await this.fetchAllRates();
                } else {
                    const cached = this.getCachedRates();
                    showToast(`Using cached rates (Last updated: ${this.getLastUpdateTime()})`, 'info');
                    return cached;
                }
            }
        }

        // Initialize Global Currency Service
        const exchangeRateService = new GlobalCurrencyService();

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value, currency = 'ZAR') => new Intl.NumberFormat('en-ZA', { style: 'currency', currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseFloat(value) || 0);

        // --- NOTIFICATION SYSTEM ---
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-lg">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : '⚠️'}
                    </span>
                    <div>
                        <p class="font-semibold text-gray-800">${message}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        };

        // --- MOBILE MENU FUNCTIONALITY ---
        const toggleMobileMenu = () => {
            const sidebar = document.querySelector('aside');
            const overlay = document.querySelector('.mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
            
            // Prevent body scroll when menu is open
            if (sidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        };

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('aside');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('mobile-open') && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // Close mobile menu when selecting a navigation item
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        const sidebar = document.querySelector('aside');
                        const overlay = document.querySelector('.mobile-overlay');
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';
                    }
                });
            });
        });

        // --- AUTO-CALCULATION FUNCTION ---
        function updateCommercialValue() {
            console.log('🔄 updateCommercialValue called');
            const ratePerKgEl = document.getElementById('origin-ratePerKg-value');
            const totalKgEl = document.getElementById('origin-totalKg-value');
            const ratePerKgCurrencyEl = document.getElementById('origin-ratePerKg-currency');
            const commercialValueEl = document.getElementById('lc-commercialInvoiceValue');
            const landedTotalKgEl = document.getElementById('lc-totalKg');
            
            console.log('Elements found:', {
                ratePerKg: !!ratePerKgEl,
                totalKg: !!totalKgEl,
                commercialValue: !!commercialValueEl,
                landedTotalKg: !!landedTotalKgEl
            });
            
            if (ratePerKgEl && totalKgEl && commercialValueEl) {
                const ratePerKg = ratePerKgEl.value;
                const totalKg = totalKgEl.value;
                const currency = ratePerKgCurrencyEl ? ratePerKgCurrencyEl.value : 'usd';
                
                // Validate Origin Charges inputs
                const validation = ValidationUtil.validateOriginCharges(ratePerKg, totalKg);
                
                if (!validation.isValid) {
                    // Show validation errors with visual feedback
                    if (parseFloat(ratePerKg) <= 0 || isNaN(parseFloat(ratePerKg))) {
                        ValidationUtil.showValidationError('Rate per Kg must be a positive number', ratePerKgEl);
                    }
                    if (parseFloat(totalKg) <= 0 || isNaN(parseFloat(totalKg))) {
                        ValidationUtil.showValidationError('Total Kg must be a positive number', totalKgEl);
                    }
                    console.log('❌ Validation failed:', validation.message);
                    return false;
                }

                // Show container capacity warnings
                if (validation.warnings && validation.warnings.length > 0) {
                    validation.warnings.forEach(warning => {
                        showToast(warning, 'warning');
                    });
                }

                // Additional container size validation
                const containerSizeEl = document.getElementById('sd-containerSize');
                if (containerSizeEl && totalKg) {
                    const containerValidation = ValidationUtil.validateContainerCapacity(totalKg, containerSizeEl.value);
                    if (containerValidation.errors.length > 0) {
                        containerValidation.errors.forEach(error => {
                            showToast(error, 'error');
                        });
                    }
                    if (containerValidation.warnings.length > 0) {
                        containerValidation.warnings.forEach(warning => {
                            showToast(warning, 'warning');
                        });
                    }
                }
                
                // Clear any previous validation errors
                ValidationUtil.clearValidationError(ratePerKgEl);
                ValidationUtil.clearValidationError(totalKgEl);
                
                // Calculate total value
                const totalValue = parseFloat(ratePerKg) * parseFloat(totalKg);
                
                console.log(`💰 Calculation: ${ratePerKg} × ${totalKg} = ${totalValue} ${currency.toUpperCase()}`);
                
                // Update commercial invoice value (always in USD for landed cost calculation)
                commercialValueEl.value = totalValue.toFixed(2);
                
                // Also update the total kg in landed cost section to match
                if (landedTotalKgEl) {
                    landedTotalKgEl.value = totalKg.toString();
                }
                
                // Update display if app is loaded
                if (window.App && App.updateDisplay) {
                    App.updateDisplay();
                }
                
                console.log('✅ Commercial value updated to:', totalValue.toFixed(2));
                return true;
            } else {
                console.log('❌ Required elements not found for calculation');
                return false;
            }
        }
        
        // Make function globally available
        window.updateCommercialValue = updateCommercialValue;

        // --- INPUT VALIDATION UTILITY ---
        const ValidationUtil = {
            // Exchange rate validation bounds (reasonable ranges for major currencies to ZAR)
            exchangeRateLimits: {
                usd: { min: 10, max: 25, name: 'USD to ZAR' },
                eur: { min: 12, max: 30, name: 'EUR to ZAR' },
                gbp: { min: 15, max: 35, name: 'GBP to ZAR' }
            },
            
            validateExchangeRate(rateKey, value) {
                const numValue = parseFloat(value);
                const limits = this.exchangeRateLimits[rateKey];
                
                if (!limits) return { isValid: true, message: '' };
                
                if (isNaN(numValue) || numValue <= 0) {
                    return { 
                        isValid: false, 
                        message: `${limits.name} rate must be a positive number` 
                    };
                }
                
                if (numValue < limits.min || numValue > limits.max) {
                    return { 
                        isValid: false, 
                        message: `${limits.name} rate should be between ${limits.min} and ${limits.max}. Current value (${numValue}) seems unusual.` 
                    };
                }
                
                return { isValid: true, message: '' };
            },
            
            validateCurrencyAmount(value) {
                const numValue = parseFloat(value);
                
                if (isNaN(numValue)) {
                    return { 
                        isValid: false, 
                        message: 'Amount must be a valid number' 
                    };
                }
                
                if (numValue < 0) {
                    return { 
                        isValid: false, 
                        message: 'Amount cannot be negative' 
                    };
                }
                
                if (numValue > 10000000) { // 10 million limit
                    return { 
                        isValid: false, 
                        message: 'Amount seems unusually large. Please verify.' 
                    };
                }
                
                return { isValid: true, message: '' };
            },
            
            validateOriginCharges(ratePerKg, totalKg) {
                const rate = parseFloat(ratePerKg);
                const kg = parseFloat(totalKg);
                
                const errors = [];
                const warnings = [];
                
                if (isNaN(rate) || rate <= 0) {
                    errors.push('Rate per Kg must be a positive number');
                }
                
                if (isNaN(kg) || kg <= 0) {
                    errors.push('Total Kg must be a positive number');
                }
                
                if (rate > 0 && rate < 0.01) {
                    errors.push('Rate per Kg seems too low (less than $0.01)');
                }
                
                if (rate > 1000) {
                    errors.push('Rate per Kg seems unusually high (over $1000)');
                }
                
                // Container capacity warnings
                if (kg > 0) {
                    if (kg > 28000) {
                        warnings.push('⚠️ Weight exceeds 40ft container limit (28,000kg max)');
                    } else if (kg > 21000) {
                        warnings.push('⚠️ Weight exceeds 20ft container limit (21,000kg max)');
                    }
                }
                
                if (kg > 50000) {
                    errors.push('Total Kg seems unusually high (over 50,000kg)');
                }
                
                return {
                    isValid: errors.length === 0,
                    message: errors.join('. '),
                    warnings: warnings
                };
            },

            validateContainerCapacity(totalKg, containerSize) {
                const kg = parseFloat(totalKg);
                const warnings = [];
                const errors = [];

                if (kg > 0 && containerSize) {
                    const limits = {
                        '20ft': { maxWeight: 21000, maxVolume: 33, name: '20ft Container' },
                        '40ft': { maxWeight: 26500, maxVolume: 67, name: '40ft Container' },
                        '40ft HC': { maxWeight: 28000, maxVolume: 76, name: '40ft High Cube' },
                        '45ft': { maxWeight: 28000, maxVolume: 86, name: '45ft Container' }
                    };

                    const limit = limits[containerSize];
                    if (limit) {
                        if (kg > limit.maxWeight) {
                            errors.push(`🚨 Weight (${kg.toLocaleString()}kg) exceeds ${limit.name} limit (${limit.maxWeight.toLocaleString()}kg)`);
                        } else if (kg > limit.maxWeight * 0.9) {
                            warnings.push(`⚠️ Weight (${kg.toLocaleString()}kg) approaching ${limit.name} limit (${limit.maxWeight.toLocaleString()}kg)`);
                        }
                    }
                }

                return { errors, warnings };
            },
            
            showValidationError(message, element = null) {
                if (element) {
                    element.style.borderColor = '#ef4444';
                    element.style.backgroundColor = '#fef2f2';
                }
                showToast(message, 'error');
                console.warn('⚠️ Validation Error:', message);
            },
            
            clearValidationError(element) {
                if (element) {
                    element.style.borderColor = '';
                    element.style.backgroundColor = '';
                }
            }
        };

        // --- SHIPMENT TRACKING SYSTEM ---
        const ShipmentTracker = {
            trackingTemplates: {
                'asia-dbn': {
                    name: 'Asia to Durban',
                    description: 'Popular route from Asian ports to Durban',
                    icon: '🚢',
                    route: 'Asia → Durban',
                    avgTransitTime: '21-28 days',
                    carriers: ['MSC', 'Maersk', 'CMA CGM'],
                    color: 'blue'
                },
                'europe-cpt': {
                    name: 'Europe to Cape Town',
                    description: 'European ports to Cape Town route',
                    icon: '🌍',
                    route: 'Europe → Cape Town',
                    avgTransitTime: '14-21 days',
                    carriers: ['MSC', 'Maersk', 'Hapag-Lloyd'],
                    color: 'green'
                },
                'usa-dbn': {
                    name: 'USA to Durban',
                    description: 'US East Coast to Durban route',
                    icon: '🇺🇸',
                    route: 'USA → Durban',
                    avgTransitTime: '28-35 days',
                    carriers: ['MSC', 'CMA CGM', 'Evergreen'],
                    color: 'purple'
                },
                'china-cpt': {
                    name: 'China to Cape Town',
                    description: 'Chinese ports to Cape Town route',
                    icon: '🇨🇳',
                    route: 'China → Cape Town',
                    avgTransitTime: '25-32 days',
                    carriers: ['COSCO', 'MSC', 'CMA CGM'],
                    color: 'red'
                }
            },

            carriers: {
                'msc': {
                    name: 'Mediterranean Shipping Company',
                    code: 'MSC',
                    color: '#0066cc',
                    apiEndpoint: 'https://api.msc.com/track',
                    trackingUrl: 'https://www.msc.com/track',
                    supportedTypes: ['container', 'bl', 'booking']
                },
                'maersk': {
                    name: 'Maersk Line',
                    code: 'MAEU',
                    color: '#00a8e6',
                    apiEndpoint: 'https://api.maersk.com/track',
                    trackingUrl: 'https://www.maersk.com/tracking',
                    supportedTypes: ['container', 'bl', 'booking']
                },
                'cma-cgm': {
                    name: 'CMA CGM',
                    code: 'CMDU',
                    color: '#e31837',
                    apiEndpoint: 'https://api.cma-cgm.com/track',
                    trackingUrl: 'https://www.cma-cgm.com/tracking',
                    supportedTypes: ['container', 'bl']
                },
                'hapag-lloyd': {
                    name: 'Hapag-Lloyd',
                    code: 'HLCU',
                    color: '#e40521',
                    apiEndpoint: 'https://api.hapag-lloyd.com/track',
                    trackingUrl: 'https://www.hapag-lloyd.com/tracking',
                    supportedTypes: ['container', 'bl']
                },
                'cosco': {
                    name: 'COSCO SHIPPING',
                    code: 'COSU',
                    color: '#003087',
                    apiEndpoint: 'https://api.cosco.com/track',
                    trackingUrl: 'https://elines.coscoshipping.com/ebusiness/cargotracking',
                    supportedTypes: ['container', 'bl']
                }
            },

            activeShipments: [],

            init() {
                this.loadActiveShipmentsFromStorage();
                this.loadTrackingTemplates();
                this.loadActiveShipments();
                this.bindTrackingEvents();
            },

            loadTrackingTemplates() {
                const templatesGrid = document.getElementById('tracking-templates-grid');
                if (!templatesGrid) return;

                templatesGrid.innerHTML = Object.entries(this.trackingTemplates).map(([id, template]) => `
                    <div class="tracking-template-card bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-${template.color}-500 hover:shadow-lg transition-all cursor-pointer transform hover:scale-105"
                         onclick="ShipmentTracker.selectTemplate('${id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${template.icon}</div>
                            <span class="text-xs px-2 py-1 bg-${template.color}-100 text-${template.color}-800 rounded-full font-medium">Template</span>
                        </div>
                        <h4 class="font-semibold text-gray-800 text-sm mb-2">${template.name}</h4>
                        <p class="text-xs text-gray-600 mb-3">${template.description}</p>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span>Route:</span>
                                <span class="font-medium">${template.route}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span>Transit:</span>
                                <span class="font-medium">${template.avgTransitTime}</span>
                            </div>
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <span>Carriers:</span>
                                <span class="font-medium">${template.carriers.join(', ')}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            loadActiveShipments() {
                const activeShipmentsDiv = document.getElementById('active-shipments');
                if (!activeShipmentsDiv) return;

                if (this.activeShipments.length === 0) {
                    activeShipmentsDiv.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <p class="mt-2 text-sm">No active shipments</p>
                            <p class="text-xs text-gray-400">Start tracking shipments to see them here</p>
                        </div>
                    `;
                } else {
                    activeShipmentsDiv.innerHTML = this.activeShipments.map(shipment => `
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-800">${shipment.trackingNumber}</h4>
                                    <p class="text-sm text-gray-600">${shipment.carrier} • ${shipment.vessel || 'Unknown Vessel'}</p>
                                    <p class="text-xs text-gray-500">${shipment.route.origin || 'Unknown'} → ${shipment.route.destination || 'Unknown'}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 text-xs rounded-full ${this.getStatusColor(shipment.status)}">${shipment.status}</span>
                                    <button onclick="ShipmentTracker.removeActiveShipment('${shipment.id}')" 
                                            class="text-red-500 hover:text-red-700 text-xs" title="Remove">
                                        ✕
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3 text-xs text-gray-600">
                                <div>
                                    <span class="font-medium">Location:</span> ${shipment.location}
                                </div>
                                <div>
                                    <span class="font-medium">ETA:</span> ${shipment.eta}
                                </div>
                                <div>
                                    <span class="font-medium">Progress:</span> ${shipment.progress}%
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm text-gray-500">
                                <span>Last Update: ${shipment.lastUpdate}</span>
                                <div class="flex space-x-2">
                                    <button onclick="ShipmentTracker.refreshShipment('${shipment.id}')" 
                                            class="text-blue-600 hover:text-blue-800 text-xs">
                                        🔄 Refresh
                                    </button>
                                    <button onclick="ShipmentTracker.viewShipmentDetails('${shipment.id}')" 
                                            class="text-green-600 hover:text-green-800 text-xs">
                                        👁️ View
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            },

            bindTrackingEvents() {
                const trackBtn = document.getElementById('track-shipment-btn');
                if (trackBtn) {
                    trackBtn.addEventListener('click', () => this.trackShipment());
                }

                const trackingNumber = document.getElementById('tracking-number');
                if (trackingNumber) {
                    trackingNumber.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.trackShipment();
                        }
                    });
                }
            },

            selectTemplate(templateId) {
                const template = this.trackingTemplates[templateId];
                if (!template) return;

                showToast(`Selected template: ${template.name}`, 'success');
                
                // You can add logic here to populate tracking form with template data
                // or navigate to a specific tracking interface
            },

            async trackShipment() {
                const carrier = document.getElementById('tracking-carrier').value;
                const trackingNumber = document.getElementById('tracking-number').value;

                if (!carrier || !trackingNumber) {
                    showToast('Please select a carrier and enter a tracking number', 'error');
                    return;
                }

                showToast('Tracking shipment...', 'info');

                try {
                    const trackingData = await this.fetchTrackingData(carrier, trackingNumber);
                    this.displayTrackingResults(trackingData);
                    
                    // Add to active shipments if not already tracked
                    this.addToActiveShipments(trackingData, carrier);
                } catch (error) {
                    console.error('Tracking error:', error);
                    showToast('Unable to track shipment. Please try again.', 'error');
                }
            },

            async fetchTrackingData(carrier, trackingNumber) {
                // For now, return mock data
                // In production, this would call actual carrier APIs
                const mockData = {
                    trackingNumber: trackingNumber,
                    carrier: carrier.toUpperCase(),
                    status: 'In Transit',
                    location: 'Port of Singapore',
                    vessel: 'MSC AMSTERDAM',
                    eta: '2025-01-15',
                    progress: 65,
                    events: [
                        { date: '2025-01-01', location: 'Shanghai, China', event: 'Container loaded on vessel', status: 'completed' },
                        { date: '2025-01-05', location: 'Hong Kong', event: 'Vessel departed', status: 'completed' },
                        { date: '2025-01-10', location: 'Singapore', event: 'Vessel arrived', status: 'completed' },
                        { date: '2025-01-12', location: 'Singapore', event: 'Container in transit', status: 'current' },
                        { date: '2025-01-15', location: 'Durban, South Africa', event: 'Estimated arrival', status: 'pending' }
                    ]
                };

                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1500));
                return mockData;
            },

            displayTrackingResults(data) {
                const resultsDiv = document.getElementById('tracking-results');
                const detailsDiv = document.getElementById('tracking-details');
                
                if (!resultsDiv || !detailsDiv) return;

                detailsDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${data.trackingNumber}</h3>
                                <p class="text-sm text-gray-600">${data.carrier} • ${data.vessel}</p>
                            </div>
                            <span class="px-3 py-1 text-sm rounded-full ${this.getStatusColor(data.status)}">${data.status}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <p class="text-xs text-gray-500">Current Location</p>
                                <p class="font-medium">${data.location}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Estimated Arrival</p>
                                <p class="font-medium">${data.eta}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Progress</p>
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${data.progress}%"></div>
                                    </div>
                                    <span class="text-sm font-medium">${data.progress}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-800">Tracking Events</h4>
                        <div class="space-y-3">
                            ${data.events.map(event => `
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0 w-3 h-3 rounded-full mt-1 ${
                                        event.status === 'completed' ? 'bg-green-500' :
                                        event.status === 'current' ? 'bg-blue-500' :
                                        'bg-gray-300'
                                    }"></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-sm font-medium text-gray-800">${event.event}</p>
                                                <p class="text-xs text-gray-500">${event.location}</p>
                                            </div>
                                            <span class="text-xs text-gray-500">${event.date}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-2">📊 Costing Integration</h4>
                        <p class="text-sm text-blue-700 mb-3">Use this tracking data to enhance your cost calculations:</p>
                        <div class="flex space-x-3">
                            <button onclick="ShipmentTracker.populateCostingFromTracking(${JSON.stringify(data).replace(/"/g, '&quot;')})" 
                                    class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                📋 Populate Costing
                            </button>
                            <button onclick="App.switchPage('cost-generator-page')" 
                                    class="btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                💰 Create Quote
                            </button>
                        </div>
                    </div>
                `;

                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            },

            getStatusColor(status) {
                const colors = {
                    'In Transit': 'bg-blue-100 text-blue-800',
                    'Delivered': 'bg-green-100 text-green-800',
                    'Delayed': 'bg-yellow-100 text-yellow-800',
                    'At Port': 'bg-purple-100 text-purple-800',
                    'Customs': 'bg-orange-100 text-orange-800'
                };
                return colors[status] || 'bg-gray-100 text-gray-800';
            },

            addToActiveShipments(trackingData, carrier) {
                // Check if shipment already exists
                const existingIndex = this.activeShipments.findIndex(s => s.trackingNumber === trackingData.trackingNumber);
                
                const shipment = {
                    id: trackingData.trackingNumber,
                    trackingNumber: trackingData.trackingNumber,
                    carrier: carrier.toUpperCase(),
                    status: trackingData.status,
                    location: trackingData.location,
                    route: this.extractRouteInfo(trackingData),
                    lastUpdate: new Date().toLocaleString(),
                    vessel: trackingData.vessel,
                    eta: trackingData.eta,
                    progress: trackingData.progress
                };

                if (existingIndex >= 0) {
                    // Update existing shipment
                    this.activeShipments[existingIndex] = shipment;
                    showToast('Shipment updated in active list', 'success');
                } else {
                    // Add new shipment
                    this.activeShipments.push(shipment);
                    showToast('Shipment added to active tracking', 'success');
                }

                // Save to localStorage
                this.saveActiveShipments();
                // Refresh the display
                this.loadActiveShipments();
            },

            saveActiveShipments() {
                try {
                    localStorage.setItem('nerva_active_shipments', JSON.stringify(this.activeShipments));
                } catch (error) {
                    console.error('Failed to save active shipments:', error);
                }
            },

            loadActiveShipmentsFromStorage() {
                try {
                    const saved = localStorage.getItem('nerva_active_shipments');
                    if (saved) {
                        this.activeShipments = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Failed to load active shipments:', error);
                    this.activeShipments = [];
                }
            },

            removeActiveShipment(shipmentId) {
                const index = this.activeShipments.findIndex(s => s.id === shipmentId);
                if (index >= 0) {
                    this.activeShipments.splice(index, 1);
                    this.saveActiveShipments();
                    this.loadActiveShipments();
                    showToast('Shipment removed from active tracking', 'success');
                }
            },

            async refreshShipment(shipmentId) {
                showToast('Refreshing shipment data...', 'info');
                
                const shipment = this.activeShipments.find(s => s.id === shipmentId);
                if (!shipment) return;

                try {
                    // Re-fetch tracking data
                    const updatedData = await this.fetchTrackingData(shipment.carrier.toLowerCase(), shipment.trackingNumber);
                    
                    // Update the shipment
                    this.addToActiveShipments(updatedData, shipment.carrier);
                    
                    showToast('Shipment data refreshed', 'success');
                } catch (error) {
                    console.error('Refresh error:', error);
                    showToast('Failed to refresh shipment data', 'error');
                }
            },

            // --- COSTING INTEGRATION METHODS ---
            linkTrackingToQuote(trackingNumber, quoteId) {
                // Link tracking information to existing quote
                const tracking = this.activeShipments.find(s => s.trackingNumber === trackingNumber);
                if (tracking) {
                    tracking.linkedQuote = quoteId;
                    showToast('Tracking linked to quote successfully', 'success');
                    this.updateCostingBasedOnTracking(tracking);
                }
            },

            updateCostingBasedOnTracking(tracking) {
                if (!tracking.linkedQuote) return;

                // Calculate potential cost impacts based on tracking status
                const costImpacts = this.calculateCostImpacts(tracking);
                
                if (costImpacts.length > 0) {
                    this.showCostingUpdates(costImpacts);
                }
            },

            calculateCostImpacts(tracking) {
                const impacts = [];
                
                // Check for delays
                if (tracking.status === 'Delayed') {
                    impacts.push({
                        type: 'delay',
                        description: 'Shipment delayed - potential demurrage costs',
                        estimatedCost: 500, // USD per day
                        severity: 'high'
                    });
                }
                
                // Check for customs hold
                if (tracking.status === 'Customs') {
                    impacts.push({
                        type: 'customs',
                        description: 'Customs clearance required - additional fees may apply',
                        estimatedCost: 200,
                        severity: 'medium'
                    });
                }
                
                // Check for port congestion
                if (tracking.location.includes('Port') && tracking.status === 'At Port') {
                    impacts.push({
                        type: 'port_congestion',
                        description: 'Port congestion detected - storage charges may apply',
                        estimatedCost: 100,
                        severity: 'medium'
                    });
                }
                
                return impacts;
            },

            showCostingUpdates(impacts) {
                // Create a notification showing cost impacts
                const impactSummary = impacts.map(impact => 
                    `${impact.description}: +$${impact.estimatedCost}`
                ).join('\n');
                
                showToast(`Cost Impact Alert:\n${impactSummary}`, 'warning');
                
                // Add a button to update the costing automatically
                this.addCostingUpdateButton(impacts);
            },

            addCostingUpdateButton(impacts) {
                const trackingResults = document.getElementById('tracking-results');
                if (!trackingResults) return;
                
                const updateButton = document.createElement('div');
                updateButton.className = 'mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
                updateButton.innerHTML = `
                    <h4 class="font-medium text-yellow-800 mb-2">⚠️ Cost Impact Detected</h4>
                    <p class="text-sm text-yellow-700 mb-3">Based on tracking data, additional costs may apply:</p>
                    <ul class="text-sm text-yellow-700 mb-3 space-y-1">
                        ${impacts.map(impact => `<li>• ${impact.description}: +$${impact.estimatedCost}</li>`).join('')}
                    </ul>
                    <button onclick="ShipmentTracker.applyCostingUpdates(${JSON.stringify(impacts).replace(/"/g, '&quot;')})" 
                            class="btn bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700">
                        Update Costing
                    </button>
                `;
                
                trackingResults.appendChild(updateButton);
            },

            applyCostingUpdates(impacts) {
                // Apply the cost updates to the current costing calculation
                impacts.forEach(impact => {
                    switch(impact.type) {
                        case 'delay':
                            this.addDelayCharges(impact.estimatedCost);
                            break;
                        case 'customs':
                            this.addCustomsCharges(impact.estimatedCost);
                            break;
                        case 'port_congestion':
                            this.addStorageCharges(impact.estimatedCost);
                            break;
                    }
                });
                
                showToast('Costing updated based on tracking data', 'success');
                
                // Switch to cost generator page to show updates
                App.switchPage('cost-generator-page');
            },

            addDelayCharges(amount) {
                // Add demurrage charges to the costing
                const demurrageInput = document.querySelector('#ocean-freight-section input[data-field="demurrage"]');
                if (demurrageInput) {
                    const currentValue = parseFloat(demurrageInput.value) || 0;
                    demurrageInput.value = currentValue + amount;
                    demurrageInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            },

            addCustomsCharges(amount) {
                // Add customs clearance charges
                const customsInput = document.querySelector('#destination-charges-section input[data-field="customsClearance"]');
                if (customsInput) {
                    const currentValue = parseFloat(customsInput.value) || 0;
                    customsInput.value = currentValue + amount;
                    customsInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            },

            addStorageCharges(amount) {
                // Add storage charges
                const storageInput = document.querySelector('#destination-charges-section input[data-field="storage"]');
                if (storageInput) {
                    const currentValue = parseFloat(storageInput.value) || 0;
                    storageInput.value = currentValue + amount;
                    storageInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            },

            // Method to auto-populate costing from tracking data
            populateCostingFromTracking(trackingData) {
                // Extract relevant information from tracking data
                const route = this.extractRouteInfo(trackingData);
                const vessel = trackingData.vessel;
                const eta = trackingData.eta;
                
                // Populate shipment details
                if (route.origin) {
                    const originInput = document.querySelector('#shipment-details input[data-field="origin"]');
                    if (originInput && !originInput.value) {
                        originInput.value = route.origin;
                        originInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                
                if (route.destination) {
                    const destinationInput = document.querySelector('#shipment-details input[data-field="destination"]');
                    if (destinationInput && !destinationInput.value) {
                        destinationInput.value = route.destination;
                        destinationInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                
                // Set estimated delivery date
                if (eta) {
                    const etaInput = document.querySelector('#shipment-details input[data-field="eta"]');
                    if (etaInput) {
                        etaInput.value = eta;
                        etaInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
                
                showToast('Costing populated from tracking data', 'success');
            },

            viewShipmentDetails(shipmentId) {
                const shipment = this.activeShipments.find(s => s.id === shipmentId);
                if (!shipment) return;

                // Simulate loading the tracking details
                this.fetchTrackingData(shipment.carrier.toLowerCase(), shipment.trackingNumber)
                    .then(data => this.displayTrackingResults(data))
                    .catch(error => showToast('Failed to load shipment details', 'error'));
            },

            extractRouteInfo(trackingData) {
                // Extract origin and destination from tracking events
                const events = trackingData.events || [];
                const firstEvent = events[0];
                const lastEvent = events[events.length - 1];
                
                return {
                    origin: firstEvent?.location || 'Unknown Origin',
                    destination: lastEvent?.location || 'Unknown Destination'
                };
            }
        };

        // --- VESSEL SCHEDULE SYSTEM ---
        const VesselScheduler = {
            scheduleData: [],
            filteredData: [],
            activeCarrierFilter: 'all',

            // Mock schedule data - in production this would come from real APIs
            mockSchedules: [
                {
                    id: 'MSC_AMSTERDAM_20250115',
                    carrier: 'MSC',
                    vessel: 'MSC AMSTERDAM',
                    service: 'Silk Service',
                    origin: 'CNSHA',
                    originName: 'Shanghai, China',
                    destination: 'ZADUR',
                    destinationName: 'Durban, South Africa',
                    departure: '2025-01-15T14:00:00Z',
                    arrival: '2025-02-05T08:00:00Z',
                    transitTime: 21,
                    frequency: 'Weekly',
                    cutOff: '2025-01-13T12:00:00Z',
                    vesselSize: '14,000 TEU',
                    status: 'Confirmed',
                    ports: [
                        { port: 'CNSHA', name: 'Shanghai', arrival: null, departure: '2025-01-15T14:00:00Z' },
                        { port: 'CNNGB', name: 'Ningbo', arrival: '2025-01-16T08:00:00Z', departure: '2025-01-16T18:00:00Z' },
                        { port: 'SGSIN', name: 'Singapore', arrival: '2025-01-22T12:00:00Z', departure: '2025-01-23T06:00:00Z' },
                        { port: 'ZADUR', name: 'Durban', arrival: '2025-02-05T08:00:00Z', departure: null }
                    ]
                },
                {
                    id: 'MAERSK_CAPE_TOWN_20250118',
                    carrier: 'Maersk',
                    vessel: 'MAERSK CAPE TOWN',
                    service: 'AE7/EA7',
                    origin: 'NLRTM',
                    originName: 'Rotterdam, Netherlands',
                    destination: 'ZACPT',
                    destinationName: 'Cape Town, South Africa',
                    departure: '2025-01-18T16:00:00Z',
                    arrival: '2025-02-02T10:00:00Z',
                    transitTime: 15,
                    frequency: 'Weekly',
                    cutOff: '2025-01-16T15:00:00Z',
                    vesselSize: '18,000 TEU',
                    status: 'Confirmed',
                    ports: [
                        { port: 'NLRTM', name: 'Rotterdam', arrival: null, departure: '2025-01-18T16:00:00Z' },
                        { port: 'DEHAM', name: 'Hamburg', arrival: '2025-01-19T08:00:00Z', departure: '2025-01-19T20:00:00Z' },
                        { port: 'GBFXT', name: 'Felixstowe', arrival: '2025-01-21T06:00:00Z', departure: '2025-01-21T14:00:00Z' },
                        { port: 'ZACPT', name: 'Cape Town', arrival: '2025-02-02T10:00:00Z', departure: null }
                    ]
                },
                {
                    id: 'CMA_CGM_DURBAN_20250120',
                    carrier: 'CMA CGM',
                    vessel: 'CMA CGM BOUGAINVILLE',
                    service: 'FAL1',
                    origin: 'CNSHA',
                    originName: 'Shanghai, China',
                    destination: 'ZADUR',
                    destinationName: 'Durban, South Africa',
                    departure: '2025-01-20T12:00:00Z',
                    arrival: '2025-02-12T14:00:00Z',
                    transitTime: 23,
                    frequency: 'Weekly',
                    cutOff: '2025-01-18T10:00:00Z',
                    vesselSize: '16,000 TEU',
                    status: 'Confirmed',
                    ports: [
                        { port: 'CNSHA', name: 'Shanghai', arrival: null, departure: '2025-01-20T12:00:00Z' },
                        { port: 'HKHKG', name: 'Hong Kong', arrival: '2025-01-22T16:00:00Z', departure: '2025-01-23T02:00:00Z' },
                        { port: 'SGSIN', name: 'Singapore', arrival: '2025-01-26T20:00:00Z', departure: '2025-01-27T08:00:00Z' },
                        { port: 'ZADUR', name: 'Durban', arrival: '2025-02-12T14:00:00Z', departure: null }
                    ]
                },
                {
                    id: 'HAPAG_LLOYD_20250122',
                    carrier: 'Hapag-Lloyd',
                    vessel: 'HAMBURG EXPRESS',
                    service: 'AS1',
                    origin: 'DEHAM',
                    originName: 'Hamburg, Germany',
                    destination: 'ZADUR',
                    destinationName: 'Durban, South Africa',
                    departure: '2025-01-22T20:00:00Z',
                    arrival: '2025-02-08T12:00:00Z',
                    transitTime: 17,
                    frequency: 'Weekly',
                    cutOff: '2025-01-20T16:00:00Z',
                    vesselSize: '13,500 TEU',
                    status: 'Confirmed',
                    ports: [
                        { port: 'DEHAM', name: 'Hamburg', arrival: null, departure: '2025-01-22T20:00:00Z' },
                        { port: 'NLRTM', name: 'Rotterdam', arrival: '2025-01-23T14:00:00Z', departure: '2025-01-24T02:00:00Z' },
                        { port: 'GBFXT', name: 'Felixstowe', arrival: '2025-01-25T10:00:00Z', departure: '2025-01-25T18:00:00Z' },
                        { port: 'ZADUR', name: 'Durban', arrival: '2025-02-08T12:00:00Z', departure: null }
                    ]
                },
                {
                    id: 'COSCO_SINGAPORE_20250125',
                    carrier: 'COSCO',
                    vessel: 'COSCO SINGAPORE',
                    service: 'ASF',
                    origin: 'CNSHA',
                    originName: 'Shanghai, China',
                    destination: 'ZACPT',
                    destinationName: 'Cape Town, South Africa',
                    departure: '2025-01-25T08:00:00Z',
                    arrival: '2025-02-18T16:00:00Z',
                    transitTime: 24,
                    frequency: 'Weekly',
                    cutOff: '2025-01-23T14:00:00Z',
                    vesselSize: '12,500 TEU',
                    status: 'Confirmed',
                    ports: [
                        { port: 'CNSHA', name: 'Shanghai', arrival: null, departure: '2025-01-25T08:00:00Z' },
                        { port: 'CNQIN', name: 'Qingdao', arrival: '2025-01-26T12:00:00Z', departure: '2025-01-27T00:00:00Z' },
                        { port: 'KRPUS', name: 'Busan', arrival: '2025-01-28T16:00:00Z', departure: '2025-01-29T04:00:00Z' },
                        { port: 'SGSIN', name: 'Singapore', arrival: '2025-02-02T08:00:00Z', departure: '2025-02-03T00:00:00Z' },
                        { port: 'ZACPT', name: 'Cape Town', arrival: '2025-02-18T16:00:00Z', departure: null }
                    ]
                }
            ],

            popularRoutes: [
                { route: 'Shanghai → Durban', searches: 1250, avgTransit: '21 days' },
                { route: 'Rotterdam → Cape Town', searches: 890, avgTransit: '15 days' },
                { route: 'Hamburg → Durban', searches: 750, avgTransit: '17 days' },
                { route: 'Singapore → Durban', searches: 650, avgTransit: '18 days' },
                { route: 'Hong Kong → Cape Town', searches: 540, avgTransit: '22 days' },
                { route: 'Ningbo → Port Elizabeth', searches: 420, avgTransit: '20 days' }
            ],

            init() {
                this.scheduleData = [...this.mockSchedules];
                this.filteredData = [...this.scheduleData];
                this.loadPopularRoutes();
                this.loadLiveUpdates();
                this.bindScheduleEvents();
                this.generateMoreSchedules();
            },

            bindScheduleEvents() {
                const searchBtn = document.getElementById('search-schedules-btn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.searchSchedules());
                }

                // Carrier filter buttons
                document.querySelectorAll('.carrier-filter').forEach(btn => {
                    btn.addEventListener('click', (e) => this.filterByCarrier(e.target.dataset.carrier));
                });

                // Enter key search
                ['schedule-origin', 'schedule-destination'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('change', () => this.searchSchedules());
                    }
                });
            },

            generateMoreSchedules() {
                // Generate additional mock schedules for different routes
                const carriers = ['MSC', 'Maersk', 'CMA CGM', 'Hapag-Lloyd', 'COSCO', 'Evergreen', 'OOCL'];
                const origins = [
                    { code: 'CNSHA', name: 'Shanghai, China' },
                    { code: 'CNNGB', name: 'Ningbo, China' },
                    { code: 'SGSIN', name: 'Singapore' },
                    { code: 'NLRTM', name: 'Rotterdam, Netherlands' },
                    { code: 'DEHAM', name: 'Hamburg, Germany' },
                    { code: 'USNYC', name: 'New York, USA' }
                ];
                const destinations = [
                    { code: 'ZADUR', name: 'Durban, South Africa' },
                    { code: 'ZACPT', name: 'Cape Town, South Africa' },
                    { code: 'ZAELZ', name: 'Port Elizabeth, South Africa' }
                ];

                for (let i = 0; i < 20; i++) {
                    const carrier = carriers[Math.floor(Math.random() * carriers.length)];
                    const origin = origins[Math.floor(Math.random() * origins.length)];
                    const destination = destinations[Math.floor(Math.random() * destinations.length)];
                    
                    const departureDate = new Date();
                    departureDate.setDate(departureDate.getDate() + Math.floor(Math.random() * 30) + 5);
                    
                    const transitTime = Math.floor(Math.random() * 15) + 10;
                    const arrivalDate = new Date(departureDate);
                    arrivalDate.setDate(arrivalDate.getDate() + transitTime);

                    this.scheduleData.push({
                        id: `${carrier}_${origin.code}_${destination.code}_${departureDate.getTime()}`,
                        carrier: carrier,
                        vessel: `${carrier} ${this.generateVesselName()}`,
                        service: `${carrier}${Math.floor(Math.random() * 10) + 1}`,
                        origin: origin.code,
                        originName: origin.name,
                        destination: destination.code,
                        destinationName: destination.name,
                        departure: departureDate.toISOString(),
                        arrival: arrivalDate.toISOString(),
                        transitTime: transitTime,
                        frequency: 'Weekly',
                        cutOff: new Date(departureDate.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                        vesselSize: `${Math.floor(Math.random() * 10000) + 8000} TEU`,
                        status: 'Confirmed'
                    });
                }

                this.filteredData = [...this.scheduleData];
            },

            generateVesselName() {
                const names = ['NAVIGATOR', 'EXPLORER', 'PIONEER', 'VOYAGER', 'CHAMPION', 'EXPRESS', 'GLORY', 'STAR', 'PEARL', 'DIAMOND'];
                return names[Math.floor(Math.random() * names.length)];
            },

            searchSchedules() {
                const origin = document.getElementById('schedule-origin').value;
                const destination = document.getElementById('schedule-destination').value;
                const timeframe = parseInt(document.getElementById('schedule-timeframe').value);

                if (!origin || !destination) {
                    showToast('Please select both origin and destination ports', 'error');
                    return;
                }

                showToast('Searching schedules...', 'info');

                // Filter schedules
                this.filteredData = this.scheduleData.filter(schedule => {
                    const matchesRoute = schedule.origin === origin && schedule.destination === destination;
                    const departureDate = new Date(schedule.departure);
                    const now = new Date();
                    const maxDate = new Date();
                    maxDate.setDate(now.getDate() + timeframe);
                    const isInTimeframe = departureDate >= now && departureDate <= maxDate;
                    
                    return matchesRoute && isInTimeframe;
                });

                this.applyCarrierFilter();
                this.displayScheduleResults();
            },

            filterByCarrier(carrier) {
                this.activeCarrierFilter = carrier;
                
                // Update filter button states
                document.querySelectorAll('.carrier-filter').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-100', 'text-blue-800');
                    btn.classList.add('bg-gray-100', 'text-gray-800');
                });
                
                document.querySelector(`[data-carrier="${carrier}"]`).classList.add('active', 'bg-blue-100', 'text-blue-800');
                document.querySelector(`[data-carrier="${carrier}"]`).classList.remove('bg-gray-100', 'text-gray-800');

                this.applyCarrierFilter();
                this.displayScheduleResults();
            },

            applyCarrierFilter() {
                if (this.activeCarrierFilter === 'all') return;
                
                this.filteredData = this.filteredData.filter(schedule => 
                    schedule.carrier.toLowerCase().replace(/[^a-z]/g, '') === this.activeCarrierFilter.toLowerCase().replace(/[^a-z]/g, '')
                );
            },

            displayScheduleResults() {
                const resultsDiv = document.getElementById('schedule-results');
                const listDiv = document.getElementById('schedule-list');
                const countSpan = document.getElementById('results-count');

                if (!resultsDiv || !listDiv || !countSpan) return;

                countSpan.textContent = `${this.filteredData.length} schedules found`;

                if (this.filteredData.length === 0) {
                    listDiv.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <p class="mt-2 text-sm">No schedules found for this route</p>
                            <p class="text-xs text-gray-400">Try different ports or timeframe</p>
                        </div>
                    `;
                } else {
                    listDiv.innerHTML = this.filteredData.map(schedule => this.renderScheduleCard(schedule)).join('');
                }

                resultsDiv.style.display = 'block';
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            },

            renderScheduleCard(schedule) {
                const departure = new Date(schedule.departure);
                const arrival = new Date(schedule.arrival);
                const cutOff = new Date(schedule.cutOff);

                return `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow bg-white">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${this.getCarrierColor(schedule.carrier)}">${schedule.carrier}</span>
                                    <span class="text-sm font-medium text-gray-800">${schedule.vessel}</span>
                                    <span class="text-xs text-gray-500">${schedule.service}</span>
                                </div>
                                <div class="text-lg font-semibold text-gray-800">
                                    ${schedule.originName} → ${schedule.destinationName}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">${schedule.transitTime} days</div>
                                <div class="text-xs text-gray-500">${schedule.vesselSize}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Departure</div>
                                <div class="font-medium">${departure.toLocaleDateString()}</div>
                                <div class="text-sm text-gray-600">${departure.toLocaleTimeString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Arrival</div>
                                <div class="font-medium">${arrival.toLocaleDateString()}</div>
                                <div class="text-sm text-gray-600">${arrival.toLocaleTimeString()}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Cut-off</div>
                                <div class="font-medium">${cutOff.toLocaleDateString()}</div>
                                <div class="text-sm text-gray-600">${cutOff.toLocaleTimeString()}</div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t">
                            <div class="flex items-center space-x-4 text-xs text-gray-500">
                                <span>📅 ${schedule.frequency}</span>
                                <span>✅ ${schedule.status}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="VesselScheduler.selectSchedule('${schedule.id}')" 
                                        class="btn bg-green-600 text-white px-4 py-2 text-sm rounded-md hover:bg-green-700">
                                    💰 Get Quote
                                </button>
                                <button onclick="VesselScheduler.viewScheduleDetails('${schedule.id}')" 
                                        class="btn bg-blue-600 text-white px-4 py-2 text-sm rounded-md hover:bg-blue-700">
                                    👁️ Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            getCarrierColor(carrier) {
                const colors = {
                    'MSC': 'bg-blue-100 text-blue-800',
                    'Maersk': 'bg-cyan-100 text-cyan-800',
                    'CMA CGM': 'bg-red-100 text-red-800',
                    'Hapag-Lloyd': 'bg-orange-100 text-orange-800',
                    'COSCO': 'bg-purple-100 text-purple-800',
                    'Evergreen': 'bg-green-100 text-green-800',
                    'OOCL': 'bg-pink-100 text-pink-800'
                };
                return colors[carrier] || 'bg-gray-100 text-gray-800';
            },

            loadPopularRoutes() {
                const routesGrid = document.getElementById('popular-routes-grid');
                if (!routesGrid) return;

                routesGrid.innerHTML = this.popularRoutes.map(route => `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                         onclick="VesselScheduler.selectPopularRoute('${route.route}')">
                        <h4 class="font-medium text-gray-800 mb-2">${route.route}</h4>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>🔍 ${route.searches} searches</span>
                            <span>⏱️ ${route.avgTransit}</span>
                        </div>
                    </div>
                `).join('');
            },

            loadLiveUpdates() {
                const updatesDiv = document.getElementById('live-updates');
                if (!updatesDiv) return;

                const updates = [
                    { time: '2 mins ago', message: 'MSC AMSTERDAM departed Shanghai on schedule', type: 'departure' },
                    { time: '15 mins ago', message: 'MAERSK CAPE TOWN delayed 4 hours at Hamburg', type: 'delay' },
                    { time: '32 mins ago', message: 'New weekly service: CMA CGM FAL2 Shanghai-Durban', type: 'new' },
                    { time: '1 hour ago', message: 'COSCO SINGAPORE arrived Singapore ahead of schedule', type: 'arrival' },
                    { time: '2 hours ago', message: 'Cut-off extended for HAPAG EXPRESS to Jan 21, 18:00', type: 'cutoff' }
                ];

                updatesDiv.innerHTML = updates.map(update => `
                    <div class="flex items-start space-x-3 p-3 border rounded-lg">
                        <div class="flex-shrink-0 w-2 h-2 rounded-full mt-2 ${this.getUpdateColor(update.type)}"></div>
                        <div class="flex-1">
                            <p class="text-sm text-gray-800">${update.message}</p>
                            <p class="text-xs text-gray-500">${update.time}</p>
                        </div>
                    </div>
                `).join('');
            },

            getUpdateColor(type) {
                const colors = {
                    'departure': 'bg-green-500',
                    'arrival': 'bg-blue-500',
                    'delay': 'bg-red-500',
                    'new': 'bg-purple-500',
                    'cutoff': 'bg-yellow-500'
                };
                return colors[type] || 'bg-gray-500';
            },

            selectPopularRoute(route) {
                const [origin, destination] = route.split(' → ');
                
                // Map display names to port codes
                const portMap = {
                    'Shanghai': 'CNSHA',
                    'Durban': 'ZADUR',
                    'Rotterdam': 'NLRTM',
                    'Cape Town': 'ZACPT',
                    'Hamburg': 'DEHAM',
                    'Singapore': 'SGSIN',
                    'Hong Kong': 'HKHKG',
                    'Port Elizabeth': 'ZAELZ'
                };

                const originSelect = document.getElementById('schedule-origin');
                const destinationSelect = document.getElementById('schedule-destination');

                if (originSelect && destinationSelect) {
                    originSelect.value = portMap[origin] || '';
                    destinationSelect.value = portMap[destination] || '';
                    this.searchSchedules();
                }
            },

            selectSchedule(scheduleId) {
                const schedule = this.scheduleData.find(s => s.id === scheduleId);
                if (!schedule) return;

                // Populate costing form with schedule data
                this.populateCostingFromSchedule(schedule);
                
                showToast('Schedule selected - creating quote...', 'success');
                App.switchPage('cost-generator-page');
            },

            populateCostingFromSchedule(schedule) {
                // Populate origin and destination
                const originInput = document.querySelector('#shipment-details input[data-field="pol"]');
                const destinationInput = document.querySelector('#shipment-details input[data-field="pod"]');
                
                if (originInput) {
                    originInput.value = schedule.originName;
                    originInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                if (destinationInput) {
                    destinationInput.value = schedule.destinationName;
                    destinationInput.dispatchEvent(new Event('input', { bubbles: true }));
                }

                // Set estimated transit time
                const transitInput = document.querySelector('#shipment-details input[data-field="transitTime"]');
                if (transitInput) {
                    transitInput.value = schedule.transitTime;
                    transitInput.dispatchEvent(new Event('input', { bubbles: true }));
                }

                // Set departure date
                const departureInput = document.querySelector('#shipment-details input[data-field="etd"]');
                if (departureInput) {
                    const departureDate = new Date(schedule.departure);
                    departureInput.value = departureDate.toISOString().split('T')[0];
                    departureInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            },

            viewScheduleDetails(scheduleId) {
                const schedule = this.scheduleData.find(s => s.id === scheduleId);
                if (!schedule) return;

                // Create detailed modal or expand card with port rotation
                showToast(`Viewing details for ${schedule.vessel}`, 'info');
                // Implementation for detailed view would go here
            }
        };

        // --- AUTHENTICATION SYSTEM ---
        const AuthSystem = {
            currentUser: null,
            isAuthenticated: false,

            init() {
                this.bindAuthEvents();
                this.checkAuthState();
            },

            bindAuthEvents() {
                // Tab switching
                document.getElementById('login-tab').addEventListener('click', () => this.switchTab('login'));
                document.getElementById('register-tab').addEventListener('click', () => this.switchTab('register'));

                // Form submissions
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('register-form').addEventListener('submit', (e) => this.handleRegister(e));

                // Demo access
                document.getElementById('demo-access-btn').addEventListener('click', () => this.accessDemo());

                // Social login
                document.getElementById('google-login-btn').addEventListener('click', () => this.handleGoogleLogin());
            },

            switchTab(tab) {
                const loginTab = document.getElementById('login-tab');
                const registerTab = document.getElementById('register-tab');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');

                if (tab === 'login') {
                    loginTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                    loginTab.classList.remove('text-gray-500');
                    registerTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                    registerTab.classList.add('text-gray-500');
                    
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                } else {
                    registerTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                    registerTab.classList.remove('text-gray-500');
                    loginTab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                    loginTab.classList.add('text-gray-500');
                    
                    registerForm.style.display = 'block';
                    loginForm.style.display = 'none';
                }
            },

            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const loginBtn = document.getElementById('login-btn');

                try {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Signing In...';

                    // For now, simulate authentication
                    await this.simulateAuth();
                    
                    this.currentUser = {
                        email: email,
                        name: email.split('@')[0],
                        company: 'Demo Company',
                        id: 'user_' + Date.now()
                    };

                    this.isAuthenticated = true;
                    localStorage.setItem('nerva_user', JSON.stringify(this.currentUser));
                    localStorage.setItem('nerva_auth', 'true');

                    showToast('Welcome back! 🎉', 'success');
                    this.hideAuthOverlay();

                } catch (error) {
                    console.error('Login error:', error);
                    showToast('Login failed. Please try again.', 'error');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            },

            async handleRegister(e) {
                e.preventDefault();
                const firstName = document.getElementById('register-firstname').value;
                const lastName = document.getElementById('register-lastname').value;
                const company = document.getElementById('register-company').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const registerBtn = document.getElementById('register-btn');

                try {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Creating Account...';

                    // For now, simulate registration
                    await this.simulateAuth();
                    
                    this.currentUser = {
                        email: email,
                        name: `${firstName} ${lastName}`,
                        company: company || 'Your Company',
                        id: 'user_' + Date.now(),
                        firstName,
                        lastName
                    };

                    this.isAuthenticated = true;
                    localStorage.setItem('nerva_user', JSON.stringify(this.currentUser));
                    localStorage.setItem('nerva_auth', 'true');

                    showToast('Account created successfully! Welcome to Nerva ERP! 🚀', 'success');
                    this.hideAuthOverlay();

                } catch (error) {
                    console.error('Registration error:', error);
                    showToast('Registration failed. Please try again.', 'error');
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Create Account';
                }
            },

            async accessDemo() {
                const demoBtn = document.getElementById('demo-access-btn');
                
                try {
                    demoBtn.disabled = true;
                    demoBtn.textContent = 'Loading Demo...';

                    await this.simulateAuth();
                    
                    this.currentUser = {
                        email: 'demo@nerva-erp.com',
                        name: 'Demo User',
                        company: 'Demo Company Ltd',
                        id: 'demo_user',
                        isDemo: true
                    };

                    this.isAuthenticated = true;
                    localStorage.setItem('nerva_user', JSON.stringify(this.currentUser));
                    localStorage.setItem('nerva_auth', 'demo');

                    showToast('Welcome to the Nerva ERP Demo! 🎯', 'success');
                    this.hideAuthOverlay();

                } catch (error) {
                    console.error('Demo access error:', error);
                    showToast('Demo access failed. Please try again.', 'error');
                } finally {
                    demoBtn.disabled = false;
                    demoBtn.textContent = 'Access Demo Account';
                }
            },

            async handleGoogleLogin() {
                const googleBtn = document.getElementById('google-login-btn');
                
                try {
                    googleBtn.disabled = true;
                    googleBtn.innerHTML = 'Connecting...';

                    // Simulate Google OAuth
                    await this.simulateAuth();
                    
                    this.currentUser = {
                        email: 'user@gmail.com',
                        name: 'Google User',
                        company: 'Google Account',
                        id: 'google_user_' + Date.now(),
                        provider: 'google'
                    };

                    this.isAuthenticated = true;
                    localStorage.setItem('nerva_user', JSON.stringify(this.currentUser));
                    localStorage.setItem('nerva_auth', 'google');

                    showToast('Successfully signed in with Google! 🎉', 'success');
                    this.hideAuthOverlay();

                } catch (error) {
                    console.error('Google login error:', error);
                    showToast('Google sign-in failed. Please try again.', 'error');
                } finally {
                    googleBtn.disabled = false;
                    googleBtn.innerHTML = `
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google
                    `;
                }
            },

            checkAuthState() {
                const authState = localStorage.getItem('nerva_auth');
                const userData = localStorage.getItem('nerva_user');

                if (authState && userData) {
                    try {
                        this.currentUser = JSON.parse(userData);
                        this.isAuthenticated = true;
                        this.hideAuthOverlay();
                        
                        if (this.currentUser.isDemo) {
                            showToast('Welcome back to the demo! 🎯', 'info');
                        } else {
                            showToast(`Welcome back, ${this.currentUser.name}! 👋`, 'success');
                        }
                    } catch (error) {
                        console.error('Error parsing stored user data:', error);
                        this.logout();
                    }
                }
            },

            hideAuthOverlay() {
                const overlay = document.getElementById('auth-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                // Update UI with user info
                this.updateUserUI();
            },

            showAuthOverlay() {
                const overlay = document.getElementById('auth-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            },

            updateUserUI() {
                // Update user info in header or sidebar
                const userInfo = document.createElement('div');
                userInfo.className = 'border-t border-gray-200 p-3 mt-auto user-info';
                userInfo.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">${this.currentUser.name.charAt(0).toUpperCase()}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-700 truncate">${this.currentUser.name}</p>
                            <p class="text-xs text-gray-500 truncate">${this.currentUser.company}</p>
                        </div>
                        <button id="logout-btn" class="text-gray-400 hover:text-gray-600 transition-colors" title="Logout">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                `;

                // Find sidebar and add user info
                const sidebar = document.querySelector('aside nav');
                if (sidebar && !document.querySelector('.user-info')) {
                    sidebar.parentElement.appendChild(userInfo);
                    
                    // Add event listener to logout button
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => {
                            if (confirm('Are you sure you want to logout?')) {
                                this.logout();
                            }
                        });
                    }
                }
            },

            logout() {
                localStorage.removeItem('nerva_auth');
                localStorage.removeItem('nerva_user');
                this.currentUser = null;
                this.isAuthenticated = false;
                
                // Remove user UI
                const userInfo = document.querySelector('.user-info');
                if (userInfo) {
                    userInfo.remove();
                }
                
                showToast('You have been logged out. See you soon! 👋', 'info');
                this.showAuthOverlay();
            },

            simulateAuth() {
                // Simulate network delay
                return new Promise(resolve => setTimeout(resolve, 1500));
            }
        };

        // --- CORE APP LOGIC ---
        const App = {
            db: null,
            userId: null,
            quotesCollection: null,
            requestsCollection: null,

            elements: {
                pageTitle: document.getElementById('page-title'),
                headerButtons: document.getElementById('header-buttons'),
                pages: document.querySelectorAll('.page'),
                sidebarNav: document.getElementById('sidebar-nav'),
            },

            async init() {
                try {
                    console.log('🚀 Starting app initialization...');
                    
                    console.log('📡 Initializing Firebase...');
                    await this.initFirebase(); 
                    
                    console.log('💱 Initializing exchange rates...');
                    await this.initExchangeRates();
                    
                    console.log('📝 Generating form inputs...');
                    this.generateInputs();
                    
                    // Small delay to ensure DOM elements are ready
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    console.log('🔄 Updating display...');
                    this.updateDisplay();
                    
                    console.log('🎯 Attaching event listeners...');
                    this.attachEventListeners();
                    
                    console.log('📄 Handling initial page load...');
                    this.handleInitialPageLoad();
                    
                    if (this.db) {
                        console.log('🔄 Setting up real-time listeners...');
                        this.listenForQuotes();
                        this.listenForCostRequests();
                    } else {
                        console.log('💾 Loading local quotes (offline mode)...');
                        this.loadLocalQuotes();
                    }
                    
                    console.log('✅ App initialization completed successfully!');
                    showToast('Application loaded successfully! 🎉', 'success');
                    
                } catch (error) {
                    console.error('❌ App initialization failed:', error);
                    showToast('Application failed to load. Check console for details.', 'error');
                    throw error; // Re-throw to be caught by outer try-catch
                }
            },

            async initExchangeRates() {
                try {
                    const rates = await exchangeRateService.initializeRates();
                    state.exchangeRates = rates;
                    
                    // Update the display if exchange rates section is visible
                    setTimeout(() => {
                        this.updateExchangeRatesDisplay();
                    }, 100);
                } catch (error) {
                    console.error('Failed to initialize exchange rates:', error);
                    showToast('Using default exchange rates', 'warning');
                }
            },

            updateExchangeRatesDisplay() {
                const container = document.getElementById('exchange-rates');
                if (container) {
                    // Clear and regenerate exchange rates section
                    container.innerHTML = '';
                    container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
                    
                    // Create currency blocks for USD, EUR, GBP
                    const currencies = [
                        { code: 'USD', rateKey: 'usd', amountKey: 'usdAmount', symbol: '$', flag: '🇺🇸' },
                        { code: 'EUR', rateKey: 'eur', amountKey: 'eurAmount', symbol: '€', flag: '🇪🇺' },
                        { code: 'GBP', rateKey: 'gbp', amountKey: 'gbpAmount', symbol: '£', flag: '🇬🇧' }
                    ];

                    currencies.forEach(currency => {
                        const rate = state.exchangeRates[currency.rateKey];
                        const amount = state.currencyAmounts[currency.amountKey];
                        
                        // Calculate ZAR equivalent
                        const zarEquivalent = (parseFloat(amount.value) * parseFloat(rate.value)).toFixed(2);
                        
                        const currencyBlock = document.createElement('div');
                        currencyBlock.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                        currencyBlock.innerHTML = `
                            <div class="text-center mb-3">
                                <div class="text-lg font-semibold text-gray-800">
                                    ${currency.flag} ${currency.code}
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <!-- Exchange Rate -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        Exchange Rate (${currency.code} to ZAR)
                                    </label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${rate.value}"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-50"
                                        onchange="App.updateExchangeRate('${currency.rateKey}', this.value, this)"
                                        readonly
                                    >
                                </div>
                                
                                <!-- Currency Amount -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">
                                        ${currency.code} Amount
                                    </label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value="${amount.value}"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="App.updateCurrencyAmount('${currency.amountKey}', this.value, this)"
                                        placeholder="Enter ${currency.code} amount"
                                    >
                                </div>
                                
                                <!-- ZAR Equivalent -->
                                <div class="bg-green-50 border border-green-200 rounded-md p-2">
                                    <div class="text-xs font-medium text-green-700 mb-1">ZAR Equivalent</div>
                                    <div class="text-lg font-bold text-green-800">
                                        R ${formatCurrency(zarEquivalent, 'ZAR').replace('ZAR', '').trim()}
                                    </div>
                                    <div class="text-xs text-green-600">
                                        ${currency.symbol}${amount.value} × ${rate.value}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(currencyBlock);
                    });
                    
                    // Add last updated info and refresh button
                    const lastUpdate = exchangeRateService.getLastUpdateTime();
                    const isExpired = exchangeRateService.isCacheExpired();
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'col-span-full text-sm text-gray-600 border-t pt-3 mt-3';
                    infoDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div>Last updated: ${lastUpdate}</div>
                                <div class="text-xs ${isExpired ? 'text-yellow-600' : 'text-green-600'}">
                                    ${isExpired ? '⚠️ Rates may be outdated' : '✅ Rates are current'}
                                </div>
                            </div>
                            <button onclick="App.refreshExchangeRates()" class="btn text-xs px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                🔄 Refresh Rates
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Rates are live spot price × 2 | Source: ExchangeRate-API
                        </div>
                    `;
                    container.appendChild(infoDiv);
                }
            },

            async refreshExchangeRates() {
                try {
                    const rates = await exchangeRateService.fetchAllRates();
                    state.exchangeRates = rates;
                    this.updateExchangeRatesDisplay();
                    this.updateDisplay(); // Recalculate all costs with new rates
                } catch (error) {
                    console.error('Failed to refresh exchange rates:', error);
                    showToast('Failed to refresh rates', 'error');
                }
            },

            updateCurrencyAmount(amountKey, value, element = null) {
                const validation = ValidationUtil.validateCurrencyAmount(value);
                
                if (!validation.isValid) {
                    ValidationUtil.showValidationError(validation.message, element);
                    return false; // Don't update if invalid
                }
                
                // Clear any previous validation errors
                if (element) ValidationUtil.clearValidationError(element);
                
                state.currencyAmounts[amountKey].value = value;
                this.updateExchangeRatesDisplay(); // Refresh to show new ZAR calculations
                this.updateDisplay(); // Update any cost calculations that might use these amounts
                return true;
            },

            updateExchangeRate(rateKey, value, element = null) {
                const validation = ValidationUtil.validateExchangeRate(rateKey, value);
                
                if (!validation.isValid) {
                    ValidationUtil.showValidationError(validation.message, element);
                    return false; // Don't update if invalid
                }
                
                // Clear any previous validation errors
                if (element) ValidationUtil.clearValidationError(element);
                
                state.exchangeRates[rateKey].value = value;
                this.updateExchangeRatesDisplay(); // Refresh to show new ZAR calculations
                this.updateDisplay(); // Recalculate all costs with new rate
                return true;
            },

            async initFirebase() {
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    if (!firebaseConfig.apiKey) {
                        throw new Error("Firebase config is missing or invalid.");
                    }
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    const auth = getAuth(app);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                    this.userId = auth.currentUser.uid;
                    this.quotesCollection = collection(this.db, "quotes");
                    this.requestsCollection = collection(this.db, "cost_requests");
                } catch(e) {
                    console.error("Firebase initialization failed:", e);
                }
            },

            switchPage(pageId) {
                if (!pageId) return;
                
                this.elements.headerButtons.innerHTML = ''; 
                if (pageId === 'cost-generator-page') {
                    this.elements.headerButtons.innerHTML = `
                        <button id="save-quote-button" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900 border border-gray-300">
                            <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                            Save Quote
                        </button>
                        <button id="pdf-button" class="nerva-nav-item group flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 hover:text-gray-900 border border-gray-300">
                            <svg class="text-gray-400 mr-3 h-5 w-5 group-hover:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Generate PDF
                        </button>`;
                }
                
                this.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                document.querySelectorAll('.nerva-nav-item').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
                
                const pageIcons = {
                    'dashboard-page': '📊 Dashboard',
                    'cost-generator-page': '💰 Cost Generator', 
                    'cost-request-page': '📝 Cost Request',
                    'tracking-page': '🚢 Shipment Tracking',
                    'schedules-page': '🚢 Live Schedules',
                    'avatar-page': '🤖 Supply Chain Expert'
                };
                
                this.elements.pageTitle.textContent = pageIcons[pageId] || 'Dashboard';
                
                // Load page-specific content
                if (pageId === 'dashboard-page') {
                    setTimeout(() => this.loadTemplateGrid(), 100);
                }
                
                if (pageId === 'tracking-page') {
                    setTimeout(() => ShipmentTracker.init(), 100);
                }
                
                if (pageId === 'schedules-page') {
                    setTimeout(() => VesselScheduler.init(), 100);
                }
                
                if (pageId === 'avatar-page') {
                    // Avatar page now uses CSS animations instead of 3D
                    console.log('🤖 Supply Chain Expert page loaded');
                    setTimeout(() => SupplyChainChat.init(), 100);
                }
            },
            
            attachEventListeners() {
                this.elements.sidebarNav.addEventListener('click', (e) => {
                    if (e.target && e.target.matches('a.nerva-nav-item')) {
                        e.preventDefault();
                        const pageId = e.target.dataset.page;
                        if(pageId) {
                           window.location.hash = e.target.hash;
                           this.switchPage(pageId);
                        }
                    }
                });
                
                this.elements.headerButtons.addEventListener('click', (e) => {
                    if (e.target.id === 'save-quote-button') this.saveQuote();
                    if (e.target.id === 'pdf-button') this.generatePdf();
                });
                
                document.getElementById('cost-generator-page').addEventListener('input', () => this.updateDisplay());
                document.getElementById('cost-request-form').addEventListener('submit', (e) => this.submitCostRequest(e));
            },
            
            handleInitialPageLoad() {
                const initialHash = window.location.hash.substring(1);
                const validPages = ['dashboard', 'generator', 'request', 'tracking', 'schedules'];
                const initialPage = validPages.includes(initialHash) ? initialHash : 'dashboard';
                this.switchPage(`${initialPage}-page`);
                
                // Load templates on dashboard
                if (initialPage === 'dashboard') {
                    this.loadTemplateGrid();
                }
                
                // Initialize tracking on tracking page
                if (initialPage === 'tracking') {
                    ShipmentTracker.init();
                }
                
                // Initialize schedules on schedules page
                if (initialPage === 'schedules') {
                    VesselScheduler.init();
                }
            },

            // --- TEMPLATE SYSTEM METHODS ---
            loadTemplateGrid() {
                const templateGrid = document.getElementById('template-grid');
                if (!templateGrid) return;

                const templates = QuoteTemplates.getAllTemplates();
                
                templateGrid.innerHTML = templates.map(template => `
                    <div class="template-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer transform hover:scale-105"
                         onclick="App.applyTemplate('${template.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-2xl">${template.icon}</div>
                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">Template</span>
                        </div>
                        <h4 class="font-semibold text-gray-800 text-sm mb-2">${template.name}</h4>
                        <p class="text-xs text-gray-600 mb-3">${template.description}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>${template.data.shipmentDetails.pol}</span>
                            <span>→</span>
                            <span>${template.data.shipmentDetails.pod}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <div class="flex justify-between text-xs text-gray-600">
                                <span>Rate: $${template.data.originCharges.ratePerKg}/kg</span>
                                <span>Duty: ${template.data.landedCost.dutyRate}%</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                console.log('✅ Template grid loaded with', templates.length, 'templates');
            },

            applyTemplate(templateId) {
                console.log('🎯 Applying template:', templateId);
                
                const success = QuoteTemplates.applyTemplate(templateId);
                
                if (success) {
                    // Switch to cost generator page
                    this.switchPage('cost-generator-page');
                    
                    // Regenerate all inputs with new data
                    this.generateInputs();
                    
                    // Update commercial value calculation
                    setTimeout(() => {
                        if (window.updateCommercialValue) {
                            updateCommercialValue();
                        }
                        this.updateDisplay();
                    }, 100);
                    
                    const template = QuoteTemplates.getTemplate(templateId);
                    showToast(`Template "${template.name}" applied successfully! 🎉`, 'success');
                    
                    console.log('✅ Template applied and page updated');
                } else {
                    showToast('Failed to apply template', 'error');
                    console.error('❌ Failed to apply template:', templateId);
                }
            },

            showAllTemplates() {
                // For now, scroll to templates section. Later we can add a modal
                const templateGrid = document.getElementById('template-grid');
                if (templateGrid) {
                    templateGrid.scrollIntoView({ behavior: 'smooth' });
                    showToast('All templates are shown below 👇', 'info');
                }
            },

            // --- ENHANCED QUOTE FILTERING METHODS ---
            filterQuotes(searchTerm = '') {
                const searchInput = document.getElementById('quote-search');
                const filterSelect = document.getElementById('quote-filter');
                
                const search = searchTerm || (searchInput ? searchInput.value : '');
                const filter = filterSelect ? filterSelect.value : '';
                
                console.log('🔍 Filtering quotes:', { search, filter });
                
                // This will be implemented when we have quotes to filter
                // For now, just show that the feature is working
                if (search) {
                    showToast(`Searching for: "${search}"`, 'info');
                }
                if (filter) {
                    showToast(`Filtering by: ${filter}`, 'info');
                }
            },

            // --- PRICING STRATEGY METHODS ---
            updatePricingMethod(method) {
                state.pricingStrategy.pricingMethod.value = method;
                
                // Show/hide relevant input fields
                const marginContainer = document.getElementById('ps-marginPercent-container');
                const markupContainer = document.getElementById('ps-markupPercent-container');
                const manualContainer = document.getElementById('ps-manualSellPrice-container');
                
                if (marginContainer) marginContainer.style.display = method === 'margin' ? 'block' : 'none';
                if (markupContainer) markupContainer.style.display = method === 'markup' ? 'block' : 'none';
                if (manualContainer) manualContainer.style.display = method === 'manual' ? 'block' : 'none';
                
                // Update calculations
                this.updatePricingStrategy();
                
                console.log('💰 Pricing method changed to:', method);
            },

            updatePricingStrategy() {
                try {
                    const { totals, landed } = this.calculateAll();
                    
                    // Get current pricing inputs
                    const unitQuantity = parseFloat(document.getElementById('ps-unitQuantity')?.value || state.pricingStrategy.unitQuantity.value);
                    const pricingMethod = document.getElementById('ps-pricingMethod')?.value || state.pricingStrategy.pricingMethod.value;
                    const targetCurrency = document.getElementById('ps-targetCurrency')?.value || state.pricingStrategy.targetCurrency.value;
                    const marginPercent = parseFloat(document.getElementById('ps-marginPercent')?.value || state.pricingStrategy.marginPercent.value);
                    const markupPercent = parseFloat(document.getElementById('ps-markupPercent')?.value || state.pricingStrategy.markupPercent.value);
                    const manualSellPrice = parseFloat(document.getElementById('ps-manualSellPrice')?.value || state.pricingStrategy.manualSellPrice.value);
                    
                    // Calculate base costs
                    const totalLandedCostZAR = landed.totalLandedCost;
                    const costPerUnit = totalLandedCostZAR / unitQuantity;
                    
                    // Exchange rates for target currency
                    const zarRates = { 
                        zar: 1, 
                        usd: parseFloat(state.exchangeRates.usd.value), 
                        eur: parseFloat(state.exchangeRates.eur.value) 
                    };
                    
                    const costPerUnitInTargetCurrency = costPerUnit / zarRates[targetCurrency];
                    
                    // Calculate pricing based on method
                    let sellPricePerUnit, profit, profitMargin, markup;
                    
                    if (pricingMethod === 'margin') {
                        // Margin = (Sell Price - Cost) / Sell Price * 100
                        // Sell Price = Cost / (1 - Margin/100)
                        sellPricePerUnit = costPerUnitInTargetCurrency / (1 - marginPercent / 100);
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = marginPercent;
                        markup = (profit / costPerUnitInTargetCurrency) * 100;
                    } else if (pricingMethod === 'markup') {
                        // Markup = (Sell Price - Cost) / Cost * 100
                        // Sell Price = Cost * (1 + Markup/100)
                        sellPricePerUnit = costPerUnitInTargetCurrency * (1 + markupPercent / 100);
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = (profit / sellPricePerUnit) * 100;
                        markup = markupPercent;
                    } else { // manual
                        sellPricePerUnit = manualSellPrice;
                        profit = sellPricePerUnit - costPerUnitInTargetCurrency;
                        profitMargin = (profit / sellPricePerUnit) * 100;
                        markup = (profit / costPerUnitInTargetCurrency) * 100;
                    }
                    
                    const totalRevenue = sellPricePerUnit * unitQuantity;
                    const totalProfit = profit * unitQuantity;
                    
                    // Currency symbols
                    const currencySymbols = { zar: 'R', usd: '$', eur: '€' };
                    const symbol = currencySymbols[targetCurrency];
                    
                    // Update display
                    const outputContainer = document.getElementById('pricing-strategy-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = `
                            <div class="space-y-3">
                                <!-- Cost Analysis -->
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <h4 class="font-semibold text-gray-700 mb-2">📊 Cost Analysis</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Total Landed Cost:</span>
                                            <span class="font-medium">${formatCurrency(totalLandedCostZAR)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Cost per Unit (${targetCurrency.toUpperCase()}):</span>
                                            <span class="font-medium">${symbol}${costPerUnitInTargetCurrency.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Unit Quantity:</span>
                                            <span class="font-medium">${unitQuantity.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pricing Results -->
                                <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
                                    <h4 class="font-semibold text-blue-700 mb-2">💰 Pricing Results</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Sell Price per Unit:</span>
                                            <span class="font-bold text-blue-800">${symbol}${sellPricePerUnit.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Profit per Unit:</span>
                                            <span class="font-medium text-green-600">${symbol}${profit.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Profit Margin:</span>
                                            <span class="font-medium ${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}">${profitMargin.toFixed(1)}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Markup:</span>
                                            <span class="font-medium">${markup.toFixed(1)}%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Total Financial Impact -->
                                <div class="bg-green-50 p-3 rounded-md border border-green-200">
                                    <h4 class="font-semibold text-green-700 mb-2">🎯 Total Impact</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Total Revenue:</span>
                                            <span class="font-bold text-green-800">${symbol}${totalRevenue.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Total Profit:</span>
                                            <span class="font-bold ${totalProfit >= 0 ? 'text-green-800' : 'text-red-600'}">${symbol}${totalProfit.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Break-even Units:</span>
                                            <span class="font-medium">${Math.ceil(totalLandedCostZAR / (sellPricePerUnit * zarRates[targetCurrency])).toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${profit < 0 ? `<div class="bg-red-50 p-2 rounded-md border border-red-200">
                                    <span class="text-xs text-red-700">⚠️ Warning: Current pricing results in a loss!</span>
                                </div>` : ''}
                            </div>
                        `;
                    }
                    
                    console.log('📈 Pricing strategy updated:', {
                        method: pricingMethod,
                        sellPrice: sellPricePerUnit,
                        profit: profit,
                        margin: profitMargin
                    });
                    
                } catch (error) {
                    console.error('Error updating pricing strategy:', error);
                    const outputContainer = document.getElementById('pricing-strategy-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = '<div class="text-red-600 text-sm">Error calculating pricing. Please check your inputs.</div>';
                    }
                }
            },

            // --- SARS CUSTOMS CALCULATION INTEGRATION ---
            async updateSARSCalculation() {
                try {
                    // Get import country and currency values
                    const importCountry = document.getElementById('lc-importCountry')?.value || 'ZA';
                    const invoiceCurrency = document.getElementById('lc-invoiceCurrency')?.value || 'USD';
                    const customsValue = parseFloat(document.getElementById('lc-commercialInvoiceValue')?.value || '0');
                    const hsCode = document.getElementById('lc-hsCode')?.value || '';
                    const originCountry = document.getElementById('lc-originCountry')?.value || 'CN';
                    const dutyRate = parseFloat(document.getElementById('lc-dutyRate')?.value || '0');
                    const totalKg = parseFloat(document.getElementById('lc-totalKg')?.value || '1');
                    
                    // Calculate using the Global Customs Calculator
                    const result = await GlobalCustomsCalculator.calculateForCountry(importCountry, {
                        customsValue,
                        hsCode,
                        originCountry,
                        dutyRate,
                        quantity: totalKg
                    });
                    
                    // Update the display with results
                    const outputContainer = document.getElementById('landed-cost-output');
                    if (outputContainer && result) {
                        const currencyService = new GlobalCurrencyService();
                        const localCurrency = currencyService.getCurrencyForCountry(importCountry);
                        
                        outputContainer.innerHTML = `
                            <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-400 mb-3">
                                <div class="font-semibold text-blue-800">🌍 ${result.method}</div>
                                <div class="text-sm text-blue-600">Calculation for ${importCountry.toUpperCase()} imports</div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Customs Value (${invoiceCurrency}):</span>
                                    <span class="font-semibold">${currencyService.formatCurrency(customsValue, invoiceCurrency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Customs Duty:</span>
                                    <span class="font-semibold text-red-600">${currencyService.formatCurrency(result.customsDuty, localCurrency)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>${importCountry === 'US' ? 'Sales Tax' : importCountry === 'IN' ? 'GST' : 'VAT/Tax'}:</span>
                                    <span class="font-semibold text-red-600">${currencyService.formatCurrency(result.vat, localCurrency)}</span>
                                </div>
                                <hr class="border-gray-300">
                                <div class="flex justify-between font-bold">
                                    <span>Total Border Taxes:</span>
                                    <span class="text-red-600">${currencyService.formatCurrency(result.totalTaxes, localCurrency)}</span>
                                </div>
                                <div class="flex justify-between font-bold text-green-600">
                                    <span>Total Landed Cost:</span>
                                    <span>${currencyService.formatCurrency(customsValue + result.totalTaxes, localCurrency)}</span>
                                </div>
                                ${totalKg > 0 ? `
                                <div class="flex justify-between text-gray-600">
                                    <span>Cost per Kg:</span>
                                    <span>${currencyService.formatCurrency((customsValue + result.totalTaxes) / totalKg, localCurrency)}</span>
                                </div>
                                ` : ''}
                                ${result.tradeAgreement ? `
                                <div class="bg-green-50 p-2 rounded mt-2">
                                    <div class="text-xs text-green-700">🤝 Trade Agreement: ${result.tradeAgreement}</div>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // Trigger main display update
                    setTimeout(() => this.updateDisplay(), 10);
                    
                } catch (error) {
                    console.error('SARS Calculation Error:', error);
                    const outputContainer = document.getElementById('landed-cost-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = `
                            <div class="bg-red-50 p-3 rounded border-l-4 border-red-400">
                                <div class="font-semibold text-red-800">⚠️ Calculation Error</div>
                                <div class="text-sm text-red-600">${error.message}</div>
                            </div>
                        `;
                    }
                }
            },

            // --- HS CODE LOOKUP METHODS ---
            handleHSCodeInput(value) {
                this.searchHSCodes(value).catch(error => {
                    console.error('Error searching HS codes:', error);
                    const resultsContainer = document.getElementById('hs-search-results');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = '<div class="p-3 text-red-500 text-sm">Error searching HS codes. Please try again.</div>';
                        resultsContainer.classList.remove('hidden');
                    }
                });
            },
            
            async searchHSCodes(query) {
                const resultsContainer = document.getElementById('hs-search-results');
                if (!resultsContainer || !query || query.length < 2) {
                    if (resultsContainer) resultsContainer.classList.add('hidden');
                    return;
                }

                // Use the complete database from GlobalCustomsCalculator
                await GlobalCustomsCalculator.SARS.initializeDatabase();
                const completeDatabase = GlobalCustomsCalculator.SARS.hsCodeDatabase;
                
                const results = [];
                const searchTerm = query.toLowerCase();
                
                if (completeDatabase) {
                    // Search through the complete 11,217 HS code database
                    for (const [code, data] of Object.entries(completeDatabase)) {
                        const description = data.description || '';
                        const searchText = `${code} ${description}`.toLowerCase();
                        
                        if (searchText.includes(searchTerm) || code.startsWith(query)) {
                            // Calculate relevance score
                            let relevance = 0;
                            if (code.startsWith(query)) relevance += 50;
                            if (code === query) relevance += 100;
                            if (description.toLowerCase().includes(searchTerm)) relevance += 10;
                            
                            results.push({
                                code,
                                description: description || 'No description available',
                                dutyRate: data.general || 0,
                                relevance,
                                general: data.general || 0,
                                EU: data.EU || 0,
                                SADC: data.SADC || 0,
                                AfCFTA: data.AfCFTA || 0
                            });
                        }
                        
                        // Limit results to prevent performance issues
                        if (results.length >= 50) break;
                    }
                }
                
                // Sort by relevance and code
                const sortedResults = results.sort((a, b) => {
                    if (b.relevance !== a.relevance) return b.relevance - a.relevance;
                    return a.code.localeCompare(b.code);
                }).slice(0, 12);
                
                if (sortedResults.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm">No HS codes found</div>';
                } else {
                    resultsContainer.innerHTML = sortedResults.map(result => `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                             onclick="App.selectHSCode('${result.code}', '${result.description}', ${result.dutyRate})">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="font-bold text-blue-700">${result.code}</div>
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Ch. ${result.code.substring(0,2)}</span>
                                    </div>
                                    <div class="text-sm text-gray-700 mb-2">${result.description}</div>
                                    <div class="text-xs text-gray-500 space-y-1">
                                        <div class="flex gap-2">
                                            <span class="text-green-600">General: ${result.general}%</span>
                                            <span class="text-blue-600">EU: ${result.EU}%</span>
                                            <span class="text-orange-600">SADC: ${result.SADC}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="ml-3 text-right">
                                    <div class="text-lg font-bold ${result.dutyRate === 0 ? 'text-green-600' : result.dutyRate >= 30 ? 'text-red-600' : 'text-orange-600'}">
                                        ${result.dutyRate}%
                                    </div>
                                    <div class="text-xs text-gray-500">duty</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                resultsContainer.classList.remove('hidden');
                
                // Hide results when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', this.hideHSResults, { once: true });
                }, 100);
            },

            selectHSCode(code, description, dutyRate) {
                const hsCodeInput = document.getElementById('lc-hsCode');
                const dutyRateInput = document.getElementById('lc-dutyRate');
                const resultsContainer = document.getElementById('hs-search-results');
                
                if (hsCodeInput) {
                    hsCodeInput.value = code;
                    state.landedCost.hsCode.value = code;
                }
                
                if (dutyRateInput) {
                    dutyRateInput.value = dutyRate;
                    state.landedCost.dutyRate.value = dutyRate.toString();
                }
                
                if (resultsContainer) {
                    resultsContainer.classList.add('hidden');
                }
                
                // Update calculations
                this.updateDisplay();
                
                showToast(`HS Code ${code} selected - ${dutyRate}% duty rate applied`, 'success');
                console.log('📋 HS Code selected:', { code, description, dutyRate });
            },

            hideHSResults(event) {
                const resultsContainer = document.getElementById('hs-search-results');
                const hsCodeInput = document.getElementById('lc-hsCode');
                
                if (resultsContainer && !resultsContainer.contains(event.target) && event.target !== hsCodeInput) {
                    resultsContainer.classList.add('hidden');
                }
            },

            showHSCodeBrowser() {
                const categories = HSCodeDatabase.getAllCategories();
                
                // Create modal overlay
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-90vh overflow-hidden" onclick="event.stopPropagation()">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900">HS Code Browser</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <span class="text-xl">×</span>
                                </button>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Browse HS codes by category or search for specific products</p>
                        </div>
                        
                        <div class="flex" style="height: 60vh;">
                            <!-- Categories Sidebar -->
                            <div class="w-1/3 border-r border-gray-200 overflow-y-auto">
                                <div class="p-4">
                                    <h4 class="font-medium text-gray-900 mb-3">Categories</h4>
                                    <div class="space-y-1">
                                        ${categories.map(category => `
                                            <button class="w-full text-left px-3 py-2 text-sm rounded-md hover:bg-gray-100 category-btn"
                                                    onclick="App.showCategoryDetails('${category}')">
                                                ${category}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Details Panel -->
                            <div class="flex-1 overflow-y-auto">
                                <div id="category-details" class="p-4">
                                    <div class="text-center text-gray-500 py-8">
                                        <div class="text-4xl mb-4">📋</div>
                                        <p>Select a category to view HS codes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },

            showCategoryDetails(category) {
                const detailsContainer = document.getElementById('category-details');
                const codes = HSCodeDatabase.getByCategory(category);
                
                // Highlight selected category
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-100', 'text-blue-800');
                    if (btn.textContent.trim() === category) {
                        btn.classList.add('bg-blue-100', 'text-blue-800');
                    }
                });
                
                detailsContainer.innerHTML = `
                    <h4 class="font-semibold text-gray-900 mb-4">${category} (${codes.length} codes)</h4>
                    <div class="space-y-3">
                        ${codes.map(code => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 cursor-pointer transition-colors"
                                 onclick="App.selectHSCode('${code.code}', '${code.description}', ${code.dutyRate}); this.closest('.fixed').remove();">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900 mb-1">${code.code}</div>
                                        <div class="text-sm text-gray-600 mb-2">${code.description}</div>
                                        <div class="text-xs text-gray-500">
                                            Examples: ${code.examples.join(', ')}
                                        </div>
                                    </div>
                                    <div class="ml-4 text-right">
                                        <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${code.dutyRate === 0 ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                            ${code.dutyRate}% duty
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            // --- COST SPLITTING METHODS ---
            toggleCostSplitting(enabled) {
                state.costSplitting.enabled.value = enabled;
                
                // Show/hide relevant sections
                const methodContainer = document.getElementById('cs-method-container');
                const volumeContainer = document.getElementById('cs-totalVolume-container');
                const unitsContainer = document.getElementById('cs-itemUnits-container');
                
                if (methodContainer) methodContainer.style.display = enabled ? 'block' : 'none';
                
                if (enabled) {
                    this.updateCostSplittingVisibility();
                } else {
                    if (volumeContainer) volumeContainer.style.display = 'none';
                    if (unitsContainer) unitsContainer.style.display = 'none';
                }
                
                this.updateCostSplitting();
            },

            updateCostSplittingVisibility() {
                const method = document.getElementById('cs-method')?.value || state.costSplitting.method.value;
                const volumeContainer = document.getElementById('cs-totalVolume-container');
                const unitsContainer = document.getElementById('cs-itemUnits-container');
                
                if (volumeContainer) volumeContainer.style.display = method === 'volume' ? 'block' : 'none';
                if (unitsContainer) unitsContainer.style.display = method === 'units' ? 'block' : 'none';
            },

            updateCostSplitting() {
                try {
                    const enabled = document.getElementById('cs-enabled')?.checked || state.costSplitting.enabled.value;
                    
                    if (!enabled) {
                        const outputContainer = document.getElementById('cost-splitting-output');
                        if (outputContainer) {
                            outputContainer.innerHTML = '<div class="text-gray-500 text-sm">Cost splitting is disabled</div>';
                        }
                        return;
                    }

                    // Update visibility first
                    this.updateCostSplittingVisibility();
                    
                    const { totals, landed } = this.calculateAll();
                    
                    const method = document.getElementById('cs-method')?.value || state.costSplitting.method.value;
                    const totalVolume = parseFloat(document.getElementById('cs-totalVolume')?.value || state.costSplitting.totalVolume.value);
                    const itemUnits = parseFloat(document.getElementById('cs-itemUnits')?.value || state.costSplitting.itemUnits.value);
                    const totalKg = parseFloat(document.getElementById('lc-totalKg')?.value || state.landedCost.totalKg.value);
                    
                    let costPerUnit, unitLabel, splitDivisor;
                    
                    switch (method) {
                        case 'weight':
                            splitDivisor = totalKg;
                            unitLabel = 'per Kg';
                            break;
                        case 'volume':
                            splitDivisor = totalVolume;
                            unitLabel = 'per CBM';
                            break;
                        case 'units':
                            splitDivisor = itemUnits;
                            unitLabel = 'per Item';
                            break;
                        default:
                            splitDivisor = 1;
                            unitLabel = 'total';
                    }
                    
                    if (splitDivisor <= 0) {
                        const outputContainer = document.getElementById('cost-splitting-output');
                        if (outputContainer) {
                            outputContainer.innerHTML = '<div class="text-red-600 text-sm">Please enter a valid divisor value</div>';
                        }
                        return;
                    }
                    
                    // Calculate cost breakdowns
                    const costBreakdown = {
                        freight: totals.subtotalFreight / splitDivisor,
                        origin: totals.subtotalOrigin / splitDivisor,
                        destination: totals.subtotalDestinationCharges / splitDivisor,
                        clearing: totals.subtotalClearing / splitDivisor,
                        transport: totals.subtotalTransport / splitDivisor,
                        totalLogistics: totals.grandTotal / splitDivisor,
                        landedCost: landed.totalLandedCost / splitDivisor
                    };
                    
                    // Update display
                    const outputContainer = document.getElementById('cost-splitting-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = `
                            <div class="space-y-3">
                                <div class="bg-blue-50 p-3 rounded-md border border-blue-200">
                                    <h4 class="font-semibold text-blue-700 mb-2">📊 Cost Breakdown (${unitLabel})</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Freight Costs:</span>
                                            <span class="font-medium">${formatCurrency(costBreakdown.freight)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Origin Charges:</span>
                                            <span class="font-medium">${formatCurrency(costBreakdown.origin)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Destination Charges:</span>
                                            <span class="font-medium">${formatCurrency(costBreakdown.destination)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Clearing & Forwarding:</span>
                                            <span class="font-medium">${formatCurrency(costBreakdown.clearing)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Transport:</span>
                                            <span class="font-medium">${formatCurrency(costBreakdown.transport)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-green-50 p-3 rounded-md border border-green-200">
                                    <h4 class="font-semibold text-green-700 mb-2">🎯 Total Costs (${unitLabel})</h4>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Total Logistics:</span>
                                            <span class="font-bold text-green-800">${formatCurrency(costBreakdown.totalLogistics)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Total Landed Cost:</span>
                                            <span class="font-bold text-green-800">${formatCurrency(costBreakdown.landedCost)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <div class="text-xs text-gray-600">
                                        Split by: ${method} • Divisor: ${splitDivisor.toLocaleString()} ${method === 'weight' ? 'kg' : method === 'volume' ? 'CBM' : 'items'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    console.log('📊 Cost splitting updated:', {
                        method,
                        divisor: splitDivisor,
                        costPerUnit: costBreakdown.landedCost
                    });
                    
                } catch (error) {
                    console.error('Error updating cost splitting:', error);
                    const outputContainer = document.getElementById('cost-splitting-output');
                    if (outputContainer) {
                        outputContainer.innerHTML = '<div class="text-red-600 text-sm">Error calculating cost splitting. Please check your inputs.</div>';
                    }
                }
            },
            
            getCurrentData(fullState = false) { 
                const currentValues = { details: {}, exchangeRates: {}, originCharges: {}, costs: {}, landedCost: {} }; 
                
                // Collect shipment details
                for (const key in state.shipmentDetails) {
                    const element = document.getElementById(`sd-${key}`);
                    currentValues.details[key] = element ? element.value : state.shipmentDetails[key].value;
                }
                
                // Collect exchange rates
                for (const key in state.exchangeRates) {
                    const element = document.getElementById(`er-${key}`);
                    currentValues.exchangeRates[key] = element ? element.value : state.exchangeRates[key].value;
                } 
                
                // Collect origin charges (NEW)
                if (state.originCharges && state.originCharges.items) {
                    for (const itemKey in state.originCharges.items) { 
                        const valueEl = document.getElementById(`origin-${itemKey}-value`); 
                        const currencyEl = document.getElementById(`origin-${itemKey}-currency`); 
                        if(valueEl) { 
                            currentValues.originCharges[itemKey] = { 
                                value: valueEl.value, 
                                currency: currencyEl ? currencyEl.value : state.originCharges.items[itemKey].currency 
                            }; 
                        } else {
                            // Fallback to state values if elements don't exist
                            currentValues.originCharges[itemKey] = {
                                value: state.originCharges.items[itemKey].value,
                                currency: state.originCharges.items[itemKey].currency
                            };
                        }
                    }
                }
                
                // Collect remaining cost sections (excluding origin which is now separate)
                for (const sectionKey in state.costs) { 
                    currentValues.costs[sectionKey] = {}; 
                    for (const itemKey in state.costs[sectionKey].items) { 
                        const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`); 
                        const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`); 
                        if(valueEl) { 
                            currentValues.costs[sectionKey][itemKey] = { 
                                value: valueEl.value, 
                                currency: currencyEl ? currencyEl.value : state.costs[sectionKey].items[itemKey].currency 
                            }; 
                        } else {
                            // Fallback to state values if elements don't exist
                            currentValues.costs[sectionKey][itemKey] = {
                                value: state.costs[sectionKey].items[itemKey].value,
                                currency: state.costs[sectionKey].items[itemKey].currency
                            };
                        }
                    } 
                } 
                
                // Collect landed cost data
                for (const key in state.landedCost) { 
                    const el = document.getElementById(`lc-${key}`); 
                    currentValues.landedCost[key] = el ? el.value : state.landedCost[key].value; 
                } 
                
                if (fullState) { 
                    const now = new Date(); 
                    currentValues.quoteNumber = `SYN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${now.getTime().toString().slice(-4)}`; 
                    currentValues.createdAt = now.toISOString(); 
                    currentValues.createdBy = this.userId; 
                } 
                return currentValues; 
            },
            async saveQuote() {
                if (!this.quotesCollection) {
                    // Fallback to localStorage when Firebase is not available
                    return this.saveQuoteLocal();
                }
                const button = document.getElementById('save-quote-button'); 
                if (!button) return; 
                button.disabled = true; 
                button.innerHTML = '<span class="loading"></span> Saving...'; 
                try { 
                    await addDoc(this.quotesCollection, this.getCurrentData(true)); 
                    showToast('Quote saved successfully! 🎉', 'success'); 
                } catch (error) { 
                    console.error("Error saving quote: ", error); 
                    showToast("Failed to save quote. Please try again.", 'error');
                } finally { 
                    if(button) { button.disabled = false; button.innerHTML = '💾 Save Quote'; }
                } 
            },
            async loadQuote(quoteId) {
                if (!this.db) {
                    alert('Database not available');
                    return;
                }
                
                try {
                    console.log('Loading quote with ID:', quoteId);
                    const quoteDoc = await getDoc(doc(this.db, "quotes", quoteId));
                    
                    if (quoteDoc.exists()) {
                        const data = quoteDoc.data();
                        console.log('Quote data loaded:', data);
                        
                        // Load shipment details
                        if (data.details) {
                            for (const key in data.details) {
                                const el = document.getElementById(`sd-${key}`);
                                if (el) {
                                    el.value = data.details[key];
                                    console.log(`Set ${key} to ${data.details[key]}`);
                                }
                            }
                        }
                        
                        // Load exchange rates
                        if (data.exchangeRates) {
                            for (const key in data.exchangeRates) {
                                const el = document.getElementById(`er-${key}`);
                                if (el) {
                                    el.value = data.exchangeRates[key];
                                }
                            }
                        }
                        
                        // Load origin charges (NEW)
                        if (data.originCharges) {
                            for (const itemKey in state.originCharges.items) {
                                if (data.originCharges[itemKey]) {
                                    const valueEl = document.getElementById(`origin-${itemKey}-value`);
                                    const currencyEl = document.getElementById(`origin-${itemKey}-currency`);
                                    
                                    if (valueEl) {
                                        valueEl.value = data.originCharges[itemKey].value;
                                    }
                                    if (currencyEl) {
                                        currencyEl.value = data.originCharges[itemKey].currency;
                                    }
                                }
                            }
                        }
                        
                        // Load costs
                        if (data.costs) {
                            for (const sectionKey in state.costs) {
                                if (data.costs[sectionKey]) {
                                    for (const itemKey in state.costs[sectionKey].items) {
                                        if (data.costs[sectionKey][itemKey]) {
                                            const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`);
                                            const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`);
                                            
                                            if (valueEl) {
                                                valueEl.value = data.costs[sectionKey][itemKey].value;
                                            }
                                            if (currencyEl) {
                                                currencyEl.value = data.costs[sectionKey][itemKey].currency;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Load landed cost
                        if (data.landedCost) {
                            for (const key in data.landedCost) {
                                const el = document.getElementById(`lc-${key}`);
                                if (el) {
                                    el.value = data.landedCost[key];
                                }
                            }
                        }
                        
                        // Switch to cost generator page and update display
                        this.switchPage('cost-generator-page');
                        this.updateDisplay();
                        showToast('Quote loaded successfully! ✨', 'success');
                        
                    } else {
                        alert("Quote not found.");
                    }
                } catch (error) {
                    console.error("Error loading quote: ", error);
                    alert("Error loading quote: " + error.message);
                }
            },
            
            saveQuoteLocal() {
                const button = document.getElementById('save-quote-button');
                if (!button) return;
                button.disabled = true;
                button.textContent = 'Saving...';
                
                try {
                    const quoteData = this.getCurrentData(true);
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    quoteData.id = Date.now().toString();
                    quotes.push(quoteData);
                    localStorage.setItem('synerore_quotes', JSON.stringify(quotes));
                    showToast('Quote saved locally! 📱 Note: Only visible on this browser.', 'warning');
                    this.loadLocalQuotes();
                } catch (error) {
                    console.error('Error saving quote locally:', error);
                    alert('Failed to save quote locally.');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Save Quote';
                }
            },
            
            loadLocalQuotes() {
                const listContainer = document.getElementById('saved-quotes-list');
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    if (quotes.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-500">No quotes saved yet.</p>';
                        return;
                    }
                    
                    quotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    listContainer.innerHTML = quotes.map(quote => 
                        `<div class="quote-card flex items-center justify-between p-4">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">📦 ${quote.details.supplierName || 'No Supplier'}</p>
                                <p class="text-sm text-gray-500">Quote #${quote.quoteNumber} • ${new Date(quote.createdAt).toLocaleDateString('en-GB')} <span class="text-orange-500 font-medium">(Local)</span></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="App.loadLocalQuote('${quote.id}')" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    📂 Load
                                </button>
                                <button onclick="App.deleteLocalQuote('${quote.id}')" class="btn bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 transition-colors" title="Delete Local Quote">
                                    🗑️
                                </button>
                            </div>
                        </div>`
                    ).join('');
                } catch (error) {
                    console.error('Error loading local quotes:', error);
                    listContainer.innerHTML = '<p class="text-red-500">Error loading local quotes.</p>';
                }
            },
            
            loadLocalQuote(quoteId) {
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    const quote = quotes.find(q => q.id === quoteId);
                    if (!quote) {
                        alert('Quote not found.');
                        return;
                    }
                    
                    for (const key in quote.details) {
                        const el = document.getElementById(`sd-${key}`);
                        if (el) el.value = quote.details[key];
                    }
                    for (const key in quote.exchangeRates) {
                        const el = document.getElementById(`er-${key}`);
                        if (el) el.value = quote.exchangeRates[key];
                    }
                    for (const sectionKey in state.costs) {
                        if (quote.costs[sectionKey]) {
                            for (const itemKey in state.costs[sectionKey].items) {
                                if (quote.costs[sectionKey][itemKey]) {
                                    const valueEl = document.getElementById(`cost-${sectionKey}-${itemKey}-value`);
                                    const currencyEl = document.getElementById(`cost-${sectionKey}-${itemKey}-currency`);
                                    if (valueEl) valueEl.value = quote.costs[sectionKey][itemKey].value;
                                    if (currencyEl) currencyEl.value = quote.costs[sectionKey][itemKey].currency;
                                }
                            }
                        }
                    }
                    for (const key in quote.landedCost) {
                        const el = document.getElementById(`lc-${key}`);
                        if (el) el.value = quote.landedCost[key];
                    }
                    
                    this.updateDisplay();
                    this.switchPage('cost-generator-page');
                    alert('Quote loaded successfully!');
                } catch (error) {
                    console.error('Error loading local quote:', error);
                    alert('Error loading quote.');
                }
            },
            generatePdf() { const { details, totals, landed } = this.calculateAll(); const now = new Date(); const quoteNumber = `SYN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${now.getTime().toString().slice(-4)}`; const todayDate = now.toLocaleDateString('en-GB'); const pdfHtml = ` <div style="font-family: Arial, sans-serif; color: #333; margin: 25px;"> <table style="width: 100%; border-bottom: 2px solid #6366f1;"> <tr> <td style="width: 50%;"><img src="synercore-logo.png" alt="Synerore Logo" style="width: 150px;"></td> <td style="width: 50%; text-align: right;"> <h1 style="font-size: 28px; color: #6366f1; margin: 0;">Cost Estimate</h1> <p style="margin: 2px 0;"><b>Quote #:</b> ${quoteNumber}</p> <p style="margin: 2px 0;"><b>Date:</b> ${todayDate}</p> </td> </tr> </table> <table style="width: 100%; margin-top: 25px;"> <tr> <td style="vertical-align: top; width: 50%;"><h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Prepared For:</h2><p style="margin: 2px 0;"><strong>${details.supplierName}</strong></p></td> <td style="vertical-align: top; width: 50%;"><h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Shipment Details:</h2><p style="margin: 2px 0;"><strong>Origin:</strong> ${details.pol}</p><p style="margin: 2px 0;"><strong>Destination:</strong> ${details.pod}</p><p style="margin: 2px 0;"><strong>Container:</strong> ${details.containerSize}</p><p style="margin: 2px 0;"><strong>Commodity:</strong> ${details.commodity}</p></td> </tr> </table> <h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 25px 0 10px 0;">Costing Summary (in ZAR)</h2> <table style="width: 100%; border-collapse: collapse;"> <tr style="background-color: #f3f4f6;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Description</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Amount</th></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Freight Costs</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalFreight)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Origin Charges</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalOrigin)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Destination Charges</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalDestinationCharges)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Forwarding & Clearing</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalClearing)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Transport & Warehousing</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.subtotalTransport)}</td></tr> <tr style="font-weight: bold;"><td style="padding: 8px; border-top: 2px solid #333; border-bottom: 1px solid #eee;">Sub-Total (excl. VAT)</td><td style="padding: 8px; text-align: right; border-top: 2px solid #333; border-bottom: 1px solid #eee;">${formatCurrency(totals.preVatTotal)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">VAT on Services (15%)</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(totals.vatOnServices)}</td></tr> <tr style="background-color: #eef2ff; font-weight: bold; font-size: 18px;"><td style="padding: 10px;">Grand Total</td><td style="padding: 10px; text-align: right;">${formatCurrency(totals.grandTotal)}</td></tr> </table> <h2 style="font-size: 16px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 25px 0 10px 0;">Landed Cost Breakdown</h2> <table style="width: 100%; border-collapse: collapse;"> <tr style="background-color: #f3f4f6;"><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Description</th><th style="text-align: right; padding: 8px; border-bottom: 1px solid #ddd;">Amount</th></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Commercial Value (ZAR)</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.commercialValueZAR)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Customs Duty</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.dutyAmount)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">VAT on Goods</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.vatOnGoods)}</td></tr> <tr><td style="padding: 8px; border-bottom: 1px solid #eee;">Total Clearing & Forwarding Costs</td><td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(landed.totalClearingCosts)}</td></tr> <tr style="font-weight: bold; font-size: 16px;"><td style="padding: 8px; border-top: 2px solid #333; border-bottom: 1px solid #eee;">Total Landed Cost</td><td style="padding: 8px; text-align: right; border-top: 2px solid #333; border-bottom: 1px solid #eee;">${formatCurrency(landed.totalLandedCost)}</td></tr> <tr style="background-color: #dcfce7; font-weight: bold; font-size: 18px;"><td style="padding: 10px;">Cost per Kg</td><td style="padding: 10px; text-align: right;">${formatCurrency(landed.costPerKg)}</td></tr> </table> <div style="margin-top: 40px; padding-top: 10px; border-top: 1px solid #ccc; font-size: 12px; color: #777;"><p><strong>Terms & Conditions:</strong></p><p>This is an estimate only and is subject to change based on final weights, dimensions, and applicable rates at the time of shipment. All business is conducted in accordance with our standard trading terms and conditions, available on request.</p><p style="margin-top: 10px;">Synercore (Pty) Ltd</p></div> </div>`; const options = { margin: 0.5, filename: `Synercore-Costing-${details.supplierName.replace(/ /g, '_')}-${quoteNumber}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }; html2pdf().from(pdfHtml).set(options).save(); },
            calculateAll() {
                const currentValues = this.getCurrentData();
                const { details } = currentValues;
                const zarRates = { ...Object.fromEntries(Object.entries(currentValues.exchangeRates).map(([k,v]) => [k, parseFloat(v)])), zar: 1 };
                const calculateSectionTotal = (section) => Object.values(section).reduce((acc, item) => acc + (parseFloat(item.value || 0) * (zarRates[item.currency] || 0)), 0);
                
                // Special calculation for Origin Charges (rate per kg * total kg)
                const calculateOriginTotal = (originCharges) => {
                    if (originCharges.ratePerKg && originCharges.totalKg) {
                        const ratePerKg = parseFloat(originCharges.ratePerKg.value || 0);
                        const totalKg = parseFloat(originCharges.totalKg.value || 0);
                        const currency = originCharges.ratePerKg.currency || 'usd';
                        return ratePerKg * totalKg * (zarRates[currency] || 0);
                    }
                    return 0;
                };
                
                const totals = { 
                    subtotalFreight: calculateSectionTotal(currentValues.costs.freight), 
                    subtotalOrigin: calculateOriginTotal(currentValues.originCharges), // Updated: now uses special origin calculation
                    subtotalDestinationCharges: calculateSectionTotal(currentValues.costs.destinationCharges), 
                    subtotalClearing: calculateSectionTotal(currentValues.costs.clearing),
                    subtotalTransport: calculateSectionTotal(currentValues.costs.transport),
                };
                                
                totals.preVatTotal = totals.subtotalFreight + totals.subtotalOrigin + totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport;
                totals.vatOnServices = (totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport) * VAT_RATE;
                totals.grandTotal = totals.preVatTotal + totals.vatOnServices;
                
                // SARS-Compliant Landed Cost Calculation
                const commercialValueUSD = parseFloat(currentValues.landedCost.commercialInvoiceValue) || 0;
                const commercialValueZAR = commercialValueUSD * zarRates.usd;
                const hsCode = currentValues.landedCost.hsCode || '';
                const dutyRate = parseFloat(currentValues.landedCost.dutyRate) || 0;
                const originCountry = currentValues.landedCost.originCountry || 'CN';
                const tradeAgreement = currentValues.landedCost.tradeAgreement || 'general';
                
                // Use SARS calculation engine
                const sarsCalculation = SARSCustomsCalculator.calculateComplete({
                    customsValue: commercialValueZAR,
                    hsCode: hsCode,
                    baseDutyRate: dutyRate,
                    originCountry: originCountry,
                    tradeAgreement: tradeAgreement
                });
                
                const landed = {
                    commercialValueZAR: commercialValueZAR,
                    commercialValueUSD: commercialValueUSD,
                    dutyAmount: sarsCalculation.customsDuty,
                    vatOnGoods: sarsCalculation.importVAT,
                    uplift: sarsCalculation.uplift,
                    atv: sarsCalculation.atv,
                    isBELN: sarsCalculation.isBELN,
                    applicableDutyRate: sarsCalculation.applicableDutyRate,
                    tradeAgreement: tradeAgreement,
                    originCountry: originCountry,
                    totalClearingCosts: totals.subtotalDestinationCharges + totals.subtotalClearing + totals.subtotalTransport + totals.vatOnServices,
                    totalBorderTaxes: sarsCalculation.totalBorderTaxes,
                    sarsBreakdown: sarsCalculation.breakdown
                };
                
                landed.totalLandedCost = landed.commercialValueZAR + landed.dutyAmount + landed.vatOnGoods + landed.totalClearingCosts;
                const totalKg = parseFloat(currentValues.landedCost.totalKg) || 1;
                landed.costPerKg = landed.totalLandedCost / totalKg;
                return { details, totals, landed };
            },
            updateDisplay() { 
                const { totals, landed } = this.calculateAll(); 
                document.getElementById('summary-output').innerHTML = ` <div class="flex justify-between"><span class="text-gray-600">Freight Costs:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalFreight)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Origin Charges:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalOrigin)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Destination Charges:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalDestinationCharges)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Forwarding & Clearing:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalClearing)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Transport & Warehousing:</span> <span class="font-medium text-gray-800">${formatCurrency(totals.subtotalTransport)}</span></div> <div class="border-t my-2"></div> <div class="flex justify-between text-base"><span class="font-semibold text-gray-700">Sub-Total (excl. VAT):</span> <span class="font-bold text-gray-900">${formatCurrency(totals.preVatTotal)}</span></div> <div class="flex justify-between"><span class="text-gray-600">VAT on Services (15%):</span> <span class="font-medium text-gray-800">${formatCurrency(totals.vatOnServices)}</span></div> <div class="border-t my-2 border-indigo-200"></div> <div class="flex justify-between text-xl p-2 bg-indigo-50 rounded-md"><span class="font-bold text-indigo-800">Grand Total:</span> <span class="font-extrabold text-indigo-900">${formatCurrency(totals.grandTotal)}</span></div> `; 
                document.getElementById('landed-cost-output').innerHTML = ` <div class="flex justify-between"><span class="text-gray-600">Commercial Value (ZAR):</span> <span class="font-medium text-gray-800">${formatCurrency(landed.commercialValueZAR)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Customs Duty:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.dutyAmount)}</span></div> <div class="flex justify-between"><span class="text-gray-600">VAT on Goods:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.vatOnGoods)}</span></div> <div class="flex justify-between"><span class="text-gray-600">Total Clearing Costs:</span> <span class="font-medium text-gray-800">${formatCurrency(landed.totalClearingCosts)}</span></div> <div class="border-t my-2"></div> <div class="flex justify-between text-base"><span class="font-semibold text-gray-700">Total Landed Cost:</span> <span class="font-bold text-gray-900">${formatCurrency(landed.totalLandedCost)}</span></div> <div class="border-t my-2 border-green-200"></div> <div class="flex justify-between text-xl p-2 bg-green-50 rounded-md"><span class="font-bold text-green-800">Cost per Kg:</span> <span class="font-extrabold text-green-900">${formatCurrency(landed.costPerKg)}</span></div> `; 
                
                // Update pricing strategy
                setTimeout(() => this.updatePricingStrategy(), 10);
            },
            generateInputs() { 
                try {
                    // Generate Shipment Details
                    const shipmentContainer = document.querySelector('#shipment-details .grid');
                    if (shipmentContainer) {
                        shipmentContainer.innerHTML = Object.entries(state.shipmentDetails).map(([key, item]) => { 
                            let fieldHtml = `<label class="block text-sm font-medium text-gray-600 mb-1">${item.label}</label>`; 
                            if (item.type === 'select') { 
                                fieldHtml += `<select id="sd-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800"> ${item.options.map(opt => `<option value="${opt}" ${opt === item.value ? 'selected' : ''}>${opt}</option>`).join('')} </select>`; 
                            } else { 
                                fieldHtml += `<input type="text" id="sd-${key}" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800">`; 
                            } 
                            return `<div>${fieldHtml}</div>`; 
                        }).join(''); 
                    }
                    
                    // Generate Origin Charges (NEW SECTION)
                    const originContainer = document.getElementById('origin-charges-section');
                    if (originContainer) {
                        if (state.originCharges && state.originCharges.items && state.originCharges.currencyOptions) {
                            try {
                                const originFieldsHtml = Object.entries(state.originCharges.items).map(([itemKey, item]) => { 
                                    const isKg = item.currency === 'kg';
                                    const isPercent = item.currency === 'percent'; 
                                    return `<div> 
                                        <label class="block text-sm font-medium text-gray-600 mb-1">${item.label || itemKey}</label> 
                                        <div class="flex items-center"> 
                                            <input type="number" step="0.01" id="origin-${itemKey}-value" value="${item.value || '0'}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" placeholder="0.00" ${isKg ? 'oninput="updateCommercialValue()"' : 'oninput="updateCommercialValue()"'}> 
                                            ${isKg ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">kg</span>` : 
                                              isPercent ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">%</span>` : 
                                              `<select id="origin-${itemKey}-currency" class="px-3 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md focus:outline-none" onchange="updateCommercialValue()"> ${state.originCharges.currencyOptions.map(c => `<option value="${c.toLowerCase()}" ${c.toLowerCase() === (item.currency || 'usd') ? 'selected' : ''}>${c}</option>`).join('')} </select>`} 
                                        </div> 
                                    </div>`; 
                                }).join('');
                                originContainer.innerHTML = originFieldsHtml;
                                console.log('✅ Origin charges section generated successfully');
                                
                                // Initialize commercial value calculation
                                setTimeout(() => {
                                    if (window.updateCommercialValue) {
                                        updateCommercialValue();
                                    }
                                }, 100);
                            } catch (error) {
                                console.error('❌ Error generating origin charges:', error);
                                originContainer.innerHTML = '<div class="text-red-500 p-4">Error loading origin charges section</div>';
                            }
                        } else {
                            console.warn('⚠️ Origin charges not properly configured in state');
                            originContainer.innerHTML = '<div class="text-yellow-600 p-4">Origin charges configuration missing</div>';
                        }
                    } else {
                        console.error('❌ Origin charges container not found');
                    }
                    
                    // Generate remaining Cost Sections (excluding origin which is now separate)
                    const costContainer = document.getElementById('cost-sections');
                    if (costContainer) {
                        costContainer.innerHTML = Object.entries(state.costs).map(([sectionKey, section]) => { 
                            const fieldsHtml = Object.entries(section.items).map(([itemKey, item]) => { 
                                const isPercent = item.currency === 'percent'; 
                                return `<div> 
                                    <label class="block text-sm font-medium text-gray-600 mb-1">${item.label}</label> 
                                    <div class="flex items-center"> 
                                        <input type="number" step="0.01" id="cost-${sectionKey}-${itemKey}-value" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" placeholder="0.00"> 
                                        ${isPercent ? `<span class="inline-flex items-center px-3 text-gray-600 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md">%</span>` : `<select id="cost-${sectionKey}-${itemKey}-currency" class="px-3 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md focus:outline-none"> ${section.currencyOptions.map(c => `<option value="${c.toLowerCase()}" ${c.toLowerCase() === item.currency ? 'selected' : ''}>${c}</option>`).join('')} </select>`} 
                                    </div> 
                                </div>`; 
                            }).join(''); 
                            return `<div class="bg-white p-4 rounded-lg shadow-sm mb-6"> 
                                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">${section.title}</h3> 
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml}</div> 
                            </div>`; 
                        }).join(''); 
                    }
                    
                    // Generate Landed Cost inputs
                    const landedContainer = document.getElementById('landed-cost-inputs');
                    if (landedContainer) {
                        const landedFields = Object.entries(state.landedCost).map(([key, item]) => {
                            if (key === 'hsCode') {
                                return `<div class="relative">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="lc-${key}" 
                                               value="${item.value}" 
                                               class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 pr-8" 
                                               placeholder="Search by product or code"
                                               oninput="App.handleHSCodeInput(this.value)"
                                               autocomplete="off">
                                        <button type="button" 
                                                onclick="App.showHSCodeBrowser()" 
                                                class="absolute right-2 top-2 text-gray-400 hover:text-gray-600"
                                                title="Browse HS Codes">
                                            🔍
                                        </button>
                                    </div>
                                    <div id="hs-search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto hidden"></div>
                                </div>`;
                            } else if (item.type === 'select') {
                                return `<div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="lc-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updateSARSCalculation()">
                                        ${item.options.map(option => `<option value="${option.value}" ${option.value === item.value ? 'selected' : ''}>${option.label}</option>`).join('')}
                                    </select>
                                </div>`;
                            } else {
                                const inputType = item.type === 'text' ? 'text' : 'number';
                                const step = inputType === 'number' ? 'step="0.01"' : '';
                                const onchange = inputType === 'number' ? 'onchange="App.updateSARSCalculation()"' : '';
                                return `<div> 
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label> 
                                    <input type="${inputType}" ${step} id="lc-${key}" value="${item.value}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" ${onchange}> 
                                </div>`;
                            }
                        }).join('');
                        
                        landedContainer.innerHTML = landedFields;
                    }
                    
                    // Generate Pricing Strategy inputs
                    const pricingContainer = document.getElementById('pricing-strategy-inputs');
                    if (pricingContainer) {
                        const pricingFields = Object.entries(state.pricingStrategy).map(([key, item]) => {
                            if (key === 'pricingMethod') {
                                return `<div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="ps-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updatePricingMethod(this.value)">
                                        <option value="margin" ${item.value === 'margin' ? 'selected' : ''}>Margin % (Profit Target)</option>
                                        <option value="markup" ${item.value === 'markup' ? 'selected' : ''}>Markup % (Cost Plus)</option>
                                        <option value="manual" ${item.value === 'manual' ? 'selected' : ''}>Manual Sell Price</option>
                                    </select>
                                </div>`;
                            } else if (key === 'targetCurrency') {
                                return `<div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="ps-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updatePricingStrategy()">
                                        <option value="zar" ${item.value === 'zar' ? 'selected' : ''}>ZAR (South African Rand)</option>
                                        <option value="usd" ${item.value === 'usd' ? 'selected' : ''}>USD (US Dollar)</option>
                                        <option value="eur" ${item.value === 'eur' ? 'selected' : ''}>EUR (Euro)</option>
                                    </select>
                                </div>`;
                            } else {
                                const isConditional = (key === 'marginPercent' && state.pricingStrategy.pricingMethod.value !== 'margin') ||
                                                    (key === 'markupPercent' && state.pricingStrategy.pricingMethod.value !== 'markup') ||
                                                    (key === 'manualSellPrice' && state.pricingStrategy.pricingMethod.value !== 'manual');
                                                    
                                return `<div ${isConditional ? 'style="display: none;"' : ''} id="ps-${key}-container">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <input type="number" step="0.01" id="ps-${key}" value="${item.value}" 
                                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" 
                                           oninput="App.updatePricingStrategy()" placeholder="Enter ${item.label.toLowerCase()}">
                                </div>`;
                            }
                        }).join('');
                        
                        pricingContainer.innerHTML = pricingFields;
                        console.log('✅ Pricing strategy inputs generated');
                    }
                    
                    // Generate Cost Splitting inputs
                    const costSplittingContainer = document.getElementById('cost-splitting-inputs');
                    if (costSplittingContainer) {
                        const splittingFields = Object.entries(state.costSplitting).map(([key, item]) => {
                            if (key === 'enabled') {
                                return `<div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="cs-${key}" ${item.value ? 'checked' : ''} 
                                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" 
                                               onchange="App.toggleCostSplitting(this.checked)">
                                        <span class="ml-2 text-sm font-medium text-gray-700">${item.label}</span>
                                    </label>
                                    <p class="text-xs text-gray-500 mt-1">Split costs per unit/weight/volume for multi-item shipments</p>
                                </div>`;
                            } else if (key === 'method') {
                                return `<div ${!state.costSplitting.enabled.value ? 'style="display: none;"' : ''} id="cs-${key}-container">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <select id="cs-${key}" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" onchange="App.updateCostSplitting()">
                                        <option value="weight" ${item.value === 'weight' ? 'selected' : ''}>By Weight (per Kg)</option>
                                        <option value="volume" ${item.value === 'volume' ? 'selected' : ''}>By Volume (per CBM)</option>
                                        <option value="units" ${item.value === 'units' ? 'selected' : ''}>By Units (equal split)</option>
                                    </select>
                                </div>`;
                            } else {
                                const isConditional = !state.costSplitting.enabled.value || 
                                                    (key === 'totalVolume' && state.costSplitting.method.value !== 'volume') ||
                                                    (key === 'itemUnits' && state.costSplitting.method.value !== 'units');
                                                    
                                return `<div ${isConditional ? 'style="display: none;"' : ''} id="cs-${key}-container">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${item.label}</label>
                                    <input type="number" step="0.01" id="cs-${key}" value="${item.value}" 
                                           class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" 
                                           oninput="App.updateCostSplitting()" placeholder="Enter ${item.label.toLowerCase()}">
                                </div>`;
                            }
                        }).join('');
                        
                        costSplittingContainer.innerHTML = splittingFields;
                        console.log('✅ Cost splitting inputs generated');
                    }
                } catch (error) {
                    console.error('Error in generateInputs:', error);
                    showToast('Error generating form inputs', 'error');
                }
            },
            listenForQuotes() { 
                if (!this.quotesCollection) return; 
                const listContainer = document.getElementById('saved-quotes-list'); 
                onSnapshot(query(this.quotesCollection), (snapshot) => { 
                    if (snapshot.empty) { 
                        listContainer.innerHTML = '<p class="text-gray-500">No quotes saved yet.</p>'; 
                        return; 
                    } 
                    const quotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); 
                    listContainer.innerHTML = quotes.map(quote => 
                        `<div class="quote-card flex items-center justify-between p-4">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800">📦 ${quote.details.supplierName || 'No Supplier'}</p>
                                <p class="text-sm text-gray-500">Quote #${quote.quoteNumber} • ${new Date(quote.createdAt).toLocaleDateString('en-GB')} <span class="text-green-500 font-medium">(Shared)</span></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="App.loadQuote('${quote.id}')" class="btn bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                                    📂 Load
                                </button>
                                <button onclick="App.deleteQuote('${quote.id}')" class="btn bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 transition-colors" title="Delete Quote">
                                    🗑️
                                </button>
                            </div>
                        </div>`
                    ).join(''); 
                }); 
            },
            listenForCostRequests() { 
                if(!this.requestsCollection) return; 
                const listContainer = document.getElementById('cost-requests-list'); 
                onSnapshot(query(this.requestsCollection), (snapshot) => { 
                    if (snapshot.empty) { 
                        listContainer.innerHTML = '<p class="text-gray-500">No pending requests.</p>'; 
                        return; 
                    } 
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); 
                    listContainer.innerHTML = requests.map(req => 
                        `<div class="request-card p-4"> 
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">🏢 ${req.clientName}</p> 
                                    <p class="text-sm text-gray-600">📤 Request from ${req.requesterName} on ${req.createdAt ? new Date(req.createdAt.seconds * 1000).toLocaleDateString('en-GB') : 'N/A'}</p> 
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 text-sm">
                                        <p><b>🌍 From:</b> ${req.origin}</p>
                                        <p><b>🎯 To:</b> ${req.destination}</p>
                                        ${req.totalWeight ? `<p><b>⚖️ Weight:</b> ${req.totalWeight} kg</p>` : ''}
                                        ${req.incoterm ? `<p><b>📋 Incoterm:</b> ${req.incoterm}</p>` : ''}
                                        ${req.totalCost ? `<p><b>💰 Cost:</b> ${req.totalCost} ${req.currency || ''}</p>` : ''}
                                    </div>
                                    <p class="text-sm mt-2"><b>📦 Commodity:</b> ${req.commodity}</p> 
                                    ${req.notes ? `<p class="text-sm mt-2 italic text-gray-600"><b>📝 Notes:</b> ${req.notes}</p>` : ''}
                                </div>
                                <div class="flex items-center gap-2 ml-4">
                                    <button onclick="App.generateCostFromRequest('${req.id}')" class="btn bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                                        🚀 Generate Cost
                                    </button>
                                    <button onclick="App.deleteCostRequest('${req.id}')" class="btn bg-red-600 text-white px-3 py-2 rounded-md hover:bg-red-700 transition-colors" title="Delete Request">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>`
                    ).join(''); 
                }); 
            },
            
            async deleteQuote(quoteId) {
                if (!this.db) {
                    showToast('Database not available', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(this.db, "quotes", quoteId));
                    showToast('Quote deleted successfully! 🗑️', 'success');
                } catch (error) {
                    console.error("Error deleting quote: ", error);
                    showToast("Failed to delete quote. Please try again.", 'error');
                }
            },
            
            async deleteCostRequest(requestId) {
                if (!this.db) {
                    showToast('Database not available', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(this.db, "cost_requests", requestId));
                    showToast('Request deleted successfully! 🗑️', 'success');
                } catch (error) {
                    console.error("Error deleting request: ", error);
                    showToast("Failed to delete request. Please try again.", 'error');
                }
            },
            
            deleteLocalQuote(quoteId) {
                if (!confirm('Are you sure you want to delete this local quote? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const quotes = JSON.parse(localStorage.getItem('synerore_quotes') || '[]');
                    const filteredQuotes = quotes.filter(q => q.id !== quoteId);
                    localStorage.setItem('synerore_quotes', JSON.stringify(filteredQuotes));
                    this.loadLocalQuotes();
                    showToast('Local quote deleted successfully! 🗑️', 'success');
                } catch (error) {
                    console.error('Error deleting local quote:', error);
                    showToast('Failed to delete local quote.', 'error');
                }
            },
            
            async generateCostFromRequest(requestId) {
                if (!this.db) {
                    alert('Database not available');
                    return;
                }
                
                try {
                    console.log('Loading cost request with ID:', requestId);
                    const requestDoc = await getDoc(doc(this.db, "cost_requests", requestId));
                    
                    if (requestDoc.exists()) {
                        const requestData = requestDoc.data();
                        console.log('Request data loaded:', requestData);
                        
                        // Pre-populate form with request data
                        const supplierEl = document.getElementById('sd-supplierName');
                        const polEl = document.getElementById('sd-pol');
                        const podEl = document.getElementById('sd-pod');
                        const commodityEl = document.getElementById('sd-commodity');
                        const incotermEl = document.getElementById('sd-incoterm');
                        const totalKgEl = document.getElementById('lc-totalKg');
                        const commercialValueEl = document.getElementById('lc-commercialInvoiceValue');
                        
                        if (supplierEl) supplierEl.value = requestData.clientName || '';
                        if (polEl) polEl.value = requestData.origin || '';
                        if (podEl) podEl.value = requestData.destination || '';
                        if (commodityEl) commodityEl.value = requestData.commodity || '';
                        if (incotermEl && requestData.incoterm) incotermEl.value = requestData.incoterm;
                        if (totalKgEl && requestData.totalWeight) totalKgEl.value = requestData.totalWeight;
                        if (commercialValueEl && requestData.totalCost) commercialValueEl.value = requestData.totalCost;
                        
                        // Switch to cost generator page
                        this.switchPage('cost-generator-page');
                        this.updateDisplay();
                        
                        showToast(`Cost generation started for ${requestData.clientName} 🚀`, 'success');
                        
                    } else {
                        alert("Request not found.");
                    }
                } catch (error) {
                    console.error("Error loading cost request: ", error);
                    alert("Error loading request: " + error.message);
                }
            },
            
            async submitCostRequest(e) { 
                e.preventDefault(); 
                if(!this.requestsCollection) return; 
                const button = e.target.querySelector('button[type="submit"]'); 
                button.disabled = true; 
                button.textContent = 'Submitting...'; 
                try { 
                    await addDoc(this.requestsCollection, { 
                        requesterName: document.getElementById('req-name').value, 
                        requesterEmail: document.getElementById('req-email').value, 
                        clientName: document.getElementById('req-client').value, 
                        origin: document.getElementById('req-origin').value, 
                        destination: document.getElementById('req-destination').value, 
                        commodity: document.getElementById('req-commodity').value, 
                        notes: document.getElementById('req-notes').value,
                        totalWeight: document.getElementById('req-weight').value,
                        incoterm: document.getElementById('req-incoterm').value,
                        totalCost: document.getElementById('req-cost').value,
                        currency: document.getElementById('req-currency').value,
                        status: 'pending', 
                        createdAt: serverTimestamp() 
                    }); 
                    showToast('Request submitted successfully! 📋 It will appear in Pending Quotes.', 'success'); 
                    e.target.reset(); 
                } catch (error) { 
                    console.error("Error submitting request: ", error); 
                    alert("Error submitting request: " + error.message);
                } finally { 
                    button.disabled = false; 
                    button.textContent = 'Submit Request'; 
                } 
            },
        };

        // --- INITIALIZATION ---
        window.App = App; // Make App globally accessible
        window.AuthSystem = AuthSystem; // Make AuthSystem globally accessible
        
        // Safe initialization with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Verify required DOM elements exist
                const requiredElements = [
                    'dashboard-page',
                    'cost-generator-page', 
                    'cost-request-page',
                    'tracking-page',
                    'schedules-page',
                    'shipment-details',
                    'origin-charges-section',
                    'exchange-rates',
                    'cost-sections'
                ];
                
                const missingElements = requiredElements.filter(id => !document.getElementById(id));
                
                if (missingElements.length > 0) {
                    console.error('Missing required DOM elements:', missingElements);
                    document.body.innerHTML = `
                        <div style="padding: 20px; font-family: Arial; color: red;">
                            <h2>Loading Error</h2>
                            <p>Missing DOM elements: ${missingElements.join(', ')}</p>
                            <p>Please refresh the page or contact support.</p>
                        </div>
                    `;
                    return;
                }
                
                // Validate state object
                if (!state || !state.shipmentDetails || !state.originCharges || !state.costs) {
                    console.error('State object not properly initialized:', state);
                    document.body.innerHTML = `
                        <div style="padding: 20px; font-family: Arial; color: red;">
                            <h2>Configuration Error</h2>
                            <p>Application state not properly initialized.</p>
                            <p>Please refresh the page.</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ All required elements found, initializing app...');
                
                // Debug navigation system
                console.log('Debug: Pages found:', document.querySelectorAll('.page').length);
                console.log('Debug: Sidebar nav found:', document.getElementById('sidebar-nav'));
                
                // Initialize authentication first
                AuthSystem.init();
                
                App.init();
                
                // Force show the cost generator page if hash is present
                const currentHash = window.location.hash;
                if (currentHash === '#generator') {
                    console.log('Debug: Forcing cost generator page to show');
                    App.switchPage('cost-generator-page');
                } else if (currentHash === '#request') {
                    console.log('Debug: Forcing cost request page to show');
                    App.switchPage('cost-request-page');
                } else if (currentHash === '#dashboard') {
                    console.log('Debug: Forcing dashboard page to show');
                    App.switchPage('dashboard-page');
                }
                
            } catch (error) {
                console.error('❌ App initialization failed:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; font-family: Arial; color: red;">
                        <h2>Initialization Error</h2>
                        <p>Error: ${error.message}</p>
                        <p>Please refresh the page or check the browser console for details.</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 10px; background: #007cba; color: white; border: none; cursor: pointer;">
                            🔄 Refresh Page
                        </button>
                    </div>
                `;
            }
        });

        // --- SUPPLY CHAIN CHAT SYSTEM ---
        const SupplyChainChat = {
            messages: [],
            
            init() {
                console.log('🤖 Initializing Supply Chain Chat...');
                this.initChatHandlers();
            },
            
            initChatHandlers() {
                const chatInput = document.getElementById('chat-input');
                const chatSend = document.getElementById('chat-send');
                
                const sendMessage = () => {
                    const message = chatInput.value.trim();
                    if (!message) return;
                    
                    this.addMessage(message, 'user');
                    chatInput.value = '';
                    this.processMessage(message);
                };
                
                if (chatSend) chatSend.addEventListener('click', sendMessage);
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendMessage();
                    });
                }
                
                console.log('✅ Chat handlers initialized');
            },
            
            addMessage(text, sender) {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;
                
                // Clear welcome message if this is the first real message
                if (this.messages.length === 0) {
                    messagesContainer.innerHTML = '';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-[80%] p-3 rounded-lg ${
                    sender === 'user' 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-white text-gray-800 border'
                }`;
                
                const messageText = document.createElement('p');
                messageText.className = 'text-sm';
                messageText.textContent = text;
                
                const timestamp = document.createElement('p');
                timestamp.className = 'text-xs opacity-70 mt-1';
                timestamp.textContent = new Date().toLocaleTimeString();
                
                messageBubble.appendChild(messageText);
                messageBubble.appendChild(timestamp);
                messageDiv.appendChild(messageBubble);
                messagesContainer.appendChild(messageDiv);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                this.messages.push({ text, sender, timestamp: new Date() });
            },
            
            async processMessage(message) {
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white border p-3 rounded-lg">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                document.getElementById('chat-messages').appendChild(loadingDiv);
                
                try {
                    // Use fallback responses for supply chain topics
                    const response = this.getFallbackResponse(message);
                    
                    // Remove loading indicator
                    setTimeout(() => {
                        loadingDiv.remove();
                        this.addMessage(response, 'avatar');
                    }, 800 + Math.random() * 1200); // Simulate thinking time
                    
                } catch (error) {
                    console.error('Error processing message:', error);
                    loadingDiv.remove();
                    this.addMessage('Sorry, I encountered an error processing your request.', 'avatar');
                }
            },
            
            getFallbackResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Comprehensive Incoterms knowledge
                if (lowerMessage.includes('incoterm') || lowerMessage.includes('fob') || lowerMessage.includes('cif') || lowerMessage.includes('ddp') || lowerMessage.includes('exw')) {
                    if (lowerMessage.includes('fob')) {
                        return 'FOB (Free on Board): Seller delivers goods on board the vessel. Risk transfers to buyer when goods cross ship\'s rail. Seller pays export costs, buyer pays freight and import costs. Common for bulk commodities.';
                    } else if (lowerMessage.includes('cif')) {
                        return 'CIF (Cost, Insurance, Freight): Seller pays for goods, insurance, and freight to destination port. Risk transfers at ship\'s rail at origin. Popular for developing countries as seller arranges shipping.';
                    } else if (lowerMessage.includes('ddp')) {
                        return 'DDP (Delivered Duty Paid): Seller takes maximum responsibility, delivering goods cleared for import to buyer\'s premises. Seller pays all costs including duties and taxes.';
                    } else if (lowerMessage.includes('exw')) {
                        return 'EXW (Ex Works): Minimum seller obligation. Buyer collects goods at seller\'s premises and handles all transport, insurance, and customs. Risk transfers immediately.';
                    }
                    return 'Incoterms 2020: EXW (Ex Works), FOB (Free on Board), CFR (Cost & Freight), CIF (Cost Insurance Freight), DAP (Delivered at Place), DDP (Delivered Duty Paid). Each defines risk transfer points and cost responsibilities.';
                }
                
                // Container specifications and shipping
                if (lowerMessage.includes('container') || lowerMessage.includes('fcl') || lowerMessage.includes('lcl') || lowerMessage.includes('20ft') || lowerMessage.includes('40ft')) {
                    if (lowerMessage.includes('20ft') || lowerMessage.includes('20')) {
                        return '20ft GP Container: 5.9m x 2.35m x 2.39m, Max payload 28,230kg, Volume 33.2 CBM. Ideal for heavy/dense cargo like chemicals, metals. Cost-effective for smaller shipments.';
                    } else if (lowerMessage.includes('40ft') || lowerMessage.includes('40')) {
                        return '40ft HC Container: 12.03m x 2.35m x 2.69m, Max payload 26,580kg, Volume 76.3 CBM. Most popular size, good for voluminous cargo. HC (High Cube) gives extra 30cm height.';
                    } else if (lowerMessage.includes('lcl')) {
                        return 'LCL (Less than Container Load): Shared container space for smaller shipments. Charged per CBM or weight. Consolidation at origin, deconsolidation at destination. Longer transit but lower cost.';
                    }
                    return 'Standard containers: 20ft GP (33 CBM), 40ft GP (67 CBM), 40ft HC (76 CBM). Special: Open Top, Flat Rack, Refrigerated. FCL = Full Container, LCL = Shared container space.';
                }
                
                // Customs and documentation
                if (lowerMessage.includes('customs') || lowerMessage.includes('duty') || lowerMessage.includes('clearance') || lowerMessage.includes('documentation')) {
                    if (lowerMessage.includes('documentation') || lowerMessage.includes('documents')) {
                        return 'Essential shipping documents: Commercial Invoice, Packing List, Bill of Lading, Certificate of Origin, Insurance Certificate. Additional: Health certificates, inspection certificates, import permits.';
                    } else if (lowerMessage.includes('duty') || lowerMessage.includes('tariff')) {
                        return 'Customs duties based on HS Code classification and country of origin. Rates vary by trade agreements (EU, SADC, etc.). Calculate: CIF value × duty rate. Also consider VAT, excise duties.';
                    }
                    return 'Customs clearance requires proper documentation, HS code classification, and duty payment. Process: Document submission → Examination (if selected) → Payment → Release. Timeline: 1-3 days typically.';
                }
                
                // Shipping lines and logistics
                if (lowerMessage.includes('shipping') || lowerMessage.includes('freight') || lowerMessage.includes('carrier') || lowerMessage.includes('maersk') || lowerMessage.includes('msc')) {
                    if (lowerMessage.includes('maersk')) {
                        return 'Maersk: World\'s largest container shipping company. Strong Asia-Europe routes, excellent tracking systems, reliable schedules. Premium pricing but high service quality. Good for time-sensitive cargo.';
                    } else if (lowerMessage.includes('msc')) {
                        return 'MSC (Mediterranean Shipping Company): 2nd largest carrier globally. Competitive rates, extensive global network. Strong Africa-Europe routes. Good value for money, slightly longer transit times.';
                    } else if (lowerMessage.includes('rates') || lowerMessage.includes('cost')) {
                        return 'Freight rates vary by: Route, season, fuel costs, equipment availability. Peak season (Sep-Nov) rates 20-40% higher. Book early for better rates. Consider all-in rates vs. base+surcharges.';
                    }
                    return 'Major carriers: Maersk (premium service), MSC (good value), CMA CGM (France-Africa strong), COSCO (Asia focus), Hapag-Lloyd (reliable). Choose based on route, service, and budget.';
                }
                
                // South African specific
                if (lowerMessage.includes('south africa') || lowerMessage.includes('durban') || lowerMessage.includes('cape town') || lowerMessage.includes('sars')) {
                    return 'South Africa ports: Durban (largest, best connectivity), Cape Town (automotive/fruit), Port Elizabeth/Gqeberha (automotive). SARS customs, SADC preferential rates available.';
                }
                
                // HS Codes and classification
                if (lowerMessage.includes('hs code') || lowerMessage.includes('classification') || lowerMessage.includes('tariff')) {
                    return 'HS Codes: 6-digit global standard, extended to 8-10 digits nationally. First 2 digits = Chapter, next 2 = Heading, last 2 = Subheading. Determines duty rates, restrictions, permits required.';
                }
                
                // General supply chain
                if (lowerMessage.includes('supply chain') || lowerMessage.includes('logistics')) {
                    return 'Supply chain optimization: Plan demand, source strategically, optimize inventory, choose right transport mode. Key KPIs: On-time delivery, cost per unit, inventory turnover, order accuracy.';
                }
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                    return 'Hello! I\'m your expert supply chain avatar with deep knowledge of international trade, shipping, customs procedures, and logistics. I can help with Incoterms, container specifications, freight rates, customs clearance, documentation, and trade compliance. What would you like to know?';
                }
                
                return 'I\'m your supply chain expert! Ask me about: Incoterms (FOB, CIF, DDP), container types (20ft/40ft, FCL/LCL), shipping lines (Maersk, MSC, CMA CGM), customs procedures, HS codes, freight rates, documentation requirements, or trade regulations. What specific topic interests you?';
            }
        };

        // --- 3D AVATAR FUNCTIONALITY ---
        const Avatar3D = {
            scene: null,
            camera: null,
            renderer: null,
            avatar: null,
            animationId: null,
            isListening: false,
            isSpeaking: false,
            messages: [],
            
            init() {
                console.log('🤖 Initializing 3D Avatar...');
                this.initScene();
                this.initAvatar();
                this.initChatHandlers();
                this.animate();
            },
            
            initScene() {
                const container = document.getElementById('avatar-3d-container');
                if (!container) {
                    console.error('Avatar container not found!');
                    return;
                }
                
                // Scene setup
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x1a1a1a);
                
                // Camera setup
                this.camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                this.camera.position.set(0, 2, 5);
                
                // Renderer setup
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(this.renderer.domElement);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                const pointLight = new THREE.PointLight(0x4fc3f7, 0.5, 100);
                pointLight.position.set(0, 5, 2);
                this.scene.add(pointLight);
                
                // Room
                this.createRoom();
                
                // Handle window resize
                window.addEventListener('resize', () => this.onWindowResize());
            },
            
            createRoom() {
                const roomSize = 10;
                const wallHeight = 4;
                
                // Floor
                const floorGeometry = new THREE.PlaneGeometry(roomSize, roomSize);
                const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.position.y = -2;
                floor.receiveShadow = true;
                this.scene.add(floor);
                
                // Walls
                const wallGeometry = new THREE.PlaneGeometry(roomSize, wallHeight);
                const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xe6e6fa });
                
                // Back wall
                const backWall = new THREE.Mesh(wallGeometry, wallMaterial);
                backWall.position.set(0, 0, -roomSize/2);
                this.scene.add(backWall);
                
                // Left wall
                const leftWall = new THREE.Mesh(wallGeometry, wallMaterial);
                leftWall.rotation.y = Math.PI / 2;
                leftWall.position.set(-roomSize/2, 0, 0);
                this.scene.add(leftWall);
                
                // Right wall
                const rightWall = new THREE.Mesh(wallGeometry, wallMaterial);
                rightWall.rotation.y = -Math.PI / 2;
                rightWall.position.set(roomSize/2, 0, 0);
                this.scene.add(rightWall);
                
                // Ceiling
                const ceiling = new THREE.Mesh(floorGeometry, new THREE.MeshLambertMaterial({ color: 0xf0f0f0 }));
                ceiling.rotation.x = Math.PI / 2;
                ceiling.position.y = 2;
                this.scene.add(ceiling);
            },
            
            initAvatar() {
                this.avatar = new THREE.Group();
                
                // Avatar body
                const bodyGeometry = new THREE.BoxGeometry(1, 2, 0.5);
                const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x2196f3 });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.y = 0;
                body.castShadow = true;
                this.avatar.add(body);
                
                // Avatar head
                const headGeometry = new THREE.SphereGeometry(0.4, 32, 32);
                const headMaterial = new THREE.MeshPhongMaterial({ color: 0xff9800 });
                const head = new THREE.Mesh(headGeometry, headMaterial);
                head.position.y = 1.2;
                head.castShadow = true;
                this.avatar.add(head);
                
                // Status indicator
                const indicatorGeometry = new THREE.SphereGeometry(0.1, 16, 16);
                const indicatorMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x4caf50, 
                    emissive: 0x002200 
                });
                this.statusIndicator = new THREE.Mesh(indicatorGeometry, indicatorMaterial);
                this.statusIndicator.position.set(0, 2.5, 0);
                this.statusIndicator.visible = false;
                this.avatar.add(this.statusIndicator);
                
                this.avatar.position.set(0, -1, 0);
                this.scene.add(this.avatar);
                
                // Store references for animation
                this.avatarBody = body;
                this.avatarHead = head;
            },
            
            initChatHandlers() {
                const chatInput = document.getElementById('chat-input');
                const chatSend = document.getElementById('chat-send');
                
                const sendMessage = () => {
                    const message = chatInput.value.trim();
                    if (!message) return;
                    
                    this.addMessage(message, 'user');
                    chatInput.value = '';
                    this.processMessage(message);
                };
                
                if (chatSend) chatSend.addEventListener('click', sendMessage);
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendMessage();
                    });
                }
            },
            
            addMessage(text, sender) {
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) return;
                
                // Clear welcome message if this is the first real message
                if (this.messages.length === 0) {
                    messagesContainer.innerHTML = '';
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-[80%] p-3 rounded-lg ${
                    sender === 'user' 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-white text-gray-800 border'
                }`;
                
                const messageText = document.createElement('p');
                messageText.className = 'text-sm';
                messageText.textContent = text;
                
                const timestamp = document.createElement('p');
                timestamp.className = 'text-xs opacity-70 mt-1';
                timestamp.textContent = new Date().toLocaleTimeString();
                
                messageBubble.appendChild(messageText);
                messageBubble.appendChild(timestamp);
                messageDiv.appendChild(messageBubble);
                messagesContainer.appendChild(messageDiv);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                this.messages.push({ text, sender, timestamp: new Date() });
            },
            
            async processMessage(message) {
                this.setListening(false);
                this.setSpeaking(true);
                
                // Show loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white border p-3 rounded-lg">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                `;
                document.getElementById('chat-messages').appendChild(loadingDiv);
                
                try {
                    let response = '';
                    
                    // Check if OpenAI API key is available
                    if (window.OPENAI_API_KEY) {
                        console.log('🚀 Using OpenAI API for response');
                        response = await this.callOpenAI(message);
                    } else {
                        console.log('⚠️ No API key found, using fallback responses');
                        // Fallback responses for supply chain topics
                        response = this.getFallbackResponse(message);
                    }
                    
                    // Remove loading indicator
                    loadingDiv.remove();
                    
                    // Add response
                    this.addMessage(response, 'avatar');
                    
                } catch (error) {
                    console.error('Error processing message:', error);
                    loadingDiv.remove();
                    this.addMessage('Sorry, I encountered an error processing your request.', 'avatar');
                } finally {
                    this.setSpeaking(false);
                }
            },
            
            async callOpenAI(message) {
                console.log('🔑 OpenAI API Key available:', !!window.OPENAI_API_KEY);
                console.log('📤 Sending message to OpenAI:', message);
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${window.OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a supply chain expert avatar. You have comprehensive knowledge about:
                                - Import/Export requirements for all countries
                                - Incoterms (International Commercial Terms)
                                - Container specifications and logistics
                                - Best shipping agents and freight forwarders
                                - Customs procedures and documentation
                                - Trade regulations and compliance
                                - Supply chain optimization
                                - Cost analysis and pricing strategies
                                
                                Respond in a helpful, professional manner. Keep responses concise but informative.`
                            },
                            ...this.messages.map(msg => ({
                                role: msg.sender === 'user' ? 'user' : 'assistant',
                                content: msg.text
                            })),
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                console.log('📥 OpenAI Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ OpenAI API Error:', errorText);
                    throw new Error(`OpenAI API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log('✅ OpenAI Response data:', data);
                return data.choices[0]?.message?.content || 'Sorry, I could not process your request.';
            },
            
            getFallbackResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Comprehensive Incoterms knowledge
                if (lowerMessage.includes('incoterm') || lowerMessage.includes('fob') || lowerMessage.includes('cif') || lowerMessage.includes('ddp') || lowerMessage.includes('exw')) {
                    if (lowerMessage.includes('fob')) {
                        return 'FOB (Free on Board): Seller delivers goods on board the vessel. Risk transfers to buyer when goods cross ship\'s rail. Seller pays export costs, buyer pays freight and import costs. Common for bulk commodities.';
                    } else if (lowerMessage.includes('cif')) {
                        return 'CIF (Cost, Insurance, Freight): Seller pays for goods, insurance, and freight to destination port. Risk transfers at ship\'s rail at origin. Popular for developing countries as seller arranges shipping.';
                    } else if (lowerMessage.includes('ddp')) {
                        return 'DDP (Delivered Duty Paid): Seller takes maximum responsibility, delivering goods cleared for import to buyer\'s premises. Seller pays all costs including duties and taxes.';
                    } else if (lowerMessage.includes('exw')) {
                        return 'EXW (Ex Works): Minimum seller obligation. Buyer collects goods at seller\'s premises and handles all transport, insurance, and customs. Risk transfers immediately.';
                    }
                    return 'Incoterms 2020: EXW (Ex Works), FOB (Free on Board), CFR (Cost & Freight), CIF (Cost Insurance Freight), DAP (Delivered at Place), DDP (Delivered Duty Paid). Each defines risk transfer points and cost responsibilities.';
                }
                
                // Container specifications and shipping
                if (lowerMessage.includes('container') || lowerMessage.includes('fcl') || lowerMessage.includes('lcl') || lowerMessage.includes('20ft') || lowerMessage.includes('40ft')) {
                    if (lowerMessage.includes('20ft') || lowerMessage.includes('20')) {
                        return '20ft GP Container: 5.9m x 2.35m x 2.39m, Max payload 28,230kg, Volume 33.2 CBM. Ideal for heavy/dense cargo like chemicals, metals. Cost-effective for smaller shipments.';
                    } else if (lowerMessage.includes('40ft') || lowerMessage.includes('40')) {
                        return '40ft HC Container: 12.03m x 2.35m x 2.69m, Max payload 26,580kg, Volume 76.3 CBM. Most popular size, good for voluminous cargo. HC (High Cube) gives extra 30cm height.';
                    } else if (lowerMessage.includes('lcl')) {
                        return 'LCL (Less than Container Load): Shared container space for smaller shipments. Charged per CBM or weight. Consolidation at origin, deconsolidation at destination. Longer transit but lower cost.';
                    }
                    return 'Standard containers: 20ft GP (33 CBM), 40ft GP (67 CBM), 40ft HC (76 CBM). Special: Open Top, Flat Rack, Refrigerated. FCL = Full Container, LCL = Shared container space.';
                }
                
                // Customs and documentation
                if (lowerMessage.includes('customs') || lowerMessage.includes('duty') || lowerMessage.includes('clearance') || lowerMessage.includes('documentation')) {
                    if (lowerMessage.includes('documentation') || lowerMessage.includes('documents')) {
                        return 'Essential shipping documents: Commercial Invoice, Packing List, Bill of Lading, Certificate of Origin, Insurance Certificate. Additional: Health certificates, inspection certificates, import permits.';
                    } else if (lowerMessage.includes('duty') || lowerMessage.includes('tariff')) {
                        return 'Customs duties based on HS Code classification and country of origin. Rates vary by trade agreements (EU, SADC, etc.). Calculate: CIF value × duty rate. Also consider VAT, excise duties.';
                    }
                    return 'Customs clearance requires proper documentation, HS code classification, and duty payment. Process: Document submission → Examination (if selected) → Payment → Release. Timeline: 1-3 days typically.';
                }
                
                // Shipping lines and logistics
                if (lowerMessage.includes('shipping') || lowerMessage.includes('freight') || lowerMessage.includes('carrier') || lowerMessage.includes('maersk') || lowerMessage.includes('msc')) {
                    if (lowerMessage.includes('maersk')) {
                        return 'Maersk: World\'s largest container shipping company. Strong Asia-Europe routes, excellent tracking systems, reliable schedules. Premium pricing but high service quality. Good for time-sensitive cargo.';
                    } else if (lowerMessage.includes('msc')) {
                        return 'MSC (Mediterranean Shipping Company): 2nd largest carrier globally. Competitive rates, extensive global network. Strong Africa-Europe routes. Good value for money, slightly longer transit times.';
                    } else if (lowerMessage.includes('rates') || lowerMessage.includes('cost')) {
                        return 'Freight rates vary by: Route, season, fuel costs, equipment availability. Peak season (Sep-Nov) rates 20-40% higher. Book early for better rates. Consider all-in rates vs. base+surcharges.';
                    }
                    return 'Major carriers: Maersk (premium service), MSC (good value), CMA CGM (France-Africa strong), COSCO (Asia focus), Hapag-Lloyd (reliable). Choose based on route, service, and budget.';
                }
                
                // South African specific
                if (lowerMessage.includes('south africa') || lowerMessage.includes('durban') || lowerMessage.includes('cape town') || lowerMessage.includes('sars')) {
                    return 'South Africa ports: Durban (largest, best connectivity), Cape Town (automotive/fruit), Port Elizabeth/Gqeberha (automotive). SARS customs, SADC preferential rates available.';
                }
                
                // HS Codes and classification
                if (lowerMessage.includes('hs code') || lowerMessage.includes('classification') || lowerMessage.includes('tariff')) {
                    return 'HS Codes: 6-digit global standard, extended to 8-10 digits nationally. First 2 digits = Chapter, next 2 = Heading, last 2 = Subheading. Determines duty rates, restrictions, permits required.';
                }
                
                // General supply chain
                if (lowerMessage.includes('supply chain') || lowerMessage.includes('logistics')) {
                    return 'Supply chain optimization: Plan demand, source strategically, optimize inventory, choose right transport mode. Key KPIs: On-time delivery, cost per unit, inventory turnover, order accuracy.';
                }
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                    return 'Hello! I\'m your expert supply chain avatar with deep knowledge of international trade, shipping, customs procedures, and logistics. I can help with Incoterms, container specifications, freight rates, customs clearance, documentation, and trade compliance. What would you like to know?';
                }
                
                return 'I\'m your supply chain expert! Ask me about: Incoterms (FOB, CIF, DDP), container types (20ft/40ft, FCL/LCL), shipping lines (Maersk, MSC, CMA CGM), customs procedures, HS codes, freight rates, documentation requirements, or trade regulations. What specific topic interests you?';
            },
            
            setListening(listening) {
                this.isListening = listening;
                if (this.statusIndicator) {
                    this.statusIndicator.visible = listening;
                }
            },
            
            setSpeaking(speaking) {
                this.isSpeaking = speaking;
            },
            
            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                if (this.avatar) {
                    // Gentle swaying animation
                    this.avatar.rotation.y = Math.sin(Date.now() * 0.001) * 0.1;
                    
                    // Speaking animation
                    if (this.isSpeaking && this.avatarBody) {
                        const scale = 1 + Math.sin(Date.now() * 0.01) * 0.02;
                        this.avatarBody.scale.setScalar(scale);
                        this.avatarHead.material.emissive.setHex(0x332200);
                    } else if (this.avatarBody) {
                        this.avatarBody.scale.setScalar(1);
                        this.avatarHead.material.emissive.setHex(0x000000);
                    }
                    
                    // Listening glow
                    if (this.isListening && this.avatarBody) {
                        this.avatarBody.material.emissive.setHex(0x001122);
                    } else if (this.avatarBody) {
                        this.avatarBody.material.emissive.setHex(0x000000);
                    }
                }
                
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            },
            
            onWindowResize() {
                const container = document.getElementById('avatar-3d-container');
                if (!container || !this.camera || !this.renderer) return;
                
                this.camera.aspect = container.clientWidth / container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(container.clientWidth, container.clientHeight);
            },
            
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                if (this.renderer) {
                    this.renderer.dispose();
                }
            }
        };

    </script>
</body>
</html>
