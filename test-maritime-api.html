<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maritime API Test</title>
    <script src="env.js"></script>
</head>
<body>
    <h1>Maritime API Integration Test</h1>
    <div id="test-results"></div>
    
    <script>
        // Copy the MaritimeDataProvider class from the main app for testing
        class MaritimeDataProvider {
            constructor() {
                this.providers = [
                    {
                        name: 'AISHub',
                        type: 'free',
                        baseUrl: 'https://data.aishub.net/ws.php',
                        apiKey: () => window.ENV?.AISHUB_USERNAME || 'YOUR_AISHUB_USERNAME',
                        rateLimit: 1000,
                        priority: 1
                    },
                    {
                        name: 'Datalastic',
                        type: 'paid',
                        baseUrl: 'https://api.datalastic.com/api/v0',
                        apiKey: () => window.ENV?.DATALASTIC_API_KEY || 'YOUR_DATALASTIC_API_KEY',
                        rateLimit: 10000,
                        priority: 2
                    },
                    {
                        name: 'SeaRates',
                        type: 'freemium',
                        baseUrl: 'https://api.searates.com/schedule/v1',
                        apiKey: () => window.ENV?.SEARATES_API_KEY || 'YOUR_SEARATES_API_KEY',
                        rateLimit: 5000,
                        priority: 3
                    }
                ];
                this.cache = new Map();
                this.cacheTimeout = 5 * 60 * 1000;
            }
            
            getProviderStatus() {
                return this.providers.map(provider => ({
                    name: provider.name,
                    type: provider.type,
                    configured: !provider.apiKey().includes('YOUR_'),
                    priority: provider.priority,
                    rateLimit: provider.rateLimit
                }));
            }

            getEnhancedMockUpdates() {
                const now = new Date();
                const updates = [];
                
                const updateTemplates = [
                    { type: 'departure', message: 'MSC AMSTERDAM departed Shanghai on schedule' },
                    { type: 'delay', message: 'MAERSK CAPE TOWN delayed 4 hours at Hamburg due to weather' },
                    { type: 'arrival', message: 'COSCO SINGAPORE arrived Singapore 2 hours ahead of schedule' },
                    { type: 'new', message: 'New weekly service: CMA CGM FAL3 Shanghai-Cape Town' },
                    { type: 'cutoff', message: 'Cut-off extended for HAPAG EXPRESS to tomorrow 18:00' },
                    { type: 'weather', message: 'Storm warning issued for vessels crossing Bay of Bengal' },
                    { type: 'port', message: 'Port of Durban experiencing minor congestion, 6-hour delays expected' },
                    { type: 'schedule', message: 'MSC MEDITERRANEAN updated departure time to 16:00 UTC' }
                ];
                
                updateTemplates.forEach((template, index) => {
                    const minutesAgo = Math.floor(Math.random() * 180) + (index * 15);
                    const timestamp = new Date(now.getTime() - minutesAgo * 60 * 1000);
                    
                    updates.push({
                        time: this.formatTimeAgo(timestamp),
                        message: template.message,
                        type: template.type,
                        timestamp: timestamp.toISOString(),
                        source: 'Live Data'
                    });
                });
                
                return updates.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }

            formatTimeAgo(timestamp) {
                const now = new Date();
                const diffMinutes = Math.floor((now - timestamp) / (1000 * 60));
                
                if (diffMinutes < 1) return 'Just now';
                if (diffMinutes < 60) return `${diffMinutes} min${diffMinutes === 1 ? '' : 's'} ago`;
                
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                
                const diffDays = Math.floor(diffHours / 24);
                return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            }

            async getLiveUpdates() {
                // For testing, always return enhanced mock data
                return this.getEnhancedMockUpdates();
            }
        }

        // Test the maritime data provider
        async function testMaritimeAPI() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>Testing Maritime API Integration...</h2>';
            
            const provider = new MaritimeDataProvider();
            
            // Test 1: Provider Status
            resultsDiv.innerHTML += '<h3>1. Provider Status</h3>';
            const status = provider.getProviderStatus();
            status.forEach(p => {
                resultsDiv.innerHTML += `<p>• ${p.name} (${p.type}): ${p.configured ? '✅ Configured' : '❌ Not Configured'}</p>`;
            });
            
            // Test 2: Live Updates
            resultsDiv.innerHTML += '<h3>2. Live Updates Test</h3>';
            try {
                const updates = await provider.getLiveUpdates();
                resultsDiv.innerHTML += `<p>✅ Successfully retrieved ${updates.length} live updates</p>`;
                updates.slice(0, 3).forEach(update => {
                    resultsDiv.innerHTML += `<p><strong>${update.time}:</strong> ${update.message} (${update.type})</p>`;
                });
            } catch (error) {
                resultsDiv.innerHTML += `<p>❌ Error getting live updates: ${error.message}</p>`;
            }
            
            // Test 3: Environment Variables
            resultsDiv.innerHTML += '<h3>3. Environment Variables</h3>';
            resultsDiv.innerHTML += `<p>AISHUB_USERNAME: ${window.ENV?.AISHUB_USERNAME || 'Not set'}</p>`;
            resultsDiv.innerHTML += `<p>DATALASTIC_API_KEY: ${window.ENV?.DATALASTIC_API_KEY || 'Not set'}</p>`;
            resultsDiv.innerHTML += `<p>SEARATES_API_KEY: ${window.ENV?.SEARATES_API_KEY || 'Not set'}</p>`;
            
            resultsDiv.innerHTML += '<h3>✅ Maritime API Integration Test Complete!</h3>';
            resultsDiv.innerHTML += '<p>The maritime data provider is working correctly. Enhanced mock data is being generated with realistic timestamps.</p>';
            resultsDiv.innerHTML += '<p><strong>Next steps:</strong> Configure API keys in env.js to enable real maritime data providers.</p>';
        }

        // Run test when page loads
        window.addEventListener('load', testMaritimeAPI);
    </script>
</body>
</html>